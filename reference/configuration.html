<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Configuration and Environments - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Fri Mar  4 00:38:58 2022" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.9.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="moonscript">MoonScript</span>
          <span class="lang_toggle" data-lang="lua">Lua</span>
        </div>

        
          <div class="nav_links">
            <h2>Contents</h2>
            <ul><li><a href="#default-environment">Default Environment</a></li>
<ul><li><a href="#default-environment/overriding-the-default-environment">Overriding The Default Environment</a></li></ul>
<li><a href="#creating-configurations">Creating Configurations</a></li>
<li><a href="#built-in-configuration">Built-in Configuration</a></li>
<ul><li><a href="#built-in-configuration/logging-configuration">Logging configuration</a></li></ul>
<li><a href="#configurations-and-nginx">Configurations and Nginx</a></li>
<li><a href="#overriding-with-environment-variables">Overriding With Environment Variables</a></li>
<li><a href="#accessing-configuration-from-application">Accessing Configuration From Application</a></li>
<li><a href="#performance-measurement">Performance Measurement</a></li></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><h1>Configuration and Environments</h1>

<p>Lapis is designed to run your server in different configurations called
environments. For example you might have a development configuration with a
local database URL, code caching disabled, and a single worker. Then you might
have a production configuration with remote database URL, code caching enabled,
and 8 workers.</p>

<p>The <code>lapis</code> command line tool takes a second argument when starting the server:</p>

<pre class="highlight lang_bash"><code><span></span>$ lapis server <span class="o">[</span>environment<span class="o">]</span></code>
</pre>


<h2><a name="default-environment" href="#default-environment">Default Environment</a></h2>

<p>The default environment is used when you don&rsquo;t explicitly specify an
environment. The following conditions are checked in order to determine the
default environment:</p>

<ol>
<li>When inside a of a test suite (supported environments: <a href="http://olivinelabs.com/busted/">Busted</a>), the default environment is set to <code>test</code></li>
<li>When a module named <code>lapis_environment</code> exists, the return value of that module is used as the default environment</li>
<li>Otherwise, default environment is set to <code>development</code></li>
</ol>


<p>The default environment affects what configuration is loaded by default. The
environment name has no effect unless you are working with configurations.</p>

<blockquote><p>Database connections use the configurations to determine how to connect to
the database, so you'll often use different environments to connect to
different databases.</p></blockquote>

<h3><a name="default-environment/overriding-the-default-environment" href="#default-environment/overriding-the-default-environment">Overriding The Default Environment</a></h3>

<p>You can override the default environment by setting a <code>LAPIS_ENVIRONMENT</code>
environment variable on your system before executing any Lapis code.</p>

<p>Some <code>lapis</code> commands also let you explicitly set the environment to override
the default.</p>

<h2><a name="creating-configurations" href="#creating-configurations">Creating Configurations</a></h2>

<p>Whenever Lapis executes code that depends on a configuration it attempts to
load the module <code>"config"</code>.  The <code>"config"</code> module is where we define our
environment specific variables. It&rsquo;s a standard Lua/MoonScript file.</p>

<blockquote><p>If the <code>config</code> module is not found no error is thrown, and only the default
configuration is available.</p></blockquote>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">config</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.config&quot;</span><span class="p">)</span>

<span class="n">config</span><span class="p">(</span><span class="s2">&quot;development&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">port</span> <span class="o">=</span> <span class="mi">8080</span>
<span class="p">})</span>

<span class="n">config</span><span class="p">(</span><span class="s2">&quot;production&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
  <span class="n">num_workers</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
  <span class="n">code_cache</span> <span class="o">=</span> <span class="s2">&quot;on&quot;</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="c1">-- config.moon</span>
<span class="n">config</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.config</span><span class="s2">&quot;</span>

<span class="n">config</span> <span class="s2">&quot;</span><span class="s">development</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
  <span class="n">port</span> <span class="mi">8080</span>

<span class="n">config</span> <span class="s2">&quot;</span><span class="s">production</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
  <span class="n">port</span> <span class="mi">80</span>
  <span class="n">num_workers</span> <span class="mi">4</span>
  <span class="n">code_cache</span> <span class="s2">&quot;</span><span class="s">on</span><span class="s2">&quot;</span></code>
</pre>


<p>We use the configuration helpers provided in <code>"lapis.config"</code> to create our
configurations. This defines a domain specific language for setting variables.
In the example above we define two configurations, and set the ports for each
of them.</p>

<p>A configuration is just a plain table. Use the special builder syntax above to
construct the configuration tables.</p>

<p>We can configure multiple environments at once by passing in an array table for
environment names:</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">config</span><span class="p">({</span><span class="s2">&quot;development&quot;</span><span class="p">,</span> <span class="s2">&quot;production&quot;</span><span class="p">},</span> <span class="p">{</span>
  <span class="n">session_name</span> <span class="o">=</span> <span class="s2">&quot;my_app_session&quot;</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">config</span> <span class="kt">{</span><span class="s2">&quot;</span><span class="s">development</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">production</span><span class="s2">&quot;</span><span class="kt">}</span><span class="p">,</span> <span class="nf">-&gt;</span>
  <span class="n">session_name</span> <span class="s2">&quot;</span><span class="s">my_app_session</span><span class="s2">&quot;</span></code>
</pre>


<p>The configuration file has access to a nice syntax for combining nested
tables. Both MoonScript and Lua have their own variations, for more details
about the syntax have a look at the respective guide.</p>

<ul>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
</ul>


<h2><a name="built-in-configuration" href="#built-in-configuration">Built-in Configuration</a></h2>

<p>Although most configuration keys are free for any use, some names are reserved
for controlling how Lapis and supporting libraries work. Keep in mind some
configurations are only used depending on the server.</p>

<blockquote><p>For your app&rsquo;s configuration, you can avoid future conflicts by scoping your
configuration values to your app&rsquo;s name.</p></blockquote>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default value</td><td>Servers</td></tr></thead><tbody><tr><td><code>server</code></td><td><p>The server your code will run in. Either <code>nginx</code> or <code>cqueues</code></p>
</td><td><p><code>"nginx"</code></p>
</td><td><em>Any</em></td></tr><tr><td><code>port</code></td><td><p>The port your server will bind to</p>
</td><td><p><code>8080</code></p>
</td><td><em>Any</em></td></tr><tr><td><code>bind_host</code></td><td><p>The interface the server will bind to</p>
</td><td><p><code>"0.0.0.0"</code></p>
</td><td><strong>cqueues</strong></td></tr><tr><td><code>secret</code></td><td><p>The secret string used to sign sessions and tokens</p>
</td><td><p><code>"please-change-me"</code></p>
</td><td><em>Any</em></td></tr><tr><td><code>hmac_digest</code></td><td><p>Controls the hashing function used for HMAC sessions and signed strings. One of <code>"sha1"</code>, <code>"sha256"</code>.</p>
</td><td><p><code>"sha1"</code></p>
</td><td><em>Any</em></td></tr><tr><td><code>session_name</code></td><td><p>Name of cookie used to store the <a href="../reference/actions.html#request-object-session">session</a></p>
</td><td><p><code>"lapis_session"</code></p>
</td><td><em>Any</em></td></tr><tr><td><code>code_cache</code></td><td><p>Controls if code is cached across requests, or is reloaded for each request.</p>

<p>One of <code>"on"</code> or <code>"off"</code>. Production servers should enable code caching for maximum performance.</p>
</td><td><p><code>"off"</code></p>
</td><td><em>Any</em></td></tr><tr><td><code>num_workers</code></td><td><p>How many worker processes to spawn to handle requests. See
<a href="http://nginx.org/en/docs/ngx_core_module.html#worker_processes">worker_processes</a>.</p>
</td><td><p><code>1</code></p>
</td><td><strong>nginx</strong></td></tr><tr><td><code>logging</code></td><td><p>A table of loggers to enable, or <code>false</code> to disable all logging</p>
</td><td><p>See below</p>
</td><td><em>Any</em></td></tr><tr><td><code>max_request_args</code></td><td><p>Controls the maximum number of query and post parameters parsed from request.
See <code>max_args</code> in <a href="https://github.com/openresty/lua-nginx-module#ngxreqget_uri_args">get_uri_args</a>.</p>
</td><td><p><code>nil</code></p>
</td><td><strong>nginx</strong></td></tr><tr><td><code>measure_performance</code></td><td><p>Enables per-request performance metric collection, see <a href="#performance-measurement">Performance Measurement</a>.</p>
</td><td><p><code>false</code></p>
</td><td><em>Any</em></td></tr><tr><td><code>postgres</code></td><td><p>PostgreSQL connection settings</p>
</td><td><p><a href="database.html"><em>See PostgreSQL docs</em></a></p>
</td><td><em>Any</em></td></tr><tr><td><code>mysql</code></td><td><p>MySQL connection settings</p>
</td><td><p><a href="database.html"><em>See MySQL docs</em></a></p>
</td><td><em>Any</em></td></tr></tbody></table></p>

<h3><a name="built-in-configuration/logging-configuration" href="#built-in-configuration/logging-configuration">Logging configuration</a></h3>

<p>Logging configuration is stored in a table under the name <code>logging</code> in the
global configuration. If the value is set to <code>false</code> then all logging is
disabled.</p>

<blockquote><p>This only controls logging done by Lapis, server specific logging in
OpenResty is controlled with the nginx config file.</p></blockquote>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default value</td><td>Servers</td></tr></thead><tbody><tr><td><code>server</code></td><td><p>Show server start message</p>
</td><td><p><code>true</code></p>
</td><td><strong>cqueues</strong></td></tr><tr><td><code>queries</code></td><td><p>Show queries sent to database</p>
</td><td><p><code>true</code></p>
</td><td><em>Any</em></td></tr><tr><td><code>requests</code></td><td><p>Show path and status for every request</p>
</td><td><p><code>true</code></p>
</td><td><em>Any</em></td></tr></tbody></table></p>

<p>For OpenResty, all logging is done to Nginx&rsquo;s notice log using the <code>print</code>
function provided by OpenResty. The default notice logging location is set to
<code>stderr</code>, specified in the default Lapis Nginx configuration. It can be configured
using the <a href="http://nginx.org/en/docs/ngx_core_module.html#error_log"><code>error_log</code>
directive</a>.</p>

<p>Otherwise, logs are written to standard out using Lua&rsquo;s <code>print</code> function.</p>

<h2><a name="configurations-and-nginx" href="#configurations-and-nginx">Configurations and Nginx</a></h2>

<p>The values in the configuration are used when compiling <code>nginx.conf</code>.
Interpolated Nginx configuration variables are case insensitive. They are
typically written in all capitals because the shell&rsquo;s environment is checked
for a value before the configuration is checked.</p>

<p>For example, here&rsquo;s a chunk of an Lapis Nginx configuration:</p>

<pre class="highlight lang_nginx"><code><span></span><span class="k">events</span> <span class="p">{</span>
  <span class="kn">worker_connections</span> <span class="nv">${{WORKER_CONNECTIONS}}</span><span class="p">;</span>
<span class="p">}</span></code>
</pre>


<h2><a name="overriding-with-environment-variables" href="#overriding-with-environment-variables">Overriding With Environment Variables</a></h2>

<p>You can override any configuration value with an environment variable. Prefix
the configuration name with <code>LAPIS_</code> and make the rest of the name all
uppercase. For example, to override the <code>worker_connections</code> variable:</p>

<pre class="highlight lang_bash"><code><span></span>$ <span class="nv">LAPIS_WORKER_CONNECTIONS</span><span class="o">=</span><span class="m">5</span> lapis server</code>
</pre>


<p>This can be used with any configuration variable. Keep in mind that the value
will always be a string type, so you may need to add additional type coercion
to you code that reads it.</p>

<h2><a name="accessing-configuration-from-application" href="#accessing-configuration-from-application">Accessing Configuration From Application</a></h2>

<p>The configuration is also made available in the application. We can get access
to the configuration table like so:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">config</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.config&quot;</span><span class="p">).</span><span class="n">get</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">port</span><span class="p">)</span> <span class="c1">-- shows the current port</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">config</span> <span class="o">=</span> <span class="nb">require</span><span class="kt">(</span><span class="s2">&quot;</span><span class="s">lapis.config</span><span class="s2">&quot;</span><span class="kt">)</span><span class="o">.</span><span class="n">get</span><span class="o">!</span>
<span class="nb">print</span> <span class="n">config</span><span class="o">.</span><span class="n">port</span> <span class="c1">-- shows the current port</span></code>
</pre>


<p>The name of the environment is stored in <code>_name</code>.</p>

<pre class="highlight lang_lua"><code><span></span><span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">_name</span><span class="p">)</span> <span class="c1">-- development, production, etc...</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="nb">print</span> <span class="n">config</span><span class="o">.</span><span class="n">_name</span> <span class="c1">-- development, production, etc...</span></code>
</pre>


<h2><a name="performance-measurement" href="#performance-measurement">Performance Measurement</a></h2>

<p>Lapis can collect timings and counts for various actions if the
<code>measure_performance</code> configuration value is set to true.</p>

<p>The data is stored in <code>ngx.ctx.performance</code>. The following fields are collected
in a table:</p>

<ul>
<li><code>view_time</code> &mdash; Time in seconds spent rendering view</li>
<li><code>layout_time</code> &mdash; Time in seconds spent rendering layout</li>
<li><code>db_time</code> &mdash; Time in seconds spent executing queries</li>
<li><code>db_count</code> &mdash; The number of queries executed</li>
<li><code>http_time</code> &mdash; Time in seconds spent executing HTTP requests</li>
<li><code>http_count</code> &mdash; The number of HTTP requests sent</li>
</ul>


<p>A field will be <code>nil</code> if no corresponding action was done in the request. The
fields are filled out over the course of the request so it&rsquo;s best to only access
them at the very end of the request to ensure all the data is available. The
<code>after_dispatch</code> helper can be used to register a function to run at the very
end of processing a request.</p>

<p>In this example the performance data is printed to the log at the end of every
request:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">lapis</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">after_dispatch</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.nginx.context&quot;</span><span class="p">).</span><span class="n">after_dispatch</span>
<span class="kd">local</span> <span class="n">to_json</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.util&quot;</span><span class="p">).</span><span class="n">to_json</span>

<span class="kd">local</span> <span class="n">config</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.config&quot;</span><span class="p">)</span>

<span class="n">config</span><span class="p">(</span><span class="s2">&quot;development&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">measure_performance</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">})</span>


<span class="kd">local</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lapis</span><span class="p">.</span><span class="n">Application</span><span class="p">()</span>

<span class="n">app</span><span class="p">:</span><span class="n">before_filter</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
  <span class="n">after_dispatch</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">to_json</span><span class="p">(</span><span class="n">ngx</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">performance</span><span class="p">))</span>
  <span class="kr">end</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>

<span class="c1">-- ...</span>

<span class="kr">return</span> <span class="n">app</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">lapis</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis</span><span class="s2">&quot;</span>
<span class="k">import</span> <span class="n">after_dispatch</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.nginx.context</span><span class="s2">&quot;</span>
<span class="k">import</span> <span class="n">to_json</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.util</span><span class="s2">&quot;</span>

<span class="n">config</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.config</span><span class="s2">&quot;</span>
<span class="n">config</span> <span class="s2">&quot;</span><span class="s">development</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
  <span class="n">measure_performance</span> <span class="kc">true</span>

<span class="k">class</span> <span class="nc">App</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="vc">@before_filter</span> <span class="nf">=&gt;</span>
    <span class="n">after_dispatch</span> <span class="nf">-&gt;</span>
      <span class="nb">print</span> <span class="n">to_json</span><span class="kt">(</span><span class="n">ngx</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">performance</span><span class="kt">)</span>

  <span class="c1">-- ...</span></code>
</pre>


      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Fri Mar  4 00:38:58 2022"></script>
  <script type="text/javascript" src="../reference.js?Fri Mar  4 00:38:58 2022"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
