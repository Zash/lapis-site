<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Creating a Lapis Application with MoonScript - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Fri Nov  5 22:29:26 2021" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.9.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="moonscript">MoonScript</span>
          <span class="lang_toggle" data-lang="lua">Lua</span>
        </div>

        
          <div class="nav_links">
            <h2>Contents</h2>
            <ul><li><a href="#creating-a-basic-application">Creating a Basic Application</a></li>
<li><a href="#lapis-applications">Lapis Applications</a></li>
<li><a href="#moonscript-tips">MoonScript Tips</a></li>
<ul><li><a href="#moonscript-tips/actions">Actions</a></li>
<li><a href="#moonscript-tips/sub-applications">Sub-Applications</a></li>
<ul><li><a href="#moonscript-tips/sub-applications/include"><code>@include(other_application, [opts])</code></a></li></ul>
<li><a href="#moonscript-tips/class-methods">Class Methods</a></li>
<ul><li><a href="#moonscript-tips/class-methods/find_action"><code>@find_action(action_name)</code></a></li></ul></ul></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><div class="override_lang"></div>


<h1>Creating a Lapis Application with MoonScript</h1>

<h2><a name="creating-a-basic-application" href="#creating-a-basic-application">Creating a Basic Application</a></h2>

<p>You can start a new MoonScript project in the current directory by running the
following command:</p>

<pre class="highlight lang_bash"><code><span></span>$ lapis new</code>
</pre>


<p>This provides us with a default Nginx configuration, <code>nginx.conf</code>, and a
skeleton application, <code>app.moon</code>. The skeleton application looks like this:</p>

<pre class="highlight lang_moon"><code><span></span><span class="c1">-- app.moon</span>
<span class="n">lapis</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="s2">&quot;</span><span class="s">/</span><span class="s2">&quot;</span><span class="o">:</span> <span class="nf">=&gt;</span>
    <span class="s2">&quot;</span><span class="s">Welcome to Lapis #{require </span><span class="s2">&quot;</span><span class="n">lapis</span><span class="o">.</span><span class="n">version</span><span class="s2">&quot;</span><span class="s">}!</span><span class="s2">&quot;</span></code>
</pre>


<p>This defines a regular Lua module that returns our application class. (Implicit
return in MoonScript states that the last statement in a block of code is the
return value.)</p>

<blockquote><p>Don&rsquo;t forget to compile the <code>.moon</code> files when changing and creating them.
You can watch the current directory and compile automatically with <code>moonc
-w</code> but be aware new files arenâ€™t picked up, you have to restart <code>moonc</code>.</p></blockquote>

<p>Try it out by starting the server:</p>

<pre class="highlight lang_bash"><code><span></span>lapis server</code>
</pre>


<p>If you've compiled the <code>.moon</code> file then <a href="http://localhost:8080">http://localhost:8080</a> will display
the page.</p>

<h2><a name="lapis-applications" href="#lapis-applications">Lapis Applications</a></h2>

<p>When we refer to a Lapis application we are talking about a class that extends
from <code>lapis.Application</code>. The properties of the application make up the routes
the application can serve and the actions it will perform.</p>

<p>Here&rsquo;s a slightly more complicated example to give you a feel of what they look
like:</p>

<pre class="highlight lang_moon"><code><span></span><span class="n">lapis</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis</span><span class="s2">&quot;</span>

<span class="n">favorite_foods</span> <span class="o">=</span> <span class="kt">{</span>
  <span class="s2">&quot;</span><span class="s">pizza</span><span class="s2">&quot;</span><span class="o">:</span> <span class="s2">&quot;</span><span class="s">Wow pizza is the best! Definitely my favorite</span><span class="s2">&quot;</span>
  <span class="s2">&quot;</span><span class="s">egg</span><span class="s2">&quot;</span><span class="o">:</span> <span class="s2">&quot;</span><span class="s">A classic breakfast, never leave home without</span><span class="s2">&quot;</span>
  <span class="s2">&quot;</span><span class="s">ice cream</span><span class="s2">&quot;</span><span class="o">:</span> <span class="s2">&quot;</span><span class="s">Can&#39;t have a food list without a dessert</span><span class="s2">&quot;</span>
<span class="kt">}</span>

<span class="k">class</span> <span class="nc">App</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="kt">[</span><span class="nv">index:</span> <span class="s2">&quot;</span><span class="s">/</span><span class="s2">&quot;</span><span class="kt">]</span><span class="o">:</span> <span class="nf">=&gt;</span>
    <span class="c1">-- Render HTML inline for simplicity</span>
    <span class="vc">@html</span> <span class="nf">-&gt;</span>
      <span class="n">h1</span> <span class="s2">&quot;</span><span class="s">My homepage</span><span class="s2">&quot;</span>
      <span class="n">a</span> <span class="nv">href:</span> <span class="vc">@url_for</span><span class="kt">(</span><span class="s2">&quot;</span><span class="s">list_foods</span><span class="s2">&quot;</span><span class="kt">)</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">Check out my favorite foods</span><span class="s2">&quot;</span>

  <span class="kt">[</span><span class="nv">list_foods:</span> <span class="s2">&quot;</span><span class="s">/foods</span><span class="s2">&quot;</span><span class="kt">]</span><span class="o">:</span> <span class="nf">=&gt;</span>
    <span class="vc">@html</span> <span class="nf">-&gt;</span>
      <span class="n">ul</span> <span class="nf">-&gt;</span>
        <span class="k">for</span> <span class="n">food</span> <span class="k">in</span> <span class="nb">pairs</span> <span class="n">favorite_foods</span>
          <span class="n">li</span> <span class="nf">-&gt;</span>
            <span class="n">a</span> <span class="nv">href:</span> <span class="vc">@url_for</span><span class="kt">(</span><span class="s2">&quot;</span><span class="s">food</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">name:</span> <span class="n">food</span><span class="kt">)</span><span class="p">,</span> <span class="n">food</span>

  <span class="kt">[</span><span class="nv">food:</span> <span class="s2">&quot;</span><span class="s">/food/:name</span><span class="s2">&quot;</span><span class="kt">]</span><span class="o">:</span> <span class="nf">=&gt;</span>
    <span class="n">food_description</span> <span class="o">=</span> <span class="n">favorite_foods</span><span class="kt">[</span><span class="vc">@params</span><span class="o">.</span><span class="n">name</span><span class="kt">]</span>
    <span class="n">unless</span> <span class="n">food_description</span>
      <span class="k">return</span> <span class="s2">&quot;</span><span class="s">Not found</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">status:</span> <span class="mi">404</span>

    <span class="vc">@html</span> <span class="nf">-&gt;</span>
      <span class="n">h1</span> <span class="vc">@params</span><span class="o">.</span><span class="n">name</span>
      <span class="n">h2</span> <span class="s2">&quot;</span><span class="s">My thoughts on this food</span><span class="s2">&quot;</span>
      <span class="n">p</span> <span class="n">food_description</span></code>
</pre>


<p>You can learn about each of the components used in this example on the
<a href="../reference/actions.html">Requests and Actions guide</a>.</p>

<h2><a name="moonscript-tips" href="#moonscript-tips">MoonScript Tips</a></h2>

<p>Lapis is a bi-language library. It works for either MoonScript or Lua. The rest
of this page will have information specific to the MoonScript interface.
It might be more helpful to check out the <a href="../reference/actions.html">Requests and Actions guide</a> first
to learn more about the basics before reading this section.</p>

<h3><a name="moonscript-tips/actions" href="#moonscript-tips/actions">Actions</a></h3>

<p>The members of the application class make up the patterns that can be matched
by incoming requests. This is referred to as the route and the action, where
the route is the pattern and the action is the function that handles the
matching route:</p>

<pre class="highlight lang_moon"><code><span></span><span class="n">lapis</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">App</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="s2">&quot;</span><span class="s">/hello</span><span class="s2">&quot;</span><span class="o">:</span> <span class="nf">=&gt;</span> <span class="s2">&quot;</span><span class="s">Hello World!</span><span class="s2">&quot;</span></code>
</pre>


<p>In this example, the route <code>"/hello"</code> is matched to a function that
returns <code>"Hello World!"</code></p>

<p>The action is the function called in response to a route matching the path of a
request. Actions are written with the fat arrow, <code>=&gt;</code>, because they all receive
a first argument from Lapis. You might think that <code>self</code> is an instance of
application. It&rsquo;s actually an instance of <code>Request</code>, a class that&rsquo;s used to
represent the current request.</p>

<p>We can also access the instance of the application with <code>@app</code>. You should
treat <code>@app</code> as read only because the instance is shared among many requests.</p>

<p>The members of the class that you want to be routes must start with <code>"/"</code>,
otherwise they are treated as regular methods of the application class.</p>

<h3><a name="moonscript-tips/sub-applications" href="#moonscript-tips/sub-applications">Sub-Applications</a></h3>

<p>As your application becomes more complex it helps to break it apart into
multiple sub-applications. Lapis doesn&rsquo;t place any rules on how you divide your
application, instead it gives you tools to organize your own way.</p>

<h4><a name="moonscript-tips/sub-applications/include" href="#moonscript-tips/sub-applications/include"><code>@include(other_application, [opts])</code></a></h4>

<p>Let&rsquo;s say we've got a separate application for handling users:</p>

<pre class="highlight lang_moon"><code><span></span><span class="c1">-- applications/users.moon</span>
<span class="n">lapis</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">UsersApplication</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="kt">[</span><span class="nv">login:</span> <span class="s2">&quot;</span><span class="s">/login</span><span class="s2">&quot;</span><span class="kt">]</span><span class="o">:</span> <span class="n">do_login</span><span class="o">!</span>
  <span class="kt">[</span><span class="nv">logout:</span> <span class="s2">&quot;</span><span class="s">/logout</span><span class="s2">&quot;</span><span class="kt">]</span><span class="o">:</span> <span class="n">do_logout</span><span class="o">!</span></code>
</pre>


<p>We can include this application into our main one:</p>

<pre class="highlight lang_moon"><code><span></span><span class="c1">-- app.moon</span>
<span class="n">lapis</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="vc">@include</span> <span class="s2">&quot;</span><span class="s">applications.users</span><span class="s2">&quot;</span>

  <span class="kt">[</span><span class="nv">index:</span> <span class="s2">&quot;</span><span class="s">/</span><span class="s2">&quot;</span><span class="kt">]</span><span class="o">:</span> <span class="nf">=&gt;</span>
    <span class="vc">@html</span> <span class="nf">-&gt;</span>
      <span class="n">a</span> <span class="nv">href:</span> <span class="vc">@url_for</span><span class="kt">(</span><span class="s2">&quot;</span><span class="s">login</span><span class="s2">&quot;</span><span class="kt">)</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">Log in</span><span class="s2">&quot;</span></code>
</pre>


<p>In this example <code>applications/users.moon</code> is a module that returns the
sub-application. The <code>include</code> class method is used to load this application
into our root one. <code>include</code> copies all the routes of the other application,
leaving the original untouched.</p>

<p>Sub-applications are allowed to have before filters, and the before filters
will only apply to all actions enclosed by the application.</p>

<p>A sub-application supports special <code>path</code> and <code>name</code> class values:</p>

<ul>
<li><code>path</code> &mdash; The patterns of the routes copied are prefixed with <code>path</code></li>
<li><code>name</code> &mdash; The names of all the routes copied are prefixed with <code>name</code></li>
</ul>


<pre class="highlight lang_moon"><code><span></span><span class="k">class</span> <span class="nc">UsersApplication</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="vc">@path</span><span class="o">:</span> <span class="s2">&quot;</span><span class="s">/users</span><span class="s2">&quot;</span>
  <span class="vc">@name</span><span class="o">:</span> <span class="s2">&quot;</span><span class="s">user_</span><span class="s2">&quot;</span>

  <span class="c1">-- etc...</span></code>
</pre>


<p><code>include</code> takes an optional second argument, a table of options. The options
can be used to provide or override the <code>path</code> and <code>name</code> values that might have
been set in the application.</p>

<p>For example, we might prefix <code>UsersApplication</code> like so:</p>

<pre class="highlight lang_moon"><code><span></span><span class="k">class</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="vc">@include</span> <span class="s2">&quot;</span><span class="s">applications.users</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">path:</span> <span class="s2">&quot;</span><span class="s">/users</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">name:</span> <span class="s2">&quot;</span><span class="s">user_</span><span class="s2">&quot;</span>

  <span class="s2">&quot;</span><span class="s">/</span><span class="s2">&quot;</span><span class="o">:</span> <span class="nf">=&gt;</span>
    <span class="vc">@url_for</span><span class="kt">(</span><span class="s2">&quot;</span><span class="s">user_login</span><span class="s2">&quot;</span><span class="kt">)</span> <span class="c1">-- returns &quot;/users/login&quot;</span></code>
</pre>


<h3><a name="moonscript-tips/class-methods" href="#moonscript-tips/class-methods">Class Methods</a></h3>

<h4><a name="moonscript-tips/class-methods/find_action" href="#moonscript-tips/class-methods/find_action"><code>@find_action(action_name)</code></a></h4>

<p>Returns the function of the action that has the name specified by
<code>action_name</code>.</p>

      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Fri Nov  5 22:29:26 2021"></script>
  <script type="text/javascript" src="../reference.js?Fri Nov  5 22:29:26 2021"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
