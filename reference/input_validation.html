<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Input Validation - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Fri Nov  5 21:11:39 2021" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.9.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="moonscript">MoonScript</span>
          <span class="lang_toggle" data-lang="lua">Lua</span>
        </div>

        
          <div class="nav_links">
            <h2>Contents</h2>
            <ul><li><a href="#example-validation">Example Validation</a></li>
<li><a href="#validation-functions">Validation Functions</a></li>
<li><a href="#optional-validations">Optional validations</a></li>
<li><a href="#creating-a-custom-validator">Creating a Custom Validator</a></li>
<li><a href="#manual-validation">Manual Validation</a></li></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><h1>Input Validation</h1>

<h2><a name="example-validation" href="#example-validation">Example Validation</a></h2>

<p>Lapis comes with a set of validators for working with external inputs. Here&rsquo;s a
quick example:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">lapis</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">app_helpers</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.application&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">validate</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.validate&quot;</span><span class="p">)</span>

<span class="kd">local</span> <span class="n">capture_errors</span> <span class="o">=</span> <span class="n">app_helpers</span><span class="p">.</span><span class="n">capture_errors</span>

<span class="kd">local</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lapis</span><span class="p">.</span><span class="n">Application</span><span class="p">()</span>

<span class="n">app</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;/create-user&quot;</span><span class="p">,</span> <span class="n">capture_errors</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
  <span class="n">validate</span><span class="p">.</span><span class="n">assert_valid</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">params</span><span class="p">,</span> <span class="p">{</span>
    <span class="p">{</span> <span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="n">exists</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">min_length</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">max_length</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="n">exists</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">min_length</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s2">&quot;password_repeat&quot;</span><span class="p">,</span> <span class="n">equals</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">password</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="n">exists</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">min_length</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s2">&quot;accept_terms&quot;</span><span class="p">,</span> <span class="n">equals</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;You must accept the Terms of Service&quot;</span> <span class="p">}</span>
  <span class="p">})</span>

  <span class="n">create_the_user</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">params</span><span class="p">)</span>
  <span class="kr">return</span> <span class="p">{</span> <span class="n">render</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">}</span>
<span class="kr">end</span><span class="p">))</span>


<span class="kr">return</span> <span class="n">app</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">capture_errors</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.application</span><span class="s2">&quot;</span>
<span class="k">import</span> <span class="n">assert_valid</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.validate</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">App</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="s2">&quot;</span><span class="s">/create-user</span><span class="s2">&quot;</span><span class="o">:</span> <span class="n">capture_errors</span> <span class="nf">=&gt;</span>

    <span class="n">assert_valid</span> <span class="vc">@params</span><span class="p">,</span> <span class="kt">{</span>
      <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">username</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">exists:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">min_length:</span> <span class="mi">2</span><span class="p">,</span> <span class="nv">max_length:</span> <span class="mi">25</span> <span class="kt">}</span>
      <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">password</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">exists:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">min_length:</span> <span class="mi">2</span> <span class="kt">}</span>
      <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">password_repeat</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">equals:</span> <span class="vc">@params</span><span class="o">.</span><span class="n">password</span> <span class="kt">}</span>
      <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">email</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">exists:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">min_length:</span> <span class="mi">3</span> <span class="kt">}</span>
      <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">accept_terms</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">equals:</span> <span class="s2">&quot;</span><span class="s">yes</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">You must accept the Terms of Service</span><span class="s2">&quot;</span> <span class="kt">}</span>
    <span class="kt">}</span>

    <span class="n">create_the_user</span> <span class="vc">@params</span>
    <span class="nv">render:</span> <span class="kc">true</span></code>
</pre>


<p><code>assert_valid</code> takes two arguments, a table to be validated, and a second array
table with a list of validations to perform. Each validation is the following format:</p>

<pre><code>{ Validation_Key, [Error_Message], Validation_Function: Validation_Argument, ... }
</code></pre>

<p><code>Validation_Key</code> is the key to fetch from the table being validated.</p>

<p>Any number of validation functions can be provided. If a validation function
takes multiple arguments, pass an array table. (Note: A single table argument
cannot be used, it will be unpacked into arguments.)</p>

<p><code>Error_Message</code> is an optional second positional value. If provided it will be
used as the validation failure error message instead of the default generated
one. Because of how Lua tables work, it can also be provided after the
validation functions as demonstrated in the example above.</p>

<h2><a name="validation-functions" href="#validation-functions">Validation Functions</a></h2>

<ul>
<li><code>exists: true</code> &mdash; check if the value exists and is not an empty string</li>
<li><code>matches_pattern: pat</code> &mdash; value is a string that matches the Lua pattern provided by <code>pat</code></li>
<li><code>min_length: Min_Length</code> &mdash; value must be at least <code>Min_Length</code> chars</li>
<li><code>max_length: Max_Length</code> &mdash; value must be at most <code>Max_Length</code> chars</li>
<li><code>is_integer: true</code> &mdash; value matches integer pattern</li>
<li><code>is_color: true</code> &mdash; value matches CSS hex color (eg. <code>#1234AA</code>)</li>
<li><code>is_file: true</code> &mdash; value is an uploaded file, see <a href="utilities.html#file-uploads">File Uploads</a></li>
<li><code>equals: String</code> &mdash; value is equal to String</li>
<li><code>type: String</code> &mdash; type of value is equal to String</li>
<li><code>one_of: {A, B, C, ...}</code> &mdash; value is equal to one of the elements in the array table</li>
</ul>


<h2><a name="optional-validations" href="#optional-validations">Optional validations</a></h2>

<p>You can set <code>optional</code> to true for a validation to make it validate only when
some value is provided. If the parameter&rsquo;s value is <code>nil</code>, then the validation
will skip it without failure.</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">validate</span><span class="p">.</span><span class="n">assert_valid</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">params</span><span class="p">,</span> <span class="p">{</span>
  <span class="p">{</span> <span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="n">exists</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">min_length</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">max_length</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="n">optional</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">},</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">assert_valid</span> <span class="vc">@params</span><span class="p">,</span> <span class="kt">{</span>
  <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">color</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">exists:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">min_length:</span> <span class="mi">2</span><span class="p">,</span> <span class="nv">max_length:</span> <span class="mi">25</span><span class="p">,</span> <span class="nv">optional:</span> <span class="kc">true</span> <span class="kt">}</span><span class="p">,</span>
<span class="kt">}</span></code>
</pre>


<h2><a name="creating-a-custom-validator" href="#creating-a-custom-validator">Creating a Custom Validator</a></h2>

<p>Custom validators can be defined like so:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">validate</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.validate&quot;</span><span class="p">)</span>

<span class="n">validate</span><span class="p">.</span><span class="n">validate_functions</span><span class="p">.</span><span class="n">integer_greater_than</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">min</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">num</span> <span class="o">=</span> <span class="nb">tonumber</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">num</span> <span class="ow">and</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="n">min</span><span class="p">,</span> <span class="s2">&quot;%s must be greater than &quot;</span> <span class="o">..</span> <span class="n">min</span>
<span class="kr">end</span>

<span class="kd">local</span> <span class="n">app_helpers</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.application&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">capture_errors</span> <span class="o">=</span> <span class="n">app_helpers</span><span class="p">.</span><span class="n">capture_errors</span>

<span class="kd">local</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lapis</span><span class="p">.</span><span class="n">Application</span><span class="p">()</span>

<span class="n">app</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">capture_errors</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
  <span class="n">validate</span><span class="p">.</span><span class="n">assert_valid</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">params</span><span class="p">,</span> <span class="p">{</span>
    <span class="p">{</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">integer_greater_than</span> <span class="o">=</span> <span class="mi">100</span> <span class="p">}</span>
  <span class="p">})</span>
<span class="kr">end</span><span class="p">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">validate_functions</span><span class="p">,</span> <span class="n">assert_valid</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.validate</span><span class="s2">&quot;</span>

<span class="n">validate_functions</span><span class="o">.</span><span class="n">integer_greater_than</span> <span class="o">=</span> <span class="kt">(</span><span class="n">input</span><span class="p">,</span> <span class="n">min</span><span class="kt">)</span> <span class="nf">-&gt;</span>
  <span class="n">num</span> <span class="o">=</span> <span class="nb">tonumber</span> <span class="n">input</span>
  <span class="n">num</span> <span class="k">and</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="n">min</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">%s must be greater than #{min}</span><span class="s2">&quot;</span>

<span class="k">import</span> <span class="n">capture_errors</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.application</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">App</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="s2">&quot;</span><span class="s">/</span><span class="s2">&quot;</span><span class="o">:</span> <span class="n">capture_errors</span> <span class="nf">=&gt;</span>
    <span class="n">assert_valid</span> <span class="vc">@params</span><span class="p">,</span> <span class="kt">{</span>
      <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">number</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">integer_greater_than:</span> <span class="mi">100</span> <span class="kt">}</span>
    <span class="kt">}</span></code>
</pre>


<h2><a name="manual-validation" href="#manual-validation">Manual Validation</a></h2>

<p>In addition to <code>assert_valid</code> there is one more useful validation function:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">validate</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.validate&quot;</span><span class="p">).</span><span class="n">validate</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">validate</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.validate</span><span class="s2">&quot;</span></code>
</pre>


<ul>
<li><code>validate(object, validation)</code> &mdash; takes the same exact arguments as
<code>assert_valid</code>, but returns either errors or <code>nil</code> on failure instead of
yielding the error.</li>
</ul>


      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Fri Nov  5 21:11:39 2021"></script>
  <script type="text/javascript" src="../reference.js?Fri Nov  5 21:11:39 2021"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
