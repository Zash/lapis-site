<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Command Line Interface - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Wed Jan  4 22:57:36 2023" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.11.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="lua">Lua</span>
          <span class="lang_toggle" data-lang="moonscript">MoonScript</span>
        </div>

        
          <div class="nav_links">
            <h2>Command Line Interface</h2>
            <ul><li><a href="#command-reference">Command Reference</a></li>
<ul><li><a href="#command-reference/lapis-new"><code>lapis new</code></a></li>
<li><a href="#command-reference/lapis-server"><code>lapis server</code></a></li>
<li><a href="#command-reference/lapis-build"><code>lapis build</code></a></li>
<li><a href="#command-reference/lapis-migrate"><code>lapis migrate</code></a></li>
<li><a href="#command-reference/lapis-term"><code>lapis term</code></a></li></ul></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><h1>Command Line Interface</h1>

<h2><a name="command-reference" href="#command-reference">Command Reference</a></h2>

<p>The Lapis command line interface gives you a couple of handful tools for
working with Lapis projects.</p>

<p>Some commands can take an <code>environment</code> argument to specify which configuration
to use. If the environment is not provided then the <a href="../reference/configuration.html#default-environment">default environment</a> is
used.</p>

<p>If the file
<code>lapis_environment.lua</code> exists in the directory, then the return value of that
file will be used, otherwise it is <code>development</code>.</p>

<p>For example, if you have a production deployment, you might add the following file:</p>

<pre class="highlight lang_lua"><code><span class="sh_comment">-- lapis_environment.lua</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_keyword">return</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_string">&quot;production&quot;</span></code>
</pre>


<pre class="highlight lang_moon"><code><span class="sh_comment">-- lapis_environment.moon</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_keyword">return</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;production&quot;</span></code>
</pre>


<h3><a name="command-reference/lapis-new" href="#command-reference/lapis-new"><code>lapis new</code></a></h3>

<pre class="highlight lang_bash"><code><span class="sh_default">$</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">new</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_operator">[--</span><span class="sh_identifier">git</span><span class="sh_operator">]</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_operator">[--</span><span class="sh_identifier">tup</span><span class="sh_operator">]</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_operator">[--</span><span class="sh_identifier">lua</span><span class="sh_operator">]</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_operator">[--</span><span class="sh_identifier">cqueues</span><span class="sh_operator">|--</span><span class="sh_identifier">nginx</span><span class="sh_operator">]</span></code>
</pre>


<p>The <code>new</code> command will create a blank Lapis project in the current directory.
By default it creates the following files:</p>

<ul>
<li><code>nginx.conf</code></li>
<li><code>mime.types</code></li>
<li><code>app.moon</code></li>
</ul>


<p>You're encouraged to look at all of these files and customize them to your
needs.</p>

<p>You can tell it to generate additional files using the following flags:</p>

<p><code>--git</code> generates a <code>.gitignore</code> file containing the following:</p>

<pre><code>*.lua
logs/
nginx.conf.compiled
</code></pre>

<p><code>--tup</code> &mdash; generates <code>Tupfile</code> and <code>Tuprules.tup</code> for use with
<a href="http://gittup.org/tup/">Tup</a> build system. The rules file contains a rule for
building MoonScript files to Lua.</p>

<p><code>--lua</code> &mdash; generates a skeleton Lua app instead of MoonScript.</p>

<h3><a name="command-reference/lapis-server" href="#command-reference/lapis-server"><code>lapis server</code></a></h3>

<pre class="highlight lang_bash"><code><span class="sh_default">$</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">server</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_operator">[</span><span class="sh_identifier">environment</span><span class="sh_operator">]</span></code>
</pre>


<p>This command is a wrapper around starting OpenResty. It firsts builds the
config, ensures logs exist, then starts the sever with the correct environment.</p>

<p>Lapis ensures that it runs a version of Nginx that is OpenResty. It will search
<code>$PATH</code> and any common OpenResty installation directories to find the correct
binary.</p>

<p>Lapis searches the following directories for an installation of OpenResty:</p>

<pre><code>"/usr/local/openresty/nginx/sbin/"
"/usr/local/opt/openresty/bin/"
"/usr/sbin/"
""
</code></pre>

<p>If you need to manually specify the location of the OpenResty binary you can do
so with the <code>LAPIS_OPENRESTY</code> environment variable:</p>

<pre><code>LAPIS_OPENRESTY=/home/leafo/bin/openresty lapis server
</code></pre>

<p>After finding the correct binary it will run a command similar to this to start
the server (where <code>nginx</code> is the path to the located OpenResty installation):</p>

<pre class="highlight lang_bash"><code><span class="sh_default">$</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">nginx</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_keyword">-p</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_string">&quot;$(pwd)&quot;</span><span class="sh_operator">/</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_keyword">-c</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_string">&quot;nginx.conf.compiled&quot;</span></code>
</pre>


<h3><a name="command-reference/lapis-build" href="#command-reference/lapis-build"><code>lapis build</code></a></h3>

<pre class="highlight lang_bash"><code><span class="sh_default">$</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">build</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_operator">[</span><span class="sh_identifier">environment</span><span class="sh_operator">]</span></code>
</pre>


<p>Rebuilds the config. If the server is currently running then a <code>HUP</code> signal
will be sent to it. This causes the configuration to be reloaded. By default
Nginx does not see changes to the config file while it is running. By executing
<code>lapis build</code> you will tell Nginx to reload the config without having to
restart the server.</p>

<p>As a side effect all the Nginx workers are restarted, so your application code
is also reloaded.</p>

<p>This is the best approach when deploying a new version of your code to
production. You'll be able to reload everything without dropping any requests.</p>

<p>You can read more in the <a href="http://wiki.nginx.org/CommandLine#Loading_a_New_Configuration_Using_Signals">Nginx manual</a>.</p>

<h3><a name="command-reference/lapis-migrate" href="#command-reference/lapis-migrate"><code>lapis migrate</code></a></h3>

<pre class="highlight lang_bash"><code><span class="sh_default">$</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">migrate</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_operator">[</span><span class="sh_identifier">environment</span><span class="sh_operator">]</span></code>
</pre>


<p>This will run any outstanding migrations. It will also create the migrations
table if it does not exist yet.</p>

<p>This command expects a <code>migrations</code> module as described in <a href="database.html#database-migrations/running-migrations">Running
Migrations</a>.</p>

<p>It executes on the server approximately this code:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">migrations</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;migrations&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.db.migrations&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">run_migrations</span><span class="sh_operator">(</span><span class="sh_identifier">migrations</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">run_migrations</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db.migrations&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">run_migrations</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;migrations&quot;</span></code>
</pre>
</div>

</p>

<p>You can instruct the migrations to be run in a transaction by providng the
<code>--transaction</code> flag.</p>

<p>To wrap each individual migration in a transaction use:
<code>--transaction=individual</code></p>

<h3><a name="command-reference/lapis-term" href="#command-reference/lapis-term"><code>lapis term</code></a></h3>

<p>This will shut down a running server. This is useful if you've instructed Lapis
to start Nginx as a daemon. If you are running the server in the foreground you
can stop it using Ctrl-C.</p>

<p>It works by sending a TERM signal to the Nginx master process.</p>

      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Wed Jan  4 22:57:36 2023"></script>
  <script type="text/javascript" src="../reference.js?Wed Jan  4 22:57:36 2023"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
