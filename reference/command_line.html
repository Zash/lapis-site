<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Command Line Interface - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Mon Jan  9 21:58:43 2023" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.12.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="lua">Lua</span>
          <span class="lang_toggle" data-lang="moonscript">MoonScript</span>
        </div>

        
          <div class="nav_links">
            <h2>Command Line Interface</h2>
            <ul><li><a href="#default-environment">Default Environment</a></li>
<li><a href="#command-reference">Command Reference</a></li>
<ul><li><a href="#command-reference/lapis-new"><code>lapis new</code></a></li>
<li><a href="#command-reference/lapis-server"><code>lapis server</code></a></li>
<ul><li><a href="#command-reference/lapis-server/openresty-server">OpenResty Server</a></li>
<li><a href="#command-reference/lapis-server/cqueues-server">Cqueues Server</a></li></ul>
<li><a href="#command-reference/lapis-migrate"><code>lapis migrate</code></a></li>
<li><a href="#command-reference/lapis-build"><code>lapis build</code></a></li>
<li><a href="#command-reference/lapis-term"><code>lapis term</code></a></li></ul></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><h1>Command Line Interface</h1>

<p>A <code>lapis</code> command is installed into your system when Lapis is installed with
LuaRocks. Run <code>lapis</code> in your terminal to install without any arguments to get
a summary of what it can do, along with information about the installation, eg.</p>

<pre><code>Usage: lapis [-h] [--environment &lt;name&gt;] [--config-module &lt;name&gt;]
       [--trace] &lt;command&gt; ...

Control &amp; create web applications written with Lapis
Lapis: 1.12.0
Default environment: development
OpenResty: /usr/local/openresty/nginx/sbin/nginx
cqueues: 20200726 lua-http: 0.4

Options:
   -h, --help            Show this help message and exit.
   --environment &lt;name&gt;  Override the environment name
   --config-module &lt;name&gt;
                         Override module name to require configuration from (default: config)
   --trace               Show full error trace if lapis command fails

Commands:
   help                  Show help for commands.
   new                   Create a new Lapis project in the current directory
   server, serve         Start the server from the current directory
   build                 Rebuild configuration and send a reload signal (server: nginx)
   term                  Sends TERM signal to shut down a running server (server: nginx)
   exec, execute         Execute Lua on the server (server: nginx)
   migrate               Run any outstanding migrations
   generate              Generates a new file in the current directory from template
</code></pre>

<p>Note that some commands are only available for certain server types, eg. <code>lapis
term</code> is only available for OpenResty/nginx.</p>

<p>To learn more about a command you can type <code>lapis help COMMAND</code>, eg. <code>lapis
help migrate</code>.</p>

<h2><a name="default-environment" href="#default-environment">Default Environment</a></h2>

<p>Lapis will load your Applications&rsquo;s configuration by for an environment before
executing a command. The default environment name in command line <code>development</code>
unless otherwise overwritten.</p>

<p>You can confirm what the default environment is by running <code>lapis help</code>.</p>

<p>You are free to use any environment name you want. You can change the
environment in a few different ways:</p>

<ul>
<li>Using the <code>--environment</code> flag on the <code>lapis</code> command will set the environment for the duration of the command</li>
<li>For convenience, some commands can also take the environment as an argument after the command name, eg <code>lapis server production</code> (This will have the same effect as using <code>--environment</code></li>
<li>Creating a <code>lapis_environment.lua</code> file in your working directory that returns a string will allow you to change the default environment to whatever is returned</li>
<li>Setting the <code>LAPIS_ENVIRONMENT</code> environment variable will change the default environment</li>
</ul>


<p>Learn more about environments on the <a href="configuration.html">Configuration</a> guide.</p>

<h2><a name="command-reference" href="#command-reference">Command Reference</a></h2>

<h3><a name="command-reference/lapis-new" href="#command-reference/lapis-new"><code>lapis new</code></a></h3>

<pre><code>Usage: lapis new ([--nginx] | [--cqueues]) ([--lua] | [--moonscript])
       [-h] [--etlua-config] [--git] [--tup]

Create a new Lapis project in the current directory

Options:
   -h, --help            Show this help message and exit.
   --nginx               Generate config for nginx server (default)
   --cqueues             Generate config for cqueues server
   --lua                 Generate app template file in Lua (defaul)
   --moonscript, --moon  Generate app template file in MoonScript
   --etlua-config        Use etlua for templated configuration files (eg. nginx.conf)
   --git                 Generate default .gitignore file
   --tup                 Generate default Tupfile
</code></pre>

<p>The <code>new</code> command will create a blank Lapis project in the current directory by
writing some starter files. Note that it is not necessary to use <code>lapis new</code> to
create a new Lapis project, but it can help you get started more quickly.</p>

<p>By default it creates the following files for a OpenResty server:</p>

<ul>
<li><code>nginx.conf</code></li>
<li><code>mime.types</code></li>
<li><code>app.lua</code></li>
<li><code>config.lua</code></li>
</ul>


<blockquote><p>Use the <code>--moonscript</code> flag to generate a blank MoonScript based app</p></blockquote>

<p>The generated files are only starting points, you are encouraged to read, and
customize them.</p>

<h3><a name="command-reference/lapis-server" href="#command-reference/lapis-server"><code>lapis server</code></a></h3>

<pre class="highlight lang_bash"><code><span class="sh_default">$</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">server</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_operator">[</span><span class="sh_identifier">environment</span><span class="sh_operator">]</span></code>
</pre>


<p>This command start the configured webserver for your app under the specified
environment. This command will first read your configuration file to determine
the server type for the environment, then it will attempt to start your
application using the entry point for the app.</p>

<h4><a name="command-reference/lapis-server/openresty-server" href="#command-reference/lapis-server/openresty-server">OpenResty Server</a></h4>

<p>The default configuration utilizes OpenResty as the webserver. The <code>server</code>
command first builds the config, ensures logs exist, then starts the nginx
binary with the local <code>nginx.conf</code> file.</p>

<p>Lapis ensures that it runs a version of Nginx that is OpenResty. It will search
<code>$PATH</code> and any common OpenResty installation directories to find the correct
binary.</p>

<p>Lapis searches the following directories for an installation of OpenResty:</p>

<pre><code>"/usr/local/openresty/nginx/sbin/"
"/usr/local/opt/openresty/bin/"
"/usr/sbin/"
""
</code></pre>

<p>If you need to manually specify the location of the OpenResty binary you can do
so with the <code>LAPIS_OPENRESTY</code> environment variable:</p>

<pre><code>LAPIS_OPENRESTY=/home/leafo/bin/openresty lapis server
</code></pre>

<p>After finding the correct binary it will run a command similar to this to start
the server (where <code>nginx</code> is the path to the located OpenResty installation):</p>

<pre class="highlight lang_bash"><code><span class="sh_default">$</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">nginx</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_keyword">-p</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_string">&quot;$(pwd)&quot;</span><span class="sh_operator">/</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_keyword">-c</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_string">&quot;nginx.conf.compiled&quot;</span></code>
</pre>


<h4><a name="command-reference/lapis-server/cqueues-server" href="#command-reference/lapis-server/cqueues-server">Cqueues Server</a></h4>

<p>When using Cqueues &amp; lua-http, no additional processes are created. Your server
is started directly inside of the Lapis command. After reading the
configuration model it will attempt to load a module called <code>app</code> to serve.</p>

<h3><a name="command-reference/lapis-migrate" href="#command-reference/lapis-migrate"><code>lapis migrate</code></a></h3>

<pre><code>Usage: lapis migrate [-h] [--migrations-module &lt;module&gt;]
       [&lt;environment&gt;] [--transaction [{global,individual}]]

Run any outstanding migrations

Arguments:
   environment

Options:
   -h, --help            Show this help message and exit.
   --migrations-module &lt;module&gt;
                         Module to load for migrations (default: migrations)
   --transaction [{global,individual}]
</code></pre>

<p>This will run any outstanding migrations. The migrations table if it does not
exist yet. A database must be configured in the environment for this command to
work.</p>

<p>This command expects a <code>migrations</code> module as described in <a href="database.html#database-migrations/running-migrations">Running
Migrations</a>. The module
loaded can be overwritten with the <code>--migrations-module</code> flag.</p>

<p>It executes on the server approximately this code:</p>

<p><div class="dual_code">
<div class="dual_code_tabs">
        <button type="button" data-lang="lua" class="set_language">Lua</button>
        <button type="button" data-lang="moonscript" class="set_language">MoonScript</button>
      </div>
<pre class="highlight lang_lua"><code><span class="sh_keyword">local</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_identifier">migrations</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_operator">=</span><span class="sh_lua_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;migrations&quot;</span><span class="sh_operator">)</span><span class="sh_lua_whitespace sh_whitespace">
</span><span class="sh_function">require</span><span class="sh_operator">(</span><span class="sh_string">&quot;lapis.db.migrations&quot;</span><span class="sh_operator">).</span><span class="sh_identifier">run_migrations</span><span class="sh_operator">(</span><span class="sh_identifier">migrations</span><span class="sh_operator">)</span></code>
</pre>
<pre class="highlight lang_moon"><code><span class="sh_keyword">import</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_identifier">run_migrations</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_keyword">from</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;lapis.db.migrations&quot;</span><span class="sh_moonscript_whitespace sh_whitespace">
</span><span class="sh_identifier">run_migrations</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_function">require</span><span class="sh_moonscript_whitespace sh_whitespace"> </span><span class="sh_string">&quot;migrations&quot;</span></code>
</pre>
</div>

</p>

<p>You can instruct the migrations to be run in a transaction by providng the
<code>--transaction</code> flag.</p>

<p>To wrap each individual migration in a transaction use:
<code>--transaction=individual</code></p>

<h3><a name="command-reference/lapis-build" href="#command-reference/lapis-build"><code>lapis build</code></a></h3>

<pre class="highlight lang_bash"><code><span class="sh_default">$</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">lapis</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_identifier">build</span><span class="sh_bash_whitespace sh_whitespace"> </span><span class="sh_operator">[</span><span class="sh_identifier">environment</span><span class="sh_operator">]</span></code>
</pre>


<blockquote><p>This command is only available for OpenResty</p></blockquote>

<p>Rebuilds the config. If the server is currently running then a <code>HUP</code> signal
will be sent to it. This causes the configuration to be reloaded. By default
Nginx does not see changes to the config file while it is running. By executing
<code>lapis build</code> you will tell Nginx to reload the config without having to
restart the server.</p>

<p>As a side effect all the Nginx workers are restarted, so your application code
is also reloaded.</p>

<p>This is the best approach when deploying a new version of your code to
production. You'll be able to reload everything without dropping any requests.</p>

<p>You can read more in the <a href="http://wiki.nginx.org/CommandLine#Loading_a_New_Configuration_Using_Signals">Nginx manual</a>.</p>

<h3><a name="command-reference/lapis-term" href="#command-reference/lapis-term"><code>lapis term</code></a></h3>

<blockquote><p>This command is only available for OpenResty</p></blockquote>

<p>This will shut down a running server. This is useful if you've instructed Lapis
to start Nginx as a daemon. If you are running the server in the foreground you
can stop it using Ctrl-C.</p>

<p>It works by sending a TERM signal to the Nginx master process.</p>

      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Mon Jan  9 21:58:43 2023"></script>
  <script type="text/javascript" src="../reference.js?Mon Jan  9 21:58:43 2023"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
