<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Models - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Tue Nov  1 01:18:49 2022" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.10.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="moonscript">MoonScript</span>
          <span class="lang_toggle" data-lang="lua">Lua</span>
        </div>

        
          <div class="nav_links">
            <h2>Contents</h2>
            <ul><li><a href="#primary-keys">Primary Keys</a></li>
<li><a href="#class-methods">Class Methods</a></li>
<ul><li><a href="#class-methods/find"><code>find(...)</code></a></li>
<li><a href="#class-methods/select"><code>select(query, ...)</code></a></li>
<li><a href="#class-methods/find_all"><code>find_all(primary_keys)</code></a></li>
<li><a href="#class-methods/count"><code>count(clause, ...)</code></a></li>
<li><a href="#class-methods/create"><code>create(values, create_opts=nil)</code></a></li>
<li><a href="#class-methods/columns"><code>columns()</code></a></li>
<li><a href="#class-methods/table_name"><code>table_name()</code></a></li>
<li><a href="#class-methods/singular_name"><code>singular_name()</code></a></li>
<li><a href="#class-methods/include_in"><code>include_in(objects, key, opts={})</code></a></li>
<li><a href="#class-methods/paginated"><code>paginated(query, ...)</code></a></li></ul>
<li><a href="#instance-methods">Instance Methods</a></li>
<ul><li><a href="#instance-methods/update"><code>update(..., opts={})</code></a></li>
<li><a href="#instance-methods/delete"><code>delete()</code></a></li>
<li><a href="#instance-methods/refresh"><code>refresh(...)</code></a></li></ul>
<li><a href="#timestamps">Timestamps</a></li>
<li><a href="#constraints">Constraints</a></li>
<li><a href="#pagination">Pagination</a></li>
<ul><li><a href="#pagination/get_page"><code>get_page(page_num)</code></a></li>
<li><a href="#pagination/num_pages"><code>num_pages()</code></a></li>
<li><a href="#pagination/total_items"><code>total_items()</code></a></li>
<li><a href="#pagination/each_page"><code>each_page(starting_page=1)</code></a></li>
<li><a href="#pagination/each_item"><code>each_item()</code></a></li>
<li><a href="#pagination/has_items"><code>has_items()</code></a></li>
<li><a href="#pagination/get_all"><code>get_all()</code></a></li></ul>
<li><a href="#ordered-paginator">Ordered Paginator</a></li>
<ul><li><a href="#ordered-paginator/pagination-order">Pagination order</a></li>
<li><a href="#ordered-paginator/composite-ordering">Composite ordering</a></li></ul>
<li><a href="#relations">Relations</a></li>
<ul><li><a href="#relations/belongs-to"><code>belongs_to</code></a></li>
<li><a href="#relations/has-one"><code>has_one</code></a></li>
<li><a href="#relations/has-many"><code>has_many</code></a></li>
<li><a href="#relations/fetch"><code>fetch</code></a></li>
<li><a href="#relations/polymorphic-belongs-to"><code>polymorphic_belongs_to</code></a></li>
<ul><li><a href="#relations/polymorphic-belongs-to/migrating-for-a-new-polymorphic-relation">Migrating for a New Polymorphic Relation</a></li></ul></ul>
<li><a href="#preloading-relations">Preloading relations</a></li>
<ul><li><a href="#preloading-relations/preload"><code>preload(instances, relations...)</code></a></li>
<li><a href="#preloading-relations/preload_relation"><code>Model:preload_relation(instances, name, ...)</code></a></li>
<li><a href="#preloading-relations/preload_relations"><code>Model:preload_relations(instances, names...)</code></a></li></ul>
<li><a href="#enum">Enum</a></li></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><h1>Models</h1>

<p>Lapis provides a <code>Model</code> base class for making Lua tables that can be
synchronized with a database row. The class is used to represent a single
database table, an instance of the class is used to represent a single row of
that table.</p>

<p>The most primitive model is a blank model:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span></code>
</pre>


<p class="for_lua">
The first argument to <code>extend</code> is the name of the table to associate
the model to.
</p>


<p class="for_moon">
The name of the class is used to determine the name of the table. In this case
the class name <code>Users</code> represents the table <code>users</code>. A
class name of <code>HelloWorlds</code> would result in the table name
<code>hello_worlds</code>. It is customary to make the class name plural.
</p>


<p>Model instances will have a field for each column that has been fetched from
the database. You do not need to manually specify the names of the columns.  If
you have any relationships, though, you can specify them using the
<a href="#relations"><code>relations</code> property</a>.</p>

<h2><a name="primary-keys" href="#primary-keys">Primary Keys</a></h2>

<p>By default all models expect the table to have a primary key called<code>"id"</code>. This
can be changed by setting the <span class="for_moon"><code>@primary_key</code></span><span
class="for_lua"><code>self.primary_key</code></span> class variable.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">primary_key</span> <span class="o">=</span> <span class="s2">&quot;login&quot;</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@primary_key</span><span class="o">:</span> <span class="s2">&quot;</span><span class="s">login</span><span class="s2">&quot;</span></code>
</pre>


<p>If there are multiple primary keys then an array table can be used:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Followings</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;followings&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">primary_key</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;followed_user_id&quot;</span> <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">class</span> <span class="nc">Followings</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@primary_key</span><span class="o">:</span> <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">user_id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">followed_user_id</span><span class="s2">&quot;</span> <span class="kt">}</span></code>
</pre>


<p>A unique primary key is needed for every row in order to <code>update</code> and <code>delete</code>
rows without affecting other rows unintentially.</p>

<h2><a name="class-methods" href="#class-methods">Class Methods</a></h2>

<p>Model class methods are used for fetching existing rows, creating new ones, or
fetching data about the underlying table.</p>

<p>For the following examples assume we have the following models:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">)</span>

<span class="kd">local</span> <span class="n">Tags</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">primary_key</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;tag&quot;</span><span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span>

<span class="k">class</span> <span class="nc">Tags</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@primary_key</span><span class="o">:</span> <span class="kt">{</span><span class="s2">&quot;</span><span class="s">user_id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">tag</span><span class="s2">&quot;</span><span class="kt">}</span></code>
</pre>


<h3><a name="class-methods/find" href="#class-methods/find"><code>find(...)</code></a></h3>

<p>The <code>find</code> class method fetches a single row from the table by some condition.
Pass the values of the primary keys you want to look up by in the order
specified by the <code>primary_keys</code> assigned in the Model&rsquo;s class.</p>

<blockquote><p>A model without user defined primary keys has the primary key of <code>id</code> by
default. For those models, <code>find</code> would take one argument, the value of <code>id</code>.</p></blockquote>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="mi">23232</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">Tags</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="mi">1234</span><span class="p">,</span> <span class="s2">&quot;programmer&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">user</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">find</span> <span class="mi">23232</span>
<span class="n">tag</span> <span class="o">=</span> <span class="nc">Tags</span><span class="o">\</span><span class="n">find</span> <span class="mi">1234</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">programmer</span><span class="s2">&quot;</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;users&quot;</span> <span class="k">where</span> <span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="mi">23232</span> <span class="k">limit</span> <span class="mi">1</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;tags&quot;</span> <span class="k">where</span> <span class="ss">&quot;user_id&quot;</span> <span class="o">=</span> <span class="mi">1234</span> <span class="k">and</span> <span class="ss">&quot;tag&quot;</span> <span class="o">=</span> <span class="s1">&#39;programmer&#39;</span> <span class="k">limit</span> <span class="mi">1</span></code>
</pre>


<p><code>find</code> returns an instance of the model if it could be found, <code>nil</code> otherwise.</p>

<p>An alternate way of calling find is to pass a table as the first argument. The
table will be converted to a <code>WHERE</code> clause in the query:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">find</span><span class="p">({</span> <span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;person@example.com&quot;</span> <span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">user</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">find</span> <span class="nv">email:</span> <span class="s2">&quot;</span><span class="s">person@example.com</span><span class="s2">&quot;</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;users&quot;</span> <span class="k">where</span> <span class="ss">&quot;email&quot;</span> <span class="o">=</span> <span class="s1">&#39;person@example.com&#39;</span> <span class="k">limit</span> <span class="mi">1</span></code>
</pre>


<p>Like all database finders, you are free to use <code>db.raw</code> to embed raw SQL. For
example, you might perform a case insensitive email search like so:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">find</span><span class="p">({</span> <span class="p">[</span><span class="n">db</span><span class="p">.</span><span class="n">raw</span><span class="p">(</span><span class="s2">&quot;lower(email)&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">some_email</span><span class="p">:</span><span class="n">lower</span><span class="p">()</span> <span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">user</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">find</span> <span class="kt">[</span><span class="n">db</span><span class="o">.</span><span class="n">raw</span> <span class="s2">&quot;</span><span class="s">lower(email)</span><span class="s2">&quot;</span><span class="kt">]</span><span class="o">:</span> <span class="n">some_email</span><span class="o">\</span><span class="n">lower</span><span class="o">!</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;users&quot;</span> <span class="k">where</span> <span class="k">lower</span><span class="p">(</span><span class="n">email</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;person@example.com&#39;</span> <span class="k">limit</span> <span class="mi">1</span></code>
</pre>


<h3><a name="class-methods/select" href="#class-methods/select"><code>select(query, ...)</code></a></h3>

<p>When searching for multiple rows the <code>select</code> class method is used. It works
similarly to the <a href="database.html#query-interface-selectquery-params"><code>select</code> function from the raw query
interface</a> except you specify
the part of the query after the list of columns to select.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">Tags</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="s2">&quot;where tag = ?&quot;</span><span class="p">,</span> <span class="s2">&quot;merchant&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">tags</span> <span class="o">=</span> <span class="nc">Tags</span><span class="o">\</span><span class="nb">select</span> <span class="s2">&quot;</span><span class="s">where tag = ?</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">merchant</span><span class="s2">&quot;</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;tags&quot;</span> <span class="k">where</span> <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;merchant&#39;</span></code>
</pre>


<p>Instead of a single instance, an array table of instances is returned. If there
are no matching rows an empty table is returned.</p>

<p>If you want to restrict which columns are selected, you can pass in a table as
the last argument with the <code>fields</code> key set:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">Tags</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="s2">&quot;where tag = ?&quot;</span><span class="p">,</span> <span class="s2">&quot;merchant&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">fields</span> <span class="o">=</span> <span class="s2">&quot;created_at as c&quot;</span> <span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">tags</span> <span class="o">=</span> <span class="nc">Tags</span><span class="o">\</span><span class="nb">select</span> <span class="s2">&quot;</span><span class="s">where tag = ?</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">merchant</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">fields:</span> <span class="s2">&quot;</span><span class="s">created_at as c</span><span class="s2">&quot;</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="n">created_at</span> <span class="k">as</span> <span class="k">c</span> <span class="k">from</span> <span class="ss">&quot;tags&quot;</span> <span class="k">where</span> <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;merchant&#39;</span></code>
</pre>


<p>The <code>fields</code> option is inserted into the SQL statement as is, so do not use
untrusted strings otherwise you may be vulnerable to SQL injection. Use
<a href="database.html#query-interface/escape_identifier"><code>db.escape_identifier</code></a> to
escape column names.</p>

<p>You can use the <code>load</code> option to change what model each result of the query is
loaded as. By default it will convert each row to an instance of the model that
is calling the <code>select</code> method. Passing <code>false</code> to load will return the results
unaffected, as plain Lua tables.</p>

<h3><a name="class-methods/find_all" href="#class-methods/find_all"><code>find_all(primary_keys)</code></a></h3>

<p>If you want to find many rows by their primary key you can use the <code>find_all</code>
method. It takes an array table of primary keys. This method only works on
tables that have singular primary keys unless you explicitly pass a column to
search by.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">users</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">find_all</span><span class="p">({</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span> <span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">users</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">find_all</span> <span class="kt">{</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span> <span class="kt">}</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;users&quot;</span> <span class="k">where</span> <span class="ss">&quot;id&quot;</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span></code>
</pre>


<p>If you need to find many rows for another column other than the primary key you
can pass in the optional second argument:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">users</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="p">:</span><span class="n">find_all</span><span class="p">({</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span> <span class="p">},</span> <span class="s2">&quot;user_id&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">users</span> <span class="o">=</span> <span class="nc">UserProfile</span><span class="o">\</span><span class="n">find_all</span> <span class="kt">{</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span> <span class="kt">}</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">user_id</span><span class="s2">&quot;</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;UserProfile&quot;</span> <span class="k">where</span> <span class="ss">&quot;user_id&quot;</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span></code>
</pre>


<p>The second argument can also be a table of options. The following properties
are supported:</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default</td></tr></thead><tbody><tr><td><code>key</code></td><td><p>Specify the column name to find by, same effect as passing in a string as the second argument. The column name will be escaped with <code>db.escape_literal</code>.</p>
</td><td><p>the table&rsquo;s primary key</p>
</td></tr><tr><td><code>fields</code></td><td><p>A string of raw SQL inserted directly after the <code>SELECT</code> portion of the query. Use this to control what fields are returned</p>
</td><td><p><code>*</code></p>
</td></tr><tr><td><code>where</code></td><td><p>A table of additional <code>where</code> clauses for the query</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>clause</code></td><td><p>A raw SQL fragment to append to query either as string, or array table of arguments to be passed to <code>db.interpolate_query</code></p>
</td><td><em class="default_value"><code>nil</code></em></td></tr></tbody></table></p>

<p>For example:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">users</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="p">:</span><span class="n">find_all</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">},</span> <span class="p">{</span>
  <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span>
  <span class="n">fields</span> <span class="o">=</span> <span class="s2">&quot;user_id, twitter_account&quot;</span><span class="p">,</span>
  <span class="n">where</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">public</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">users</span> <span class="o">=</span> <span class="nc">UserProfile</span><span class="o">\</span><span class="n">find_all</span> <span class="kt">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="kt">}</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">key:</span> <span class="s2">&quot;</span><span class="s">user_id</span><span class="s2">&quot;</span>
  <span class="nv">fields:</span> <span class="s2">&quot;</span><span class="s">user_id, twitter_account</span><span class="s2">&quot;</span>
  <span class="nv">where:</span> <span class="kt">{</span>
    <span class="nv">public:</span> <span class="kc">true</span>
  <span class="kt">}</span>
<span class="kt">}</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">twitter_account</span> <span class="k">from</span> <span class="ss">&quot;things&quot;</span> <span class="k">where</span> <span class="ss">&quot;user_id&quot;</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="k">and</span> <span class="ss">&quot;public&quot;</span> <span class="o">=</span> <span class="k">TRUE</span></code>
</pre>


<h3><a name="class-methods/count" href="#class-methods/count"><code>count(clause, ...)</code></a></h3>

<p>Counts the number of records in the table that match the clause.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">total</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">count</span><span class="p">()</span>
<span class="kd">local</span> <span class="n">count</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;username like &#39;%&#39; || ? || &#39;%&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;leafo&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">total</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">count</span><span class="o">!</span>
<span class="n">count</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">count</span> <span class="s2">&quot;</span><span class="s">username like &#39;%&#39; || ? || &#39;%&#39;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">leafo</span><span class="s2">&quot;</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="ss">&quot;users&quot;</span>
<span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="ss">&quot;users&quot;</span> <span class="k">where</span> <span class="n">username</span> <span class="k">like</span> <span class="s1">&#39;%&#39;</span> <span class="o">||</span> <span class="s1">&#39;leafo&#39;</span> <span class="o">||</span> <span class="s1">&#39;%&#39;</span></code>
</pre>


<h3><a name="class-methods/create" href="#class-methods/create"><code>create(values, create_opts=nil)</code></a></h3>

<p>The <code>create</code> class method is used to create new rows. It takes a table of
column values to create the row with. It returns an instance of the model. The
create query fetches the values of the primary keys and sets them on the
instance using the PostgreSQL <code>RETURNING</code> statement. This is useful for getting
the value of an auto-incrementing key from the insert statement.</p>

<blockquote><p>In MySQL the <em>last insert id</em> is used to get the id of the row since the
<code>RETURNING</code> statement is not available.</p></blockquote>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">create</span><span class="p">({</span>
  <span class="n">login</span> <span class="o">=</span> <span class="s2">&quot;superuser&quot;</span><span class="p">,</span>
  <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;1234&quot;</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">user</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">create</span> <span class="kt">{</span>
  <span class="nv">login:</span> <span class="s2">&quot;</span><span class="s">superuser</span><span class="s2">&quot;</span>
  <span class="nv">password:</span> <span class="s2">&quot;</span><span class="s">1234</span><span class="s2">&quot;</span>
<span class="kt">}</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;users&quot;</span> <span class="p">(</span><span class="ss">&quot;password&quot;</span><span class="p">,</span> <span class="ss">&quot;login&quot;</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;1234&#39;</span><span class="p">,</span> <span class="s1">&#39;superuser&#39;</span><span class="p">)</span> <span class="n">RETURNING</span> <span class="ss">&quot;id&quot;</span></code>
</pre>


<p>If any of the column values are
<a href="database.html#query-interface-rawstr"><code>db.raw</code></a> then their computed values
will also be fetched using the <code>RETURN</code> clause of the <code>CREATE</code> statement. The
raw values are replaced by the values returned by the database.</p>

<p>For example, we might create a new row in a table with a <code>position</code> column set
to the next highest number:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">create</span><span class="p">({</span>
  <span class="n">position</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">raw</span><span class="p">(</span><span class="s2">&quot;(select coalesce(max(position) + 1, 0) from users)&quot;</span><span class="p">)</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">user</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">create</span> <span class="kt">{</span>
  <span class="nv">position:</span> <span class="n">db</span><span class="o">.</span><span class="n">raw</span> <span class="s2">&quot;</span><span class="s">(select coalesce(max(position) + 1, 0) from users)</span><span class="s2">&quot;</span>
<span class="kt">}</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;users&quot;</span> <span class="p">(</span><span class="k">position</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">((</span><span class="k">select</span> <span class="n">coalesce</span><span class="p">(</span><span class="k">max</span><span class="p">(</span><span class="k">position</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">from</span> <span class="n">users</span><span class="p">))</span>
<span class="n">RETURNING</span> <span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;position&quot;</span></code>
</pre>


<blockquote><p>Since <code>RETURNING</code> is not available in MySQL, this functionality is PostgreSQL
specific.</p></blockquote>

<p>If your model has any <a href="#constraints">constraints</a> they will be checked before trying to create
a new row. If a constraint fails then <code>nil</code> and the error message are returned
from the <code>create</code> function.</p>

<p><code>create_opts</code> is an optional table supporting the following fields:</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default</td></tr></thead><tbody><tr><td><code>returning</code></td><td><p>An array table of column names or the string <code>"*"</code> to represent all column names. Their values will be return from the insertion query using <code>RETURNING</code> clause to initially populate the model object</p>
<details class="option_example"><summary>Show Example</summary><pre class="highlight lang_lua"><code><span></span><span class="n">Users</span><span class="p">:</span><span class="n">create</span><span class="p">({</span>
  <span class="n">profile_color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="n">returning</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="nc">Users</span><span class="o">\</span><span class="n">create</span> <span class="kt">{</span>
  <span class="nv">profile_color:</span> <span class="s2">&quot;</span><span class="s">blue</span><span class="s2">&quot;</span>
<span class="kt">}</span><span class="p">,</span> <span class="nv">returning:</span> <span class="s2">&quot;</span><span class="s">*</span><span class="s2">&quot;</span></code>
</pre>

</details></td><td><p>Automatically calculated to include any columns that have <code>db.raw</code> values, and the primary keys</p>
</td></tr></tbody></table></p>

<h3><a name="class-methods/columns" href="#class-methods/columns"><code>columns()</code></a></h3>

<p>Returns all the columns on the table. Returns an array of tables that contain
column names and their types.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">columns</span><span class="p">()</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">cols</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">columns</span><span class="o">!</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="k">column_name</span><span class="p">,</span> <span class="n">data_type</span>
  <span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span> <span class="k">WHERE</span> <span class="k">table_name</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span></code>
</pre>


<p>The output might look like this:</p>

<pre class="highlight lang_lua"><code><span></span><span class="p">{</span>
  <span class="p">{</span>
    <span class="n">data_type</span> <span class="o">=</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span>
    <span class="n">column_name</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="n">data_type</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
    <span class="n">column_name</span> <span class="o">=</span> <span class="s2">&quot;name&quot;</span>
  <span class="p">}</span>
<span class="p">}</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="kt">{</span>
  <span class="kt">{</span>
    <span class="nv">data_type:</span> <span class="s2">&quot;</span><span class="s">integer</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="nv">column_name:</span> <span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span>
  <span class="kt">}</span>
  <span class="kt">{</span>
    <span class="nv">data_type:</span> <span class="s2">&quot;</span><span class="s">text</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="nv">column_name:</span> <span class="s2">&quot;</span><span class="s">name</span><span class="s2">&quot;</span>
  <span class="kt">}</span>
<span class="kt">}</span></code>
</pre>


<blockquote><p>MySQL will return a slightly different format, but will contain the same information.</p></blockquote>

<h3><a name="class-methods/table_name" href="#class-methods/table_name"><code>table_name()</code></a></h3>

<p>Returns the name of the table backed by the model.</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">):</span><span class="n">table_name</span><span class="p">()</span> <span class="c1">--&gt; &quot;users&quot;</span>
<span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;user_posts&quot;</span><span class="p">):</span><span class="n">table_name</span><span class="p">()</span> <span class="c1">--&gt; &quot;user_posts&quot;</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="kt">(</span><span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span><span class="kt">)</span><span class="o">\</span><span class="n">table_name</span><span class="o">!</span> <span class="c1">--&gt; &quot;users&quot;</span>
<span class="kt">(</span><span class="k">class</span> <span class="nc">UserPosts</span> <span class="k">extends</span> <span class="nc">Model</span><span class="kt">)</span><span class="o">\</span><span class="n">table_name</span><span class="o">!</span> <span class="c1">--&gt; &quot;user_posts&quot;</span></code>
</pre>


<p class="for_moon">
This class method can be overridden to change what table a model uses:
</p>


<pre class="highlight lang_moon"><code><span></span><span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@table_name</span><span class="o">:</span> <span class="nf">=&gt;</span> <span class="s2">&quot;</span><span class="s">active_users</span><span class="s2">&quot;</span></code>
</pre>


<h3><a name="class-methods/singular_name" href="#class-methods/singular_name"><code>singular_name()</code></a></h3>

<p>Returns the singular name of the table.</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">):</span><span class="n">singular_name</span><span class="p">()</span> <span class="c1">--&gt; &quot;user&quot;</span>
<span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;user_posts&quot;</span><span class="p">):</span><span class="n">singular_name</span><span class="p">()</span> <span class="c1">--&gt; &quot;user_post&quot;</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="kt">(</span><span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span><span class="kt">)</span><span class="o">\</span><span class="n">singular_name</span><span class="o">!</span> <span class="c1">--&gt; &quot;user&quot;</span>
<span class="kt">(</span><span class="k">class</span> <span class="nc">UserPosts</span> <span class="k">extends</span> <span class="nc">Model</span><span class="kt">)</span><span class="o">\</span><span class="n">singular_name</span><span class="o">!</span> <span class="c1">--&gt; &quot;user_post&quot;</span></code>
</pre>


<p>The singular name is used internally by Lapis when calculating what the name of
the field is when loading rows with <code>include_in</code>. It&rsquo;s also used when
determining the foreign key column name with a <code>has_one</code> or <code>has_many</code>
relation.</p>

<h3><a name="class-methods/include_in" href="#class-methods/include_in"><code>include_in(objects, key, opts={})</code></a></h3>

<p>Bulk load rows of the model into an array of objects (often the array of
objects is an array of instances of another model). This is used to preload
associations in a single query in order to avoid the <a href="https://leafo.net/guides/postgresql-preloading.html">n+1 queries
problem</a>.</p>

<p>It works my mutating the objects in the array by inserting a new field into
each item where the query returned a result. The name of this new field is
either derived from the model&rsquo;s table name, or manually specified via an
option.</p>

<p>Returns the <code>objects</code> array table.</p>

<p>This is a lower level interface for preloading data on models. In general we
recommend <a href="#relations">using relations</a> if possible. A relation
will internally generate a call to <code>include_in</code> based on how you have
configured the relation.</p>

<p>The <code>key</code> argument controls the mapping from the fields in each object of the
objects array to the column name used in the query. It can be a string, an
array of strings, or a string<em>(column)</em> → string<em>(field)</em> table mapping. When
using a string or array of strings then the corresponding associated key is
automatically chosen.</p>

<p>Possible values for <code>key</code> argument:</p>

<ul>
<li><strong>string</strong> &mdash; for each object, the value <code>object[key]</code> is used to lookup instances of the model by the model&rsquo;s primary key. The model is assumed to have a singular primary key, and will error otherwise

<ul>
<li>with <code>flip</code> enabled: <code>key</code> is used as the foreign key column name, and <code>object[opts.local_key or "id"]</code> is used to pull the values</li>
</ul>
</li>
<li><strong>array of string</strong> &mdash; for each object, a composite key is created by individually mapping each field of the key array via <code>object[key]</code> to the composite primary key of the model</li>
<li><strong>column mapping table</strong> &mdash; explicitly specify the mapping of fields to columns. The <em>key</em> of the table will be used as the column name, and the value in the table will be used as the field name referenced from the <code>objects</code> argument</li>
</ul>


<p><code>include_in</code> supports the following options (via the optional <code>opts</code> argument):</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default</td></tr></thead><tbody><tr><td><code>as</code></td><td><p>The name of the field the loaded associated model is stored into</p>
</td><td><p>generated from table name (eg. <code>Posts</code> → <code>post</code>)</p>
</td></tr><tr><td><code>where</code></td><td><p>A table of additional conditionals to limit the query by</p>
<details class="option_example"><summary>Show Example</summary><pre class="highlight lang_lua"><code><span></span><span class="n">Users</span><span class="p">:</span><span class="n">include_in</span><span class="p">(</span><span class="n">posts</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">where</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">deleted</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="nc">Users</span><span class="o">\</span><span class="n">include_in</span> <span class="n">posts</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">user_id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">where:</span> <span class="kt">{</span>
    <span class="nv">deleted:</span> <span class="kc">false</span>
  <span class="kt">}</span>
<span class="kt">}</span></code>
</pre>

</details></td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>fields</code></td><td><p>Raw SQL fragment to control which columns are returned by the query. <code>db.escape_identifier</code> can be used to sanitize column names</p>
<details class="option_example"><summary>Show Example</summary><pre class="highlight lang_lua"><code><span></span><span class="n">Users</span><span class="p">:</span><span class="n">include_in</span><span class="p">(</span><span class="n">posts</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">fields</span> <span class="o">=</span> <span class="s2">&quot;id, name as display_name, created_at&quot;</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="nc">Users</span><span class="o">\</span><span class="n">include_in</span> <span class="n">posts</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">user_id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">fields:</span> <span class="s2">&quot;</span><span class="s">id, name as display_name, created_at</span><span class="s2">&quot;</span>
<span class="kt">}</span></code>
</pre>

</details></td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>many</code></td><td><p>set to <code>true</code> to fetch many records for each input model instance. The fetched models will be stored as an array on each preloaded object. An empty array is assigned when no rows are found</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>value</code></td><td><p>a function called for each fetched row where the return value is used in place of the row object when filling <code>objects</code></p>
</td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>order</code></td><td><p>the order of items when preloading a <code>many</code> preload. Taken as a raw SQL clause</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>group</code></td><td><p>group by clause. Taken as a raw SQL clause</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>flip</code></td><td><p><strong><em>(deprecated)</em></strong> Flips the use of the <code>key</code> argument (when a string), to be the column name instead of the field name. <code>flip</code> can not be used with an array or table <code>key</code> argument</p>
</td><td><p><code>false</code></p>
</td></tr><tr><td><code>local_key</code></td><td><p><strong><em>(deprecated)</em></strong> only appropriate when <code>flip</code> is true. The name of the field to use when pulling primary keys from <code>objects</code></p>
</td><td><p><code>"id"</code></p>
</td></tr></tbody></table></p>

<blockquote><p><code>flip</code> &amp; <code>local_key</code> are deprecated and will be removed in a future version of Lapis. You
should opt to use the column mapping table instead of <code>flip</code> or <code>local_key</code>
options.</p></blockquote>

<p><details class="aside">
<summary>How to migrate away from <code>flip</code> and <code>local_key</code></summary></p>

<p>Flip is confusing, and is deprecated and will be removed. These examples show
replacement calls to <code>include_in</code> that do not use flip.</p>

<p>The following are equivalent:</p>

<p><pre class="highlight lang_lua"><code><span></span><span class="n">UserData</span><span class="p">:</span><span class="n">include_in</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">flip</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">})</span>
<span class="n">UserData</span><span class="p">:</span><span class="n">include_in</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">user_id</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="nc">UserData</span><span class="o">\</span><span class="n">include_in</span> <span class="n">users</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">user_id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">flip:</span> <span class="kc">true</span>
<span class="nc">UserData</span><span class="o">\</span><span class="n">include_in</span> <span class="n">users</span><span class="p">,</span> <span class="nv">user_id:</span> <span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span></code>
</pre>

</p>

<p>The following use <code>local_key</code> and are equivalent:</p>

<p><pre class="highlight lang_lua"><code><span></span><span class="n">UserData</span><span class="p">:</span><span class="n">include_in</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">flip</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
  <span class="n">local_key</span> <span class="o">=</span> <span class="s2">&quot;internal_id&quot;</span>
<span class="p">})</span>
<span class="n">UserData</span><span class="p">:</span><span class="n">include_in</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">user_id</span> <span class="o">=</span> <span class="s2">&quot;internal_id&quot;</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="nc">UserData</span><span class="o">\</span><span class="n">include_in</span> <span class="n">users</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">user_id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">flip:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">local_key:</span> <span class="s2">&quot;</span><span class="s">internal_id</span><span class="s2">&quot;</span>
<span class="nc">UserData</span><span class="o">\</span><span class="n">include_in</span> <span class="n">users</span><span class="p">,</span> <span class="nv">user_id:</span> <span class="s2">&quot;</span><span class="s">internal_id</span><span class="s2">&quot;</span></code>
</pre>

</p>

<p>An easy way to think about the column mapping table is as a <code>where</code> clause
table but instead of having literal values you specify the name of the field
that is pulled from the array of objects.
</details></p>

<p>In order to demonstrate <code>include_in</code> we'll need some models: (The columns are
annotated in a comment above the model).</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="c1">-- table with columns: id, name</span>
<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">)</span>

<span class="c1">-- table with columns: id, user_id, text_content</span>
<span class="kd">local</span> <span class="n">Posts</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;posts&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>

<span class="c1">-- table with columns: id, name</span>
<span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span>

<span class="c1">-- table with columns: id, user_id, text_content</span>
<span class="k">class</span> <span class="nc">Posts</span> <span class="k">extends</span> <span class="nc">Model</span></code>
</pre>


<p>Given all the posts, we want to find the user for each post. <code>include_in</code> can
be called on the model we wish to load, <code>Users</code>, with the array of model
instances we want to fill: <code>posts</code>. The second argument is the name of the
foreign key on the array of model instances that points to the rows we are
preloading. By default, the value of the foreign key is mapped to the primary
key of the model that is being loaded.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">posts</span> <span class="o">=</span> <span class="n">Posts</span><span class="p">:</span><span class="nb">select</span><span class="p">()</span> <span class="c1">-- this gets all the posts</span>
<span class="n">Users</span><span class="p">:</span><span class="n">include_in</span><span class="p">(</span><span class="n">posts</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">posts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="c1">-- print the fetched data</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">posts</span> <span class="o">=</span> <span class="nc">Posts</span><span class="o">\</span><span class="nb">select</span><span class="o">!</span> <span class="c1">-- this gets all the posts</span>

<span class="nc">Users</span><span class="o">\</span><span class="n">include_in</span> <span class="n">posts</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">user_id</span><span class="s2">&quot;</span>

<span class="nb">print</span> <span class="n">posts</span><span class="kt">[</span><span class="mi">1</span><span class="kt">]</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="c1">-- print the fetched data</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;posts&quot;</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;users&quot;</span> <span class="k">where</span> <span class="ss">&quot;id&quot;</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span></code>
</pre>


<p>The name of the inserted property is derived from the name of the foreign key.
In this case, <code>user</code> was derived from the foreign key <code>user_id</code>. If we want to
manually specify the name the <code>as</code> option can be used:</p>

<p><pre class="highlight lang_lua"><code><span></span><span class="n">Users</span><span class="p">:</span><span class="n">include_in</span><span class="p">(</span><span class="n">posts</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">as</span> <span class="o">=</span> <span class="s2">&quot;author&quot;</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="nc">Users</span><span class="o">\</span><span class="n">include_in</span> <span class="n">posts</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">user_id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">as:</span> <span class="s2">&quot;</span><span class="s">author</span><span class="s2">&quot;</span></code>
</pre>

</p>

<p>Now all the posts will contain a property named <code>author</code> with an instance of
the <code>Users</code> model.</p>

<p>In this next example a column mapping table is used to explicitly specify what
fields in our object array match to the columns in our query. Here are the
relevant models:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="c1">-- table with columns: id, name</span>
<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">)</span>

<span class="c1">-- table with columns: user_id, twitter_account, facebook_username</span>
<span class="kd">local</span> <span class="n">UserData</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;user_data&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>

<span class="c1">-- columns: id, name</span>
<span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span>

<span class="c1">-- columns: user_id, twitter_account, facebook_username</span>
<span class="k">class</span> <span class="nc">UserData</span> <span class="k">extends</span> <span class="nc">Model</span></code>
</pre>


<p>Now let&rsquo;s say we have an array of users and we want to fetch the associated
user data.</p>

<p><pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">users</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="nb">select</span><span class="p">()</span>
<span class="n">UserData</span><span class="p">:</span><span class="n">include_in</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">user_id</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span>
<span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">user_data</span><span class="p">.</span><span class="n">twitter_account</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">users</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="nb">select</span><span class="o">!</span>
<span class="nc">UserData</span><span class="o">\</span><span class="n">include_in</span> <span class="n">users</span><span class="p">,</span> <span class="nv">user_id:</span> <span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span>

<span class="nb">print</span> <span class="n">users</span><span class="kt">[</span><span class="mi">1</span><span class="kt">]</span><span class="o">.</span><span class="n">user_data</span><span class="o">.</span><span class="n">twitter_account</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;user_data&quot;</span> <span class="k">where</span> <span class="ss">&quot;user_id&quot;</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span></code>
</pre>


<p>The second argument of <code>include_in</code>, called <code>key</code>, is a table with the value <code>{
"user_id" = "id"}</code>. This instructs <code>include_in</code> to take all the values stored
in the <code>id</code> field from the users array to use as values to look up rows in
<code>user_data</code> table by the <code>user_id</code> column.</p>

<p>The field name that is used to store each result in the users array is derived
from the name of the included table. In this case, <code>UserData</code> →  <code>user_data</code>.
This can be overridden by using the <code>as</code> option.</p>

<blockquote><p>The table name is converted to English singular form. Since user_data is both
singular and plural, it&rsquo;s used as is.</p></blockquote>

<p>One last common scenario is preloading a one-to-many relationship. You can use
the <code>many</code> option to instruct <code>include_in</code> to collect all associated results
for each input object into an array. (The derived field name will be plural)</p>

<p>For example, we might load all the posts for each user:</p>

<p><pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">users</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="nb">select</span><span class="p">()</span>
<span class="n">Posts</span><span class="p">:</span><span class="n">include_in</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">user_id</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="n">many</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">users</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="nb">select</span><span class="o">!</span>
<span class="nc">Posts</span><span class="o">\</span><span class="n">include_in</span> <span class="n">users</span><span class="p">,</span> <span class="kt">{</span> <span class="nv">user_id:</span> <span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span> <span class="kt">}</span><span class="p">,</span> <span class="nv">many:</span> <span class="kc">true</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;posts&quot;</span> <span class="k">where</span> <span class="ss">&quot;user_id&quot;</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span></code>
</pre>


<p>Each <code>users</code> object will now have a <code>posts</code> field that is an array containing
all the associated posts that were found. (Note that <code>posts</code> is a plural
derived field name when <code>many</code> is true.)</p>

<h3><a name="class-methods/paginated" href="#class-methods/paginated"><code>paginated(query, ...)</code></a></h3>

<p>Similar to <code>select</code> but returns a <code>Paginator</code>. Read more in <a href="#pagination">Pagination</a>.</p>

<h2><a name="instance-methods" href="#instance-methods">Instance Methods</a></h2>

<h3><a name="instance-methods/update" href="#instance-methods/update"><code>update(..., opts={})</code></a></h3>

<p>Generate and issue a query to update the row backed by the instance of the
model. The values of the primary keys specified by the model&rsquo;s class are used
to uniquely identify the row for updating.</p>

<p>This method returns two values:</p>

<ol>
<li><code>true</code> or <code>false</code> if the query was able to update a row successfully
(Generally this will always return <code>true</code> unless the row has been deleted from
the database before the update was issued, or a conditional update is being used)</li>
<li>The result object from the <code>db.update</code> function that is called internally</li>
</ol>


<blockquote><p>The second return value is always a table with the result object, which is
incompatible with <code>assert</code> when trying to throw an error if the update didn&rsquo;t
take place</p></blockquote>

<p>The arguments to this method come in two forms:</p>

<ol>
<li>Update table</li>
<li>Field name list</li>
</ol>


<p>In the first form we simply pass a table mapping column names to the updated
values. The values in the table will be merged into the instance of the model
to reflect the update:</p>

<p><pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">user</span><span class="p">:</span><span class="n">update</span><span class="p">({</span>
  <span class="n">login</span> <span class="o">=</span> <span class="s2">&quot;uberuser&quot;</span><span class="p">,</span>
  <span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;admin@example.com&quot;</span>
<span class="p">})</span>
<span class="nb">assert</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">login</span> <span class="o">==</span> <span class="s2">&quot;uberuser&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">user</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">find</span> <span class="mi">1</span>
<span class="n">user</span><span class="o">\</span><span class="n">update</span> <span class="kt">{</span>
  <span class="nv">login:</span> <span class="s2">&quot;</span><span class="s">uberuser</span><span class="s2">&quot;</span>
  <span class="nv">email:</span> <span class="s2">&quot;</span><span class="s">admin@example.com</span><span class="s2">&quot;</span>
<span class="kt">}</span>

<span class="c1">-- both the database row and model instance will have the updated value:</span>
<span class="nb">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">login</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">uberuser</span><span class="s2">&quot;</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">UPDATE</span> <span class="ss">&quot;users&quot;</span> <span class="k">SET</span> <span class="ss">&quot;login&quot;</span> <span class="o">=</span> <span class="s1">&#39;uberuser&#39;</span><span class="p">,</span> <span class="ss">&quot;email&quot;</span> <span class="o">=</span> <span class="s1">&#39;admin@example.com&#39;</span> <span class="k">WHERE</span> <span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="mi">1</span></code>
</pre>


<p>The second form takes a list of field or column names to synchronize from the
model instance to the database. With this approach first edit the model
instance with updated values, then issue the <code>update</code> call to save the changes:</p>

<p><pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="n">login</span> <span class="o">=</span> <span class="s2">&quot;uberuser&quot;</span>
<span class="n">user</span><span class="p">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;admin@example.com&quot;</span>
<span class="n">user</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">user</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">find</span> <span class="mi">1</span>
<span class="n">user</span><span class="o">.</span><span class="n">login</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">uberuser</span><span class="s2">&quot;</span>
<span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">admin@example.com</span><span class="s2">&quot;</span>

<span class="n">user</span><span class="o">\</span><span class="n">update</span> <span class="s2">&quot;</span><span class="s">login</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">email</span><span class="s2">&quot;</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">UPDATE</span> <span class="ss">&quot;users&quot;</span> <span class="k">SET</span> <span class="ss">&quot;login&quot;</span> <span class="o">=</span> <span class="s1">&#39;uberuser&#39;</span><span class="p">,</span> <span class="ss">&quot;email&quot;</span> <span class="o">=</span> <span class="s1">&#39;admin@example.com&#39;</span> <span class="k">WHERE</span> <span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="mi">1</span></code>
</pre>


<blockquote><p>You can also pass in an array of field names via a table as the first
argument to the update method. The two forms can be used together with a
table as the first argument</p></blockquote>

<p>If any of values used for the update are SQL fragments generated by something
like <code>db.raw</code>, then a <code>RETURNING</code> clause will be used to determine the final
value from the database to store on the model instance, similar to the
<a href="#class-methods-createopts"><code>create</code> class method</a>.</p>

<p><pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">crate</span><span class="p">({</span>
  <span class="n">id</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
  <span class="n">views</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">})</span>
<span class="n">user</span><span class="p">:</span><span class="n">update</span><span class="p">({</span>
  <span class="n">views</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">raw</span><span class="p">(</span><span class="s2">&quot;views + 12&quot;</span><span class="p">)</span>
<span class="p">})</span>
<span class="nb">assert</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">user</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">crate</span> <span class="kt">{</span>
  <span class="nv">id:</span> <span class="mi">10</span>
  <span class="nv">views:</span> <span class="mi">1</span>
<span class="kt">}</span>

<span class="n">user</span><span class="o">\</span><span class="n">update</span> <span class="kt">{</span>
  <span class="nv">views:</span> <span class="n">db</span><span class="o">.</span><span class="n">raw</span> <span class="s2">&quot;</span><span class="s">views + 12</span><span class="s2">&quot;</span>
<span class="kt">}</span>

<span class="c1">-- the result of the query is assigned to the model:</span>
<span class="nb">assert</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">13</span></code>
</pre>

</p>

<p><strong>Options</strong></p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default</td></tr></thead><tbody><tr><td><code>timestamp</code></td><td><p>The <code>updated_at</code> field will be updated to the current time if the model has timestamps. Note that if the update itself contains <code>updated_at</code> then that will take precedence over the auto-update.</p>
<details class="option_example"><summary>Show Example</summary><pre class="highlight lang_lua"><code><span></span><span class="n">user</span><span class="p">:</span><span class="n">update</span><span class="p">({</span>
  <span class="n">views_count</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">raw</span><span class="p">(</span><span class="s2">&quot;views_count + 1&quot;</span><span class="p">)</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">user</span><span class="o">\</span><span class="n">update</span> <span class="kt">{</span>
  <span class="nv">views_count:</span> <span class="n">db</span><span class="o">.</span><span class="n">raw</span> <span class="s2">&quot;</span><span class="s">views_count + 1</span><span class="s2">&quot;</span>
<span class="kt">}</span><span class="p">,</span> <span class="nv">timestamp:</span> <span class="kc">false</span></code>
</pre>

</details></td><td><p><code>true</code></p>
</td></tr><tr><td><code>where</code></td><td><p>A table of additional conditions to add to the <code>WHERE</code> clause of the updated query. This can be used to have an atomic conditional update. The return value should be checked to see if the update succeeeded or not.</p>
<details class="option_example"><summary>Show Example</summary><pre class="highlight lang_lua"><code><span></span><span class="n">user</span><span class="p">:</span><span class="n">update</span><span class="p">({</span>
  <span class="n">views_count</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">raw</span><span class="p">(</span><span class="s2">&quot;views_count + 1&quot;</span><span class="p">)</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="n">where</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">public</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">user</span><span class="o">\</span><span class="n">update</span> <span class="kt">{</span>
  <span class="nv">views_count:</span> <span class="n">db</span><span class="o">.</span><span class="n">raw</span> <span class="s2">&quot;</span><span class="s">views_count + 1</span><span class="s2">&quot;</span>
<span class="kt">}</span><span class="p">,</span> <span class="nv">where:</span> <span class="kt">{</span> <span class="nv">public:</span> <span class="kc">true</span> <span class="kt">}</span></code>
</pre>

</details></td><td><p><code>nil</code></p>
</td></tr></tbody></table></p>

<h3><a name="instance-methods/delete" href="#instance-methods/delete"><code>delete()</code></a></h3>

<p>Attempts to delete the row backed by the model instance based on the primary
key.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">user</span><span class="p">:</span><span class="n">delete</span><span class="p">()</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">user</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">find</span> <span class="mi">1</span>
<span class="n">user</span><span class="o">\</span><span class="n">delete</span><span class="o">!</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">DELETE</span> <span class="k">FROM</span> <span class="ss">&quot;users&quot;</span> <span class="k">WHERE</span> <span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="mi">1</span></code>
</pre>


<p><code>delete</code> will return <code>true</code> if the row was actually deleted. It&rsquo;s important to
check this value to avoid any race conditions when running code in response to a
delete.</p>

<p>Consider the following code:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">find</span><span class="p">()</span>

<span class="c1">-- Wrong:</span>
<span class="kr">if</span> <span class="n">user</span> <span class="kr">then</span>
  <span class="n">user</span><span class="p">:</span><span class="n">delete</span><span class="p">()</span>
  <span class="n">decrement_total_user_count</span><span class="p">()</span>
<span class="kr">end</span>

<span class="c1">-- Correct:</span>
<span class="kr">if</span> <span class="n">user</span> <span class="kr">then</span>
  <span class="kr">if</span> <span class="n">user</span><span class="p">:</span><span class="n">delete</span><span class="p">()</span> <span class="kr">then</span>
    <span class="n">decrement_total_user_count</span><span class="p">()</span>
  <span class="kr">end</span>
<span class="kr">end</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">user</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">find</span> <span class="mi">1</span>

<span class="c1">-- Wrong:</span>
<span class="k">if</span> <span class="n">user</span>
  <span class="n">user</span><span class="o">\</span><span class="n">delete</span><span class="o">!</span>
  <span class="n">decrement_total_user_count</span><span class="o">!</span>

<span class="c1">-- Correct:</span>
<span class="k">if</span> <span class="n">user</span>
  <span class="k">if</span> <span class="n">user</span><span class="o">\</span><span class="n">delete</span><span class="o">!</span>
    <span class="n">decrement_total_user_count</span><span class="o">!</span></code>
</pre>


<p>Due to the asynchronous nature of OpenResty, it&rsquo;s possible that if two requests
enter this block of code around the same time <code>delete</code> may end up getting called
twice. This isn&rsquo;t a problem by itself, but the <code>decrement_total_user_count</code>
function would get called twice and may invalidate whatever data it has.</p>

<h3><a name="instance-methods/refresh" href="#instance-methods/refresh"><code>refresh(...)</code></a></h3>

<p>Updates the values of the fields on the instance from the database.</p>

<p>If your model instance becomes out of date from an external change, use the
<code>refresh</code> method to re-fetch and re-populate its data.</p>

<p>If the row now longer exists in the database, then <code>refresh</code> will throw an
error.</p>

<pre class="highlight lang_moon"><code><span></span><span class="k">class</span> <span class="nc">Posts</span> <span class="k">extends</span> <span class="nc">Model</span>
<span class="n">post</span> <span class="o">=</span> <span class="nc">Posts</span><span class="o">\</span><span class="n">find</span> <span class="mi">1</span>
<span class="n">post</span><span class="o">\</span><span class="n">refresh</span><span class="o">!</span></code>
</pre>


<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Posts</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;posts&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">post</span> <span class="o">=</span> <span class="n">Posts</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">post</span><span class="p">:</span><span class="n">refresh</span><span class="p">()</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;posts&quot;</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span></code>
</pre>


<p>By default all fields are refreshed. If you only want to refresh specific fields
then pass them in as arguments:</p>

<pre class="highlight lang_moon"><code><span></span><span class="k">class</span> <span class="nc">Posts</span> <span class="k">extends</span> <span class="nc">Model</span>
<span class="n">post</span> <span class="o">=</span> <span class="nc">Posts</span><span class="o">\</span><span class="n">find</span> <span class="mi">1</span>
<span class="n">post</span><span class="o">\</span><span class="n">refresh</span> <span class="s2">&quot;</span><span class="s">color</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">height</span><span class="s2">&quot;</span></code>
</pre>


<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Posts</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;posts&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">post</span> <span class="o">=</span> <span class="n">Posts</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">post</span><span class="p">:</span><span class="n">refresh</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="ss">&quot;color&quot;</span><span class="p">,</span> <span class="ss">&quot;height&quot;</span> <span class="k">from</span> <span class="ss">&quot;posts&quot;</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span></code>
</pre>


<h2><a name="timestamps" href="#timestamps">Timestamps</a></h2>

<p>Because it&rsquo;s common to store creation and update times, models have
support for managing these columns automatically.</p>

<p>When creating your table make sure your table has the following columns:</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="p">...</span> <span class="p">(</span>
  <span class="p">...</span>
  <span class="ss">&quot;created_at&quot;</span> <span class="k">timestamp</span> <span class="k">without</span> <span class="n">time</span> <span class="k">zone</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="ss">&quot;updated_at&quot;</span> <span class="k">timestamp</span> <span class="k">without</span> <span class="n">time</span> <span class="k">zone</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">)</span></code>
</pre>


<p>You might create a table with timestamps using the schema syntax from Lapis
like this:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">schema</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;lapis.db.schema&quot;</span>

<span class="n">scehma</span><span class="p">.</span><span class="n">create_table</span><span class="p">(</span><span class="s2">&quot;some_table&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="c1">-- ...</span>
  <span class="p">{</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="n">schema</span><span class="p">.</span><span class="n">types</span><span class="p">.</span><span class="n">time</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;updated_at&quot;</span><span class="p">,</span> <span class="n">schema</span><span class="p">.</span><span class="n">types</span><span class="p">.</span><span class="n">time</span><span class="p">}</span>
  <span class="c1">-- ...</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">types</span><span class="p">,</span> <span class="n">create_table</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.schema</span><span class="s2">&quot;</span>

<span class="n">create_table</span> <span class="s2">&quot;</span><span class="s">some_table</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="c1">-- ...</span>
  <span class="kt">{</span><span class="s2">&quot;</span><span class="s">created_at</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">time</span><span class="kt">}</span>
  <span class="kt">{</span><span class="s2">&quot;</span><span class="s">updated_at</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">time</span><span class="kt">}</span>
  <span class="c1">-- ...</span>
<span class="kt">}</span></code>
</pre>


<p>You'll notice both columns are stored without timezone. Lapis stored
<code>created_at</code> and <code>updated_at</code> in UTC time.</p>

<p>Then define your model with the <span class="for_moon"><code>@timestamp</code> class
variable</span><span class="for_lua"><code>timestamp</code> property</span> set to
true:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@timestamp</span><span class="o">:</span> <span class="kc">true</span></code>
</pre>


<p>Whenever <code>create</code> and <code>update</code> are called the appropriate timestamp column will
also be set.</p>

<p>You can disable the timestamp from being updated on an <code>update</code> by passing a
final table argument setting <span class="for_moon"><code>timestamp:
false</code></span><span class="for_lua"><code>timestamp = false</code></span>:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">})</span>

<span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">-- first form</span>
<span class="n">user</span><span class="p">:</span><span class="n">update</span><span class="p">({</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;hello world&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">})</span>


<span class="c1">-- second form</span>
<span class="n">user</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;hello world&quot;</span>
<span class="n">user</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">123</span>
<span class="n">user</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">false</span><span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@timestamp</span><span class="o">:</span> <span class="kc">true</span>

<span class="n">user</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">find</span> <span class="mi">1</span>

<span class="c1">-- first form</span>
<span class="n">user</span><span class="o">\</span><span class="n">update</span> <span class="kt">{</span> <span class="nv">name:</span> <span class="s2">&quot;</span><span class="s">hello world</span><span class="s2">&quot;</span> <span class="kt">}</span><span class="p">,</span> <span class="kt">{</span> <span class="nv">timestamp:</span> <span class="kc">false</span> <span class="kt">}</span>

<span class="c1">-- second form</span>
<span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">hello world</span><span class="s2">&quot;</span>
<span class="n">user</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">123</span>
<span class="n">user</span><span class="o">\</span><span class="n">update</span> <span class="s2">&quot;</span><span class="s">name</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">age</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">timestamp:</span> <span class="kc">false</span></code>
</pre>


<h2><a name="constraints" href="#constraints">Constraints</a></h2>

<p>Often before we insert or update a row we want to check that some conditions
are met. In Lapis these are called constraints. For example let&rsquo;s say we have a
user model and users are not allowed to have the name &ldquo;admin&rdquo;.</p>

<p>We might define it like this:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">name</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
      <span class="kr">if</span> <span class="n">value</span><span class="p">:</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;admin&quot;</span> <span class="kr">then</span>
        <span class="kr">return</span> <span class="s2">&quot;User can not be named admin&quot;</span>
      <span class="kr">end</span>
    <span class="kr">end</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="nb">assert</span><span class="p">(</span><span class="n">Users</span><span class="p">:</span><span class="n">create</span><span class="p">({</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Admin&quot;</span>
<span class="p">}))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@constraints</span><span class="o">:</span> <span class="kt">{</span>
    <span class="nv">name:</span> <span class="kt">(</span><span class="n">value</span><span class="kt">)</span> <span class="nf">=&gt;</span>
      <span class="k">if</span> <span class="n">value</span><span class="o">\</span><span class="n">lower</span><span class="o">!</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">admin</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="s">User can not be named admin</span><span class="s2">&quot;</span>
  <span class="kt">}</span>


<span class="nb">assert</span> <span class="nc">Users</span><span class="o">\</span><span class="n">create</span> <span class="kt">{</span>
  <span class="nv">name:</span> <span class="s2">&quot;</span><span class="s">Admin</span><span class="s2">&quot;</span>
<span class="kt">}</span></code>
</pre>


<p>The <span class="for_moon"><code>@constraints</code> class variable</span><span class="for_lua"><code>constraints</code> property</span> is a table that maps column name to a
function that should check if the constraint is broken. If anything truthy is
returned from the function then the update/insert fails, and that is returned
as the error message.</p>

<p>In the example above, the call to <code>assert</code> will fail with the error <code>"User can
not be named admin"</code>.</p>

<p>The constraint check function is passed 4 arguments. The model class, the value
of the column being checked, the name of the column being checked, and lastly
the object being checked. On insertion the object is the table passed to the
create method. On update the object is the instance of the model.</p>

<h2><a name="pagination" href="#pagination">Pagination</a></h2>

<p>Using the <code>paginated</code> method on models we can easily paginate through a query
that might otherwise return many results. The arguments are the same as the
<code>select</code> method but instead of the result it returns a special <code>Paginator</code>
object.</p>

<p>For example, say we have the following table and model: (See <a href="database.html#database-schemas">Database Schemas</a> for more information on creating tables.)</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">create_table</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">types</span><span class="p">.</span><span class="n">serial</span> <span class="p">},</span>
  <span class="p">{</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">types</span><span class="p">.</span><span class="n">varchar</span> <span class="p">},</span>
  <span class="p">{</span> <span class="s2">&quot;group_id&quot;</span><span class="p">,</span> <span class="n">types</span><span class="p">.</span><span class="n">foreign_key</span> <span class="p">},</span>

  <span class="s2">&quot;PRIMARY KEY(id)&quot;</span>
<span class="p">})</span>

<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">create_table</span> <span class="s2">&quot;</span><span class="s">users</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">serial</span> <span class="kt">}</span>
  <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">name</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">varchar</span> <span class="kt">}</span>
  <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">group_id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">foreign_key</span> <span class="kt">}</span>

  <span class="s2">&quot;</span><span class="s">PRIMARY KEY(id)</span><span class="s2">&quot;</span>
<span class="kt">}</span>

<span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span></code>
</pre>


<p>We can create a paginator like so:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">paginated</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">paginated</span><span class="p">(</span><span class="s2">&quot;where group_id = ? order by name asc&quot;</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">paginated</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">paginated</span> <span class="s">[[where group_id = ? order by name asc]]</span><span class="p">,</span> <span class="mi">123</span></code>
</pre>


<p>The type of paginator created by the <code>paginated</code> class method is an
<code>OffsetPaginator</code>. This paginator uses <code>LIMIT</code> and <code>OFFSET</code> query clauses to
fetch pages. There is also an <code>OrderedPaginator</code> which is described below. It
can provide significantly increased performance for larger datasets given the
right indexes and circumstances are met.</p>

<blockquote><p>Always provide an <code>ORDER BY</code> clause when using a paginator or the pages
returned by the paginator may not be consistent.</p></blockquote>

<p>A paginator can be configured by passing a table as the last argument. The
following options are available for all types of paginators:</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default</td></tr></thead><tbody><tr><td><code>per_page</code></td><td><p>The number of items fetched per page</p>
<details class="option_example"><summary>Show Example</summary><pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">pager</span> <span class="o">=</span> <span class="n">Users</span><span class="p">:</span><span class="n">paginated</span><span class="p">(</span><span class="s2">&quot;where group_id = ?&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">per_page</span> <span class="o">=</span> <span class="mi">100</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">pager</span> <span class="o">=</span> <span class="nc">Users</span><span class="o">\</span><span class="n">paginated</span> <span class="s2">&quot;</span><span class="s">where group_id = ?</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="nv">per_page:</span> <span class="mi">100</span></code>
</pre>

</details></td><td><p><code>10</code></p>
</td></tr><tr><td><code>prepare_results</code></td><td><p>A function that is passed the results of any fetched page to prepare the objects before being retuned from methods like <code>get_page</code>, <code>get_all</code>, and <code>each_item</code>. It should return the results after they have been prepared or updated.</p>

<p>This is useful for preloading related data automatically when fetching results to avoid the <a href="https://leafo.net/guides/postgresql-preloading.html">n+1 queries problem</a>.</p>
<details class="option_example"><summary>Show Example</summary><pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">items</span> <span class="o">=</span> <span class="n">Posts</span><span class="p">:</span><span class="n">paginated</span><span class="p">(</span><span class="s2">&quot;where category = ?&quot;</span><span class="p">,</span> <span class="s2">&quot;big_cats&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">per_page</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
  <span class="n">prepare_results</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">posts</span><span class="p">)</span>
    <span class="n">Users</span><span class="p">:</span><span class="n">include_in</span><span class="p">(</span><span class="n">posts</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">)</span>
    <span class="kr">return</span> <span class="n">posts</span>
  <span class="kr">end</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">items</span> <span class="o">=</span> <span class="nc">Posts</span><span class="o">\</span><span class="n">paginated</span> <span class="s2">&quot;</span><span class="s">where category = ?</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">big_cats</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">per_page:</span> <span class="mi">10</span>
  <span class="nv">prepare_results:</span> <span class="kt">(</span><span class="n">posts</span><span class="kt">)</span> <span class="nf">-&gt;</span>
    <span class="nc">Users</span><span class="o">\</span><span class="n">include_in</span> <span class="n">posts</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">user_id</span><span class="s2">&quot;</span>
    <span class="n">posts</span>
<span class="kt">}</span></code>
</pre>

</details></td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><em>…</em></td><td><p>Any additional options are passed directly to the <code>select</code> class method to control the query. For example, <code>fields</code> can be used to restrict what columns are fetched</p>
</td><td></td></tr></tbody></table></p>

<p>A paginator has the following methods:</p>

<h3><a name="pagination/get_page" href="#pagination/get_page"><code>get_page(page_num)</code></a></h3>

<p>Gets <code>page_num</code>th page, where pages are 1 indexed. The number of items per page
is controlled by the <code>per_page</code> option, and defaults to 10. Returns an array
table of model instances.</p>

<p><pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">page1</span> <span class="o">=</span> <span class="n">paginated</span><span class="p">:</span><span class="n">get_page</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">page6</span> <span class="o">=</span> <span class="n">paginated</span><span class="p">:</span><span class="n">get_page</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">page1</span> <span class="o">=</span> <span class="n">paginated</span><span class="o">\</span><span class="n">get_page</span> <span class="mi">1</span>
<span class="n">page6</span> <span class="o">=</span> <span class="n">paginated</span><span class="o">\</span><span class="n">get_page</span> <span class="mi">6</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;users&quot;</span> <span class="k">where</span> <span class="n">group_id</span> <span class="o">=</span> <span class="mi">123</span> <span class="k">order</span> <span class="k">by</span> <span class="n">name</span> <span class="k">asc</span> <span class="k">limit</span> <span class="mi">10</span> <span class="k">offset</span> <span class="mi">0</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;users&quot;</span> <span class="k">where</span> <span class="n">group_id</span> <span class="o">=</span> <span class="mi">123</span> <span class="k">order</span> <span class="k">by</span> <span class="n">name</span> <span class="k">asc</span> <span class="k">limit</span> <span class="mi">10</span> <span class="k">offset</span> <span class="mi">50</span></code>
</pre>


<blockquote><p>The OrderedPaginator fetches pages in a fundamentally different way, see
below for more information.</p></blockquote>

<h3><a name="pagination/num_pages" href="#pagination/num_pages"><code>num_pages()</code></a></h3>

<p>Returns the total number of pages.</p>

<h3><a name="pagination/total_items" href="#pagination/total_items"><code>total_items()</code></a></h3>

<p>Gets the total number of items that can be returned. The paginator will parse
the query and remove all clauses except for the <code>WHERE</code> when issuing a <code>COUNT</code>.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">users</span> <span class="o">=</span> <span class="n">paginated</span><span class="p">:</span><span class="n">total_items</span><span class="p">()</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">users</span> <span class="o">=</span> <span class="n">paginated</span><span class="o">\</span><span class="n">total_items</span><span class="o">!</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="k">c</span> <span class="k">from</span> <span class="ss">&quot;users&quot;</span> <span class="k">where</span> <span class="n">group_id</span> <span class="o">=</span> <span class="mi">123</span></code>
</pre>


<h3><a name="pagination/each_page" href="#pagination/each_page"><code>each_page(starting_page=1)</code></a></h3>

<p>Returns an iterator function that can be used to iterate through each page of
the results. Useful for processing a large query without having the entire
result set loaded in memory at once.</p>

<p>Each item is preloaded with the <code>prepare_results</code> function if provided.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kr">for</span> <span class="n">page_results</span><span class="p">,</span> <span class="n">page_num</span> <span class="kr">in</span> <span class="n">paginated</span><span class="p">:</span><span class="n">each_page</span><span class="p">()</span> <span class="kr">do</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">page_results</span><span class="p">,</span> <span class="n">page_num</span><span class="p">)</span>
<span class="kr">end</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">for</span> <span class="n">page_results</span><span class="p">,</span> <span class="n">page_num</span> <span class="k">in</span> <span class="n">paginated</span><span class="o">\</span><span class="n">each_page</span><span class="o">!</span>
  <span class="nb">print</span><span class="kt">(</span><span class="n">page_results</span><span class="p">,</span> <span class="n">page_num</span><span class="kt">)</span></code>
</pre>


<blockquote><p>Be careful modifying rows in the database when iterating over each page, as
your modifications might change the query result order and you may process
rows multiple times or none at all. Consider using a stable sorting
direction like the primary key ascending.</p></blockquote>

<h3><a name="pagination/each_item" href="#pagination/each_item"><code>each_item()</code></a></h3>

<p>Returns an iterator for every item retuned by the pager. It uses <code>each_page</code> to
fetch results in chunks of <code>per_page</code> items. Because data is pulled
incrementally it&rsquo;s suitable for iterating over large data sets.</p>

<p>Each item is preloaded with the <code>prepare_results</code> function if provided.</p>

<blockquote><p>Iteration order can change if the table is modified during iteration, see the
warning on <code>each_page</code>.</p></blockquote>

<p><pre class="highlight lang_lua"><code><span></span><span class="kr">for</span> <span class="n">item</span> <span class="kr">in</span> <span class="n">pager</span><span class="p">:</span><span class="n">each_item</span><span class="p">()</span> <span class="kr">do</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
<span class="kr">end</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="n">pager</span><span class="o">\</span><span class="n">each_item</span><span class="o">!</span>
  <span class="nb">print</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span></code>
</pre>

</p>

<h3><a name="pagination/has_items" href="#pagination/has_items"><code>has_items()</code></a></h3>

<p>Checks to see if the paginator returns at least 1 item. Returns a boolean. This is
more efficient than counting the items and checking for a number greater than 0
because the query generated by this function doesn&rsquo;t do any counting.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kr">if</span> <span class="n">pager</span><span class="p">:</span><span class="n">has_items</span><span class="p">()</span> <span class="kr">then</span>
  <span class="c1">-- ...</span>
<span class="kr">end</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">if</span> <span class="n">pager</span><span class="o">\</span><span class="n">has_items</span><span class="o">!</span>
  <span class="n">do_something</span><span class="o">!</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="mi">1</span> <span class="k">FROM</span> <span class="ss">&quot;users&quot;</span> <span class="k">where</span> <span class="n">group_id</span> <span class="o">=</span> <span class="mi">123</span> <span class="k">limit</span> <span class="mi">1</span></code>
</pre>


<h3><a name="pagination/get_all" href="#pagination/get_all"><code>get_all()</code></a></h3>

<p>Gets every item from the paginator by issuing a single query, ignoring any pagination options.
If you have a large dataset you want to iterate over, consider using
<code>each_item</code> as it will query in chunks to reduce peak memory usage.</p>

<p>Each item is preloaded with the <code>prepare_results</code> function if provided.</p>

<p><pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">users</span> <span class="o">=</span> <span class="n">paginated</span><span class="p">:</span><span class="n">get_all</span><span class="p">()</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">users</span> <span class="o">=</span> <span class="n">paginated</span><span class="o">\</span><span class="n">get_all</span><span class="o">!</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;users&quot;</span> <span class="k">where</span> <span class="n">group_id</span> <span class="o">=</span> <span class="mi">123</span> <span class="k">order</span> <span class="k">by</span> <span class="n">name</span> <span class="k">asc</span></code>
</pre>


<h2><a name="ordered-paginator" href="#ordered-paginator">Ordered Paginator</a></h2>

<p>The default paginator, also know as the <code>OffsetPaginator</code>, uses <code>LIMIT</code> and
<code>OFFSET</code> to handle fetching pages. For large data sets, this can become
inefficient for viewing later pages since the database has to scan past all the
preceding rows when handling the offset.</p>

<p>An alternative way to handling pagination is using a <code>WHERE</code> clause along with
an <code>ORDER</code> and <code>LIMIT</code>. If the right index is on the table then the database
can skip directly to the rows that should be contained in the page.</p>

<p>With this method you don&rsquo;t get page numbers, but instead must keep track of the
last index of the previous page. This is best represented with a <em>load more</em>
button on your site.</p>

<p>The <code>OrderedPaginator</code> class is a subclass of the <code>Paginator</code> that uses this
method to paginate results.</p>

<p>Here&rsquo;s an example model:</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">create_table</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">types</span><span class="p">.</span><span class="n">serial</span> <span class="p">},</span>
  <span class="p">{</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">types</span><span class="p">.</span><span class="n">foreign_key</span> <span class="p">},</span>
  <span class="p">{</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">types</span><span class="p">.</span><span class="n">text</span> <span class="p">},</span>

  <span class="s2">&quot;PRIMARY KEY(id)&quot;</span>
<span class="p">})</span>

<span class="kd">local</span> <span class="n">Events</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">create_table</span> <span class="s2">&quot;</span><span class="s">events</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">serial</span> <span class="kt">}</span>
  <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">user_id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">foreign_key</span> <span class="kt">}</span>
  <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">data</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">text</span> <span class="kt">}</span>

  <span class="s2">&quot;</span><span class="s">PRIMARY KEY(id)</span><span class="s2">&quot;</span>
<span class="kt">}</span>

<span class="k">class</span> <span class="nc">Events</span> <span class="k">extends</span> <span class="nc">Model</span></code>
</pre>


<p>Here&rsquo;s how to instantiate an ordered paginator that can iterate over the <code>events</code>
table for a specific user id, in ascending order:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">OrderedPaginator</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.pagination&quot;</span><span class="p">).</span><span class="n">OrderedPaginator</span>
<span class="kd">local</span> <span class="n">pager</span> <span class="o">=</span> <span class="n">OrderedPaginator</span><span class="p">(</span><span class="n">Events</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;where user_id = ?&quot;</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">per_page</span> <span class="o">=</span> <span class="mi">50</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">OrderedPaginator</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.pagination</span><span class="s2">&quot;</span>
<span class="n">pager</span> <span class="o">=</span> <span class="nc">OrderedPaginator</span> <span class="nc">Events</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">where user_id = ?</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">per_page:</span> <span class="mi">50</span>
<span class="kt">}</span></code>
</pre>


<p>The <code>OrderedPaginator</code> constructor function matches the same interface as the
regular <code>Paginator</code> except it takes an additional argument after the model name:
the name of the column(s) to order by.</p>

<p>Call <code>get_page</code> with no arguments to get the first page of results. In addition
to the results of the query, the addition arguments contain the values that
should be passed to get page to get the next page of results.</p>

<pre class="highlight lang_lua"><code><span></span><span class="c1">-- get the first page</span>
<span class="kd">local</span> <span class="n">results</span><span class="p">,</span> <span class="n">next_page</span> <span class="o">=</span> <span class="n">pager</span><span class="p">:</span><span class="n">get_page</span><span class="p">()</span>

<span class="c1">-- get the next page</span>
<span class="kd">local</span> <span class="n">results_2</span><span class="p">,</span> <span class="n">next_page</span> <span class="o">=</span> <span class="n">pager</span><span class="p">:</span><span class="n">get_page</span><span class="p">(</span><span class="n">next_page</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="c1">-- get the first page</span>
<span class="n">results</span><span class="p">,</span> <span class="n">next_page</span> <span class="o">=</span> <span class="n">pager</span><span class="o">\</span><span class="n">get_page</span><span class="o">!</span>

<span class="c1">-- get the next page</span>
<span class="n">results_2</span><span class="p">,</span> <span class="n">next_page</span> <span class="o">=</span> <span class="n">pager</span><span class="o">\</span><span class="n">get_page</span> <span class="n">next_page</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;events&quot;</span> <span class="k">where</span> <span class="n">user_id</span> <span class="o">=</span> <span class="mi">123</span> <span class="k">order</span> <span class="k">by</span> <span class="ss">&quot;events&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="k">ASC</span> <span class="k">limit</span> <span class="mi">50</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;events&quot;</span> <span class="k">where</span> <span class="ss">&quot;events&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="o">&gt;</span> <span class="mi">4832</span> <span class="k">and</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="mi">123</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="ss">&quot;events&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="k">ASC</span> <span class="k">limit</span> <span class="mi">50</span></code>
</pre>


<h3><a name="ordered-paginator/pagination-order" href="#ordered-paginator/pagination-order">Pagination order</a></h3>

<p>The pagination order can be specified by the <code>order</code> field in the options
table. The default is <code>asc</code>.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">OrderedPaginator</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.pagination&quot;</span><span class="p">).</span><span class="n">OrderedPaginator</span>
<span class="kd">local</span> <span class="n">pager</span> <span class="o">=</span> <span class="n">OrderedPaginator</span><span class="p">(</span><span class="n">Events</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;where user_id = ?&quot;</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">order</span> <span class="o">=</span> <span class="s2">&quot;desc&quot;</span><span class="p">,</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">OrderedPaginator</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.pagination</span><span class="s2">&quot;</span>
<span class="n">pager</span> <span class="o">=</span> <span class="nc">OrderedPaginator</span> <span class="nc">Events</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">where user_id = ?</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">order:</span> <span class="s2">&quot;</span><span class="s">desc</span><span class="s2">&quot;</span>
<span class="kt">}</span></code>
</pre>


<p>This will affect any calls to <code>get_page</code> on the paginator.</p>

<p>Additionally, the <code>after</code> and <code>before</code> methods on the paginator let you fetch
results in a specific order. They both share the same interface as <code>get_page</code>,
but <code>after</code> will always fetch ascending, and <code>before</code> will always fetch
descending.</p>

<h3><a name="ordered-paginator/composite-ordering" href="#ordered-paginator/composite-ordering">Composite ordering</a></h3>

<p>If you have a model that has a composite sorting key (made up of more than one
column), you can pass a table array as the ordering column:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">OrderedPaginator</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.pagination&quot;</span><span class="p">).</span><span class="n">OrderedPaginator</span>
<span class="kd">local</span> <span class="n">pager</span> <span class="o">=</span> <span class="n">OrderedPaginator</span><span class="p">(</span><span class="n">SomeModel</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;post_id&quot;</span><span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">OrderedPaginator</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.pagination</span><span class="s2">&quot;</span>
<span class="n">pager</span> <span class="o">=</span> <span class="nc">OrderedPaginator</span> <span class="nc">SomeModel</span><span class="p">,</span> <span class="kt">{</span><span class="s2">&quot;</span><span class="s">user_id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">post_id</span><span class="s2">&quot;</span><span class="kt">}</span></code>
</pre>


<p>The <code>get_page</code> method on the paginator takes as many arguments as there are
columns. Additionally, it will return that many additional values after the
results to be passed on as the next page</p>

<pre class="highlight lang_lua"><code><span></span><span class="c1">-- get the first page</span>
<span class="kd">local</span> <span class="n">results</span><span class="p">,</span> <span class="n">last_user_id</span><span class="p">,</span> <span class="n">last_post_id</span> <span class="o">=</span> <span class="n">pager</span><span class="p">:</span><span class="n">get_page</span><span class="p">()</span>

<span class="c1">-- get the next page</span>
<span class="kd">local</span> <span class="n">results_2</span> <span class="o">=</span> <span class="n">pager</span><span class="p">:</span><span class="n">get_page</span><span class="p">(</span><span class="n">last_user_id</span><span class="p">,</span> <span class="n">last_post_id</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="c1">-- get the first page</span>
<span class="n">results</span><span class="p">,</span> <span class="n">last_user_id</span><span class="p">,</span> <span class="n">last_post_id</span> <span class="o">=</span> <span class="n">pager</span><span class="o">\</span><span class="n">get_page</span><span class="o">!</span>

<span class="c1">-- get the next page</span>
<span class="n">results_2</span> <span class="o">=</span> <span class="n">pager</span><span class="o">\</span><span class="n">get_page</span> <span class="n">last_user_id</span><span class="p">,</span> <span class="n">last_post_id</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;some_model&quot;</span>
  <span class="k">order</span> <span class="k">by</span> <span class="ss">&quot;some_model&quot;</span><span class="p">.</span><span class="ss">&quot;user_id&quot;</span> <span class="k">ASC</span><span class="p">,</span> <span class="ss">&quot;some_model&quot;</span><span class="p">.</span><span class="ss">&quot;post_id&quot;</span> <span class="k">ASC</span> <span class="k">limit</span> <span class="mi">10</span>

<span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;some_model&quot;</span> <span class="k">where</span>
  <span class="p">(</span><span class="ss">&quot;some_model&quot;</span><span class="p">.</span><span class="ss">&quot;user_id&quot;</span><span class="p">,</span> <span class="ss">&quot;some_model&quot;</span><span class="p">.</span><span class="ss">&quot;post_id&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">232</span><span class="p">,</span> <span class="mi">582</span><span class="p">)</span>
  <span class="k">order</span> <span class="k">by</span> <span class="ss">&quot;some_model&quot;</span><span class="p">.</span><span class="ss">&quot;user_id&quot;</span> <span class="k">ASC</span><span class="p">,</span> <span class="ss">&quot;some_model&quot;</span><span class="p">.</span><span class="ss">&quot;post_id&quot;</span> <span class="k">ASC</span> <span class="k">limit</span> <span class="mi">10</span></code>
</pre>


<h2><a name="relations" href="#relations">Relations</a></h2>

<p>Often your models are connected to other models by use of a <em>foreign_key</em>. You
can describe the relationships between models using the <code>relations</code> class
property.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>
<span class="kd">local</span> <span class="n">Posts</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;posts&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">relations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="n">belongs_to</span> <span class="o">=</span> <span class="s2">&quot;Users&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;posts&quot;</span><span class="p">,</span> <span class="n">has_many</span> <span class="o">=</span> <span class="s2">&quot;Tags&quot;</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>
<span class="k">class</span> <span class="nc">Posts</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@relations</span><span class="o">:</span> <span class="kt">{</span>
    <span class="kt">{</span><span class="s2">&quot;</span><span class="s">user</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">belongs_to:</span> <span class="s2">&quot;</span><span class="s">Users</span><span class="s2">&quot;</span><span class="kt">}</span>
    <span class="kt">{</span><span class="s2">&quot;</span><span class="s">posts</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">has_many:</span> <span class="s2">&quot;</span><span class="s">Tags</span><span class="s2">&quot;</span><span class="kt">}</span>
  <span class="kt">}</span></code>
</pre>


<p>Lapis will automatically add a handful of methods for each relation to the
model class to make fetching the associated row easy.  For example the
<code>belongs_to</code> relation from the example above would make a <code>get_user</code> method:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">post</span> <span class="o">=</span> <span class="n">Posts</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">post</span><span class="p">:</span><span class="n">get_user</span><span class="p">()</span>

<span class="c1">-- calling again returns the cached value</span>
<span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">post</span><span class="p">:</span><span class="n">get_user</span><span class="p">()</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">post</span> <span class="o">=</span> <span class="nc">Posts</span><span class="o">\</span><span class="n">find</span> <span class="mi">1</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">post</span><span class="o">\</span><span class="n">get_user</span><span class="o">!</span>

<span class="c1">-- calling again returns the cached value</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">post</span><span class="o">\</span><span class="n">get_user</span><span class="o">!</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;posts&quot;</span> <span class="k">where</span> <span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;users&quot;</span> <span class="k">where</span> <span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span></code>
</pre>


<p>The following relations are available:</p>

<h3><a name="relations/belongs-to" href="#relations/belongs-to"><code>belongs_to</code></a></h3>

<p>A relation that fetches a single related model. The foreign key column used to
fetch the other model is located on the same table as the model.</p>

<p>The name of the relation is used to derive the name of the column used as the
foreign key in addition to the name of the method added to the model to fetch
the associated row.</p>

<p>A <code>belongs_to</code> relation named <code>user</code> would look for a column named <code>user_id</code> on
the current model. When the relation is fetched, it will be cached in a field
named <code>user</code> in the model.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="kd">local</span> <span class="n">Posts</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;posts&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">relations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">belongs_to</span> <span class="o">=</span> <span class="s2">&quot;Users&quot;</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">Posts</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@relations</span><span class="o">:</span> <span class="kt">{</span>
    <span class="kt">{</span><span class="s2">&quot;</span><span class="s">user</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">belongs_to:</span> <span class="s2">&quot;</span><span class="s">Users</span><span class="s2">&quot;</span><span class="kt">}</span>
  <span class="kt">}</span></code>
</pre>


<p>A <code>get_</code> method is added to the model to fetch the associated row:</p>

<p><pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">post</span><span class="p">:</span><span class="n">get_user</span><span class="p">()</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">user</span> <span class="o">=</span> <span class="n">post</span><span class="o">\</span><span class="n">get_user</span><span class="o">!</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;users&quot;</span> <span class="k">where</span> <span class="ss">&quot;user_id&quot;</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span></code>
</pre>


<p>The relation definition can take an optional <code>key</code> option to override what
field is used on the current model to reference as the foreign key.</p>

<p>If the relation returns <code>nil</code> from the database, then that will be cached on
the model and subsequent calls will return <code>nil</code> without issuing another query.
You can call the <code>refresh</code> method to clear the relation caches.</p>

<p>A variation of the <code>belongs_to</code> relation is
<a href="#relations/polymorphic-belongs-to"><code>polymorphic_belongs_to</code></a>, which lets a
relation point to one of many different models.</p>

<h3><a name="relations/has-one" href="#relations/has-one"><code>has_one</code></a></h3>

<p>A relation that fetches a single related model. Similar to <code>belongs_to</code>, but
the foreign key used to fetch the other model is located on the other table.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">relations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s2">&quot;user_profile&quot;</span><span class="p">,</span> <span class="n">has_one</span> <span class="o">=</span> <span class="s2">&quot;UserProfiles&quot;</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>
<span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@relations</span><span class="o">:</span> <span class="kt">{</span>
    <span class="kt">{</span><span class="s2">&quot;</span><span class="s">user_profile</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">has_one:</span> <span class="s2">&quot;</span><span class="s">UserProfiles</span><span class="s2">&quot;</span><span class="kt">}</span>
  <span class="kt">}</span></code>
</pre>


<p>A <code>get_</code> method is added to the model to fetch the associated row:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">user</span><span class="p">:</span><span class="n">get_user_profile</span><span class="p">()</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">profile</span> <span class="o">=</span> <span class="n">user</span><span class="o">\</span><span class="n">get_user_profile</span><span class="o">!</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;user_profiles&quot;</span> <span class="k">where</span> <span class="ss">&quot;user_id&quot;</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span></code>
</pre>


<p>By default, the relation converts the name of the table to a foreign key column
name by making it singular and appending <code>_id</code>. The table <code>users</code> would convert
to <code>user_id</code>. Sometimes the calculated foreign key isn&rsquo;t correct, you can
provide a custom key with the <code>key</code> parameter to the relation:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">relations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s2">&quot;user_profile&quot;</span><span class="p">,</span> <span class="n">has_one</span> <span class="o">=</span> <span class="s2">&quot;UserProfiles&quot;</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;owner_id&quot;</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@relations</span><span class="o">:</span> <span class="kt">{</span>
    <span class="kt">{</span><span class="s2">&quot;</span><span class="s">user_profile</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">has_one:</span> <span class="s2">&quot;</span><span class="s">UserProfiles</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">key:</span> <span class="s2">&quot;</span><span class="s">owner_id</span><span class="s2">&quot;</span><span class="kt">}</span>
  <span class="kt">}</span></code>
</pre>


<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">user</span><span class="p">:</span><span class="n">get_user_profile</span><span class="p">()</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">profile</span> <span class="o">=</span> <span class="n">user</span><span class="o">\</span><span class="n">get_user_profile</span><span class="o">!</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;user_profiles&quot;</span> <span class="k">where</span> <span class="ss">&quot;owner_id&quot;</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span></code>
</pre>


<p>If the relation returns <code>nil</code> from the database, then that will be cached on
the model and subsequent calls will return <code>nil</code> without issuing another query.
You can call the <code>refresh</code> method to clear the relation caches.</p>

<h3><a name="relations/has-many" href="#relations/has-many"><code>has_many</code></a></h3>

<p>A one to many relation. It defines two methods, one that returns a <a href="#pagination">paginator
object</a>, and one that fetches all of the objects. In the following
example we create a model, Users, where each user can have many Posts
that they own:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">relations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s2">&quot;posts&quot;</span><span class="p">,</span> <span class="n">has_many</span> <span class="o">=</span> <span class="s2">&quot;Posts&quot;</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<p>In the above example, the <code>Users</code> model will expect that the table backed by
the <code>Posts</code> model contains a column <code>user_id</code> that will be used to find the
associated posts for each user.</p>

<p>The following options may be included to customize the relation</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default</td></tr></thead><tbody><tr><td><code>key</code></td><td><p>The foreign key to search on. Either a string for singular foreign key,
an array table to specify composite foreign keys, or a key-value table to
specify cross-table column mapping.</p>

<p>Defaults a singular foreign key by appending <code>_id</code> to the singular form of the table name, eg. <code>Users</code> → <code>user_id</code></p>
</td><td><p><code>#{singular(table_name)}_id</code></p>
</td></tr><tr><td><code>where</code></td><td><p>Set additional constraints on the things returned, as a table</p>
<details class="option_example"><summary>Show Example</summary><pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">relations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s2">&quot;authored_posts&quot;</span><span class="p">,</span>
      <span class="n">has_many</span> <span class="o">=</span> <span class="s2">&quot;Posts&quot;</span><span class="p">,</span>
      <span class="n">where</span> <span class="o">=</span> <span class="p">{</span> <span class="n">deleted</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>
<span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@relations</span><span class="o">:</span> <span class="kt">{</span>
    <span class="kt">{</span><span class="s2">&quot;</span><span class="s">authored_posts</span><span class="s2">&quot;</span>
      <span class="nv">has_many:</span> <span class="s2">&quot;</span><span class="s">Posts</span><span class="s2">&quot;</span>
      <span class="nv">where:</span> <span class="kt">{</span> <span class="nv">deleted:</span> <span class="kc">false</span> <span class="kt">}</span>
    <span class="kt">}</span>
  <span class="kt">}</span></code>
</pre>

</details></td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>order</code></td><td><p>A SQL fragment as a string used to specify a default <code>order by</code> clause when the relation is fetched</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>as</code></td><td><p>Override the name included in the generated methods, and the cached object</p>
</td><td><p><em>relation name</em></p>
</td></tr></tbody></table></p>

<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>
<span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@relations</span><span class="o">:</span> <span class="kt">{</span>
    <span class="kt">{</span><span class="s2">&quot;</span><span class="s">posts</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">has_many:</span> <span class="s2">&quot;</span><span class="s">Posts</span><span class="s2">&quot;</span><span class="kt">}</span>
  <span class="kt">}</span></code>
</pre>


<p>The following methods are added to the model for the <code>posts</code> relation shown above:</p>

<ul>
<li><code>get_posts()</code> (<code>get_X</code>) &mdash; fetch all the objects for that relation</li>
<li><code>get_posts_paginated(opts)</code> (<code>get_X_paginated</code>) &mdash; return a pagination object for iterating through all the posts</li>
</ul>


<p>We can use the <code>get_</code> method to fetch all the associated records. If the
relation has already been fetched then it will return the cached value. The
cached value is stored in a field on the model that matches the name of the
relation.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">posts</span> <span class="o">=</span> <span class="n">user</span><span class="p">:</span><span class="n">get_posts</span><span class="p">()</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">posts</span> <span class="o">=</span> <span class="n">user</span><span class="o">\</span><span class="n">get_posts</span><span class="o">!</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;posts&quot;</span> <span class="k">where</span> <span class="ss">&quot;user_id&quot;</span> <span class="o">=</span> <span class="mi">123</span></code>
</pre>


<p>The <code>get_X_paginated</code> method will return a <a href="#pagination">paginator</a> for
iterating through the related objects. This is useful if you know the relation
could include a large number of things and it does not make sense to fetch them
all at once.</p>

<blockquote><p>It is highly recommended that you either specify and order in the relation,
or use the ordered paginator otherwise the database may return items out of
order when iterating over the pages of results. This could cause you see
duplicate items or skip items entirely.</p></blockquote>

<p>Any arguments passed to the <code>get_X_paginated</code> method are passed to the
paginator&rsquo;s constructor, so you can specify things like <code>fields</code>,
<code>prepare_results</code>, and <code>per_page</code>:</p>

<p><pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">posts</span> <span class="o">=</span> <span class="n">user</span><span class="p">:</span><span class="n">get_posts_paginated</span><span class="p">({</span>
  <span class="n">per_page</span> <span class="o">=</span> <span class="mi">20</span>
<span class="p">}):</span><span class="n">get_page</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">posts</span> <span class="o">=</span> <span class="n">user</span><span class="o">\</span><span class="n">get_posts_paginated</span><span class="kt">(</span><span class="nv">per_page:</span> <span class="mi">20</span><span class="kt">)</span><span class="o">\</span><span class="n">get_page</span> <span class="mi">3</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;posts&quot;</span> <span class="k">where</span> <span class="ss">&quot;user_id&quot;</span> <span class="o">=</span> <span class="mi">123</span> <span class="k">LIMIT</span> <span class="mi">20</span> <span class="k">OFFSET</span> <span class="mi">40</span></code>
</pre>


<p>By default, an <code>OffsetPaginator</code> (paginated with <code>LIMIT</code> and <code>OFFSET</code>) is
created. If you want to use the <a href="#ordered-paginator">OrderedPaginator</a> you can
specify an <code>ordered</code> option to the method with a list:</p>

<p><pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">pager</span> <span class="o">=</span> <span class="n">user</span><span class="p">:</span><span class="n">get_posts_paginated</span><span class="p">({</span>
  <span class="n">per_page</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
  <span class="n">ordered</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span>
  <span class="p">}</span>
<span class="p">})</span>
<span class="kd">local</span> <span class="n">posts</span><span class="p">,</span> <span class="n">next_page</span> <span class="o">=</span> <span class="n">pager</span><span class="p">:</span><span class="n">get_page</span><span class="p">()</span>
<span class="kd">local</span> <span class="n">posts2</span> <span class="o">=</span> <span class="n">pager</span><span class="p">:</span><span class="n">get_page</span><span class="p">(</span><span class="n">next_page</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">pager</span> <span class="o">=</span> <span class="n">user</span><span class="o">\</span><span class="n">get_posts_paginated</span> <span class="nv">per_page:</span> <span class="mi">20</span><span class="p">,</span> <span class="nv">ordered:</span> <span class="kt">{</span><span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span><span class="kt">}</span>

<span class="n">posts</span><span class="p">,</span> <span class="n">next_page</span> <span class="o">=</span> <span class="n">pager</span><span class="o">\</span><span class="n">get_page</span><span class="o">!</span>
<span class="n">posts2</span> <span class="o">=</span> <span class="n">pager</span><span class="o">\</span><span class="n">get_page</span> <span class="n">next_page</span></code>
</pre>

</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;posts&quot;</span> <span class="k">where</span> <span class="ss">&quot;user_id&quot;</span> <span class="o">=</span> <span class="mi">123</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="ss">&quot;posts&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="k">ASC</span> <span class="k">LIMIT</span> <span class="mi">20</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;posts&quot;</span> <span class="k">where</span> <span class="ss">&quot;posts&quot;</span><span class="p">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">23892</span> <span class="k">and</span> <span class="p">(</span><span class="ss">&quot;user_id&quot;</span> <span class="o">=</span> <span class="mi">123</span><span class="p">)</span>
  <span class="k">ORDER</span> <span class="k">BY</span> <span class="ss">&quot;posts&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="k">ASC</span> <span class="k">LIMIT</span> <span class="mi">20</span></code>
</pre>


<p>Here&rsquo;s a more complex example utilizing some of the options for <code>has_many</code>:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">relations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s2">&quot;authored_posts&quot;</span><span class="p">,</span>
      <span class="n">has_many</span> <span class="o">=</span> <span class="s2">&quot;Posts&quot;</span><span class="p">,</span>
      <span class="n">where</span> <span class="o">=</span> <span class="p">{</span><span class="n">deleted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">},</span>
      <span class="n">order</span> <span class="o">=</span> <span class="s2">&quot;id desc&quot;</span><span class="p">,</span>
      <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;poster_id&quot;</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>
<span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@relations</span><span class="o">:</span> <span class="kt">{</span>
    <span class="kt">{</span><span class="s2">&quot;</span><span class="s">authored_posts</span><span class="s2">&quot;</span>
      <span class="nv">has_many:</span> <span class="s2">&quot;</span><span class="s">Posts</span><span class="s2">&quot;</span>
      <span class="nv">where:</span> <span class="kt">{</span><span class="nv">deleted:</span> <span class="kc">false</span><span class="kt">}</span>
      <span class="nv">order:</span> <span class="s2">&quot;</span><span class="s">id desc</span><span class="s2">&quot;</span>
      <span class="nv">key:</span> <span class="s2">&quot;</span><span class="s">poster_id</span><span class="s2">&quot;</span><span class="kt">}</span>
  <span class="kt">}</span></code>
</pre>


<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">posts</span> <span class="o">=</span> <span class="n">user</span><span class="p">:</span><span class="n">get_authored_posts</span><span class="p">()</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">posts</span> <span class="o">=</span> <span class="n">user</span><span class="o">\</span><span class="n">get_authored_posts</span><span class="o">!</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;posts&quot;</span> <span class="k">where</span> <span class="ss">&quot;poster_id&quot;</span> <span class="o">=</span> <span class="mi">123</span> <span class="k">and</span> <span class="n">deleted</span> <span class="o">=</span> <span class="k">FALSE</span> <span class="k">order</span> <span class="k">by</span> <span class="n">id</span> <span class="k">desc</span></code>
</pre>


<h3><a name="relations/fetch" href="#relations/fetch"><code>fetch</code></a></h3>

<p>A manual relation where you provide a function that will fetch the associated
data for an individual row. A preload implementation can also be provided.
Lapis will automatically cache the result of the fetch like it does with the
other relation types.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">relations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s2">&quot;recent_posts&quot;</span><span class="p">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
      <span class="c1">-- fetch some data</span>
    <span class="kr">end</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>
<span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@relations</span><span class="o">:</span> <span class="kt">{</span>
    <span class="kt">{</span><span class="s2">&quot;</span><span class="s">recent_posts</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">fetch:</span> <span class="nf">=&gt;</span>
      <span class="c1">-- fetch some data</span>
    <span class="kt">}</span>
  <span class="kt">}</span></code>
</pre>


<p>The following options control how the <code>fetch</code> relation works:</p>

<p><table class="configuration_table" cellspacing="0" cellpadding="0"><thead><tr><td>Name</td><td>Description</td><td>Default</td></tr></thead><tbody><tr><td><code>fetch</code></td><td><p>Callback function to fetch a result for a single model instance, or the value <code>true</code> to use the <code>preload</code> function to load a single result</p>
</td><td><p><strong><em>required</em></strong></p>
</td></tr><tr><td><code>preload</code></td><td><p>Callback function to load data for many model instances at once. Receives an argument of an array of model instances, and more. This is only required if trying to preload multiple objects at once, or when using fetch set to <code>true</code>. See below</p>
</td><td><em class="default_value"><code>nil</code></em></td></tr><tr><td><code>many</code></td><td><p>Set this to true if your fetch relation returns a collection of models instead of a single model. This will allow the preloader to traverse arrays of objects loaded with fetch</p>
</td><td><p><code>false</code></p>
</td></tr></tbody></table></p>

<p>A preload function can be provided to bulk load data for many objects at once.
It is automatically called when using any of Lapis' preload functions. The
<code>preload</code> function receives four arguments:</p>

<ul>
<li>an array table of model instances that should be preloaded</li>
<li>any options passed to the original call to <code>preload</code></li>
<li>the class of the model</li>
<li>the name of the relation</li>
</ul>


<p>The <code>preload</code> function is responsible for setting the loaded value on each
object. The <code>name</code> argument is the name of the field that should be filled for
each instance.  All of the instances will be marked as having the relation
loaded, regardless of if you set a value or not. This means that future calls
to <code>get_</code> will return the cached value.</p>

<p>To simplify writting getters, <code>fetch</code> can be set to <code>true</code> to autogenerate a
function based on the <code>preload</code> function when getting the associated value from
a single instance of the model.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">relations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s2">&quot;recent_posts&quot;</span><span class="p">,</span>
      <span class="c1">-- we can use true here to have the singular getter automatically</span>
      <span class="c1">-- generated based on the preload function</span>
      <span class="n">fetch</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
      <span class="n">preload</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
        <span class="kr">for</span> <span class="n">object</span> <span class="kr">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span> <span class="kr">do</span>
          <span class="c1">-- provide your own preload code and store the result on the object</span>
          <span class="n">object</span><span class="p">.</span><span class="n">recent_posts</span> <span class="o">=</span> <span class="n">some_preloading_code</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
        <span class="kr">end</span>
      <span class="kr">end</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>
<span class="k">class</span> <span class="nc">Users</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@relations</span><span class="o">:</span> <span class="kt">{</span>
    <span class="kt">{</span><span class="s2">&quot;</span><span class="s">recent_posts</span><span class="s2">&quot;</span>
      <span class="c1">-- we can use true here to have the singular getter automatically</span>
      <span class="c1">-- generated based on the preload function</span>
      <span class="nv">fetch:</span> <span class="kc">true</span>
      <span class="nv">preload:</span> <span class="kt">(</span><span class="n">objs</span><span class="kt">)</span> <span class="nf">-&gt;</span>
        <span class="k">for</span> <span class="n">object</span> <span class="k">in</span> <span class="o">*</span><span class="n">objs</span>
          <span class="c1">-- provide your own preload code and store the result on the object</span>
          <span class="n">object</span><span class="o">.</span><span class="n">recent_posts</span> <span class="o">=</span> <span class="n">some_preloading_code</span> <span class="n">object</span>
    <span class="kt">}</span>
  <span class="kt">}</span></code>
</pre>


<h3><a name="relations/polymorphic-belongs-to" href="#relations/polymorphic-belongs-to"><code>polymorphic_belongs_to</code></a></h3>

<p>A relation that fetches a single related model that can be one of multiple
models. For example, you might have a <code>Purchases</code> model that is associated with
the object that was bought, which could be one of many types: <code>VideoGames</code>,
<code>Books</code>. The related models are fetched up by their primary key.</p>

<p>The type of the related object is stored in an <a href="#enum"><code>enum</code> field</a>
automatically created during relation initialization. The <code>enum</code> is named after
the type of the relation, suffixed with <code>_type</code>. The string values in the
<code>enum</code> are the names of the tables.</p>

<p>The syntax for creating a <code>polymorphic_belongs_to</code> takes the type&rsquo;s id with the
name of the model class it points to. Integers are used to represent types.
Just like <code>enum</code>, it&rsquo;s recommended to explicitly write the integer keys to make
it clear that they can&rsquo;t be reordered without changing the meaning of the
relation.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="kd">local</span> <span class="n">Purchases</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;purchases&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">relations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">polymorphic_belongs_to</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span>
      <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Books&quot;</span><span class="p">,</span>
    <span class="p">}},</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">Posts</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@relations</span><span class="o">:</span> <span class="kt">{</span>
    <span class="kt">{</span><span class="s2">&quot;</span><span class="s">user</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">polymorphic_belongs_to:</span> <span class="kt">{</span>
      <span class="kt">[</span><span class="mi">1</span><span class="kt">]</span><span class="o">:</span> <span class="s2">&quot;</span><span class="s">Users</span><span class="s2">&quot;</span>
      <span class="kt">[</span><span class="mi">2</span><span class="kt">]</span><span class="o">:</span> <span class="s2">&quot;</span><span class="s">Books</span><span class="s2">&quot;</span>
    <span class="kt">}}</span>
  <span class="kt">}</span></code>
</pre>


<p>In the example above, an <code>enum</code> named <code>object_types</code> is created. Note that is
uses the table names, instead of the class names. It is equivalent to:</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">Purchases</span><span class="p">.</span><span class="n">object_types</span> <span class="o">=</span> <span class="n">enum</span> <span class="p">{</span>
  <span class="n">users</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">books</span> <span class="o">=</span> <span class="mi">2</span>
<span class="p">}</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="nc">Purchases</span><span class="o">.</span><span class="n">object_types</span> <span class="o">=</span> <span class="n">enum</span> <span class="kt">{</span>
  <span class="nv">users:</span> <span class="mi">1</span>
  <span class="nv">books:</span> <span class="mi">2</span>
<span class="kt">}</span></code>
</pre>


<p>The following methods are automatically generated on the model class with the
polymorphic relation: (where <code>#{name}</code> is the name of the relation)</p>

<ul>
<li><code>model_for_#{name}_type(type)</code> &mdash; Takes the integer or name from type <code>enum</code> and returns the model class associated to that type. If the class could not be found an error is raised</li>
<li><code>#{name}_type_for_model(model)</code> &mdash; Takes a model and returns the <code>enum</code> type for it (as integer)</li>
<li><code>#{name}_type_for_object(obj)</code> &mdash; Takes an instances of an object and returns the <code>enum</code> type for it (as integer)</li>
</ul>


<p>A <em>getter</em> instance method is added to the model:</p>

<ul>
<li><code>get_#{name}</code> &mdash; Will fetch and return the associated object. This will only perform a query if the relation has not already been fetched or preloaded. <code>nil</code> will be returned if no object could be found, or the foreign key is <code>nil</code></li>
</ul>


<p>Additionally, a preloader is installed into the model that will allow all
associated objects across all the different tables to be loaded efficiently.</p>

<h4><a name="relations/polymorphic-belongs-to/migrating-for-a-new-polymorphic-relation" href="#relations/polymorphic-belongs-to/migrating-for-a-new-polymorphic-relation">Migrating for a New Polymorphic Relation</a></h4>

<p>When adding a <code>polymorphic_belongs_to</code> to one of your tables you need to make
the appropriate columns. You'll need to create a foreign key column along with
the type column. The type column can use the built-in schema type <code>enum</code>.</p>

<p>The column names are named after the relation. For example, if your relation is
called <code>primary_item</code>, columns should be created with the names
<code>primary_item_id</code> and <code>primary_item_type</code>.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">schema</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.schema&quot;</span><span class="p">)</span>

<span class="kr">return</span> <span class="p">{</span>
  <span class="p">[</span><span class="mi">1368686109</span><span class="p">]</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
    <span class="n">schema</span><span class="p">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;purchases&quot;</span><span class="p">,</span> <span class="s2">&quot;primary_item_id&quot;</span><span class="p">,</span> <span class="n">schema</span><span class="p">.</span><span class="n">types</span><span class="p">.</span><span class="n">foreign_key</span><span class="p">)</span>
    <span class="n">schema</span><span class="p">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;purchases&quot;</span><span class="p">,</span> <span class="s2">&quot;primary_item_type&quot;</span><span class="p">,</span> <span class="n">schema</span><span class="p">.</span><span class="n">types</span><span class="p">.</span><span class="n">enum</span><span class="p">)</span>
  <span class="kr">end</span><span class="p">,</span>
<span class="p">}</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">add_column</span><span class="p">,</span> <span class="n">create_index</span><span class="p">,</span> <span class="n">types</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.schema</span><span class="s2">&quot;</span>

<span class="kt">{</span>
  <span class="kt">[</span><span class="mi">1368686109</span><span class="kt">]</span><span class="o">:</span> <span class="nf">=&gt;</span>
    <span class="n">add_column</span> <span class="s2">&quot;</span><span class="s">purchases</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">primary_item_id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">foreign_key</span>
    <span class="n">add_column</span> <span class="s2">&quot;</span><span class="s">purchases</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">primary_item_type</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">enum</span>
<span class="kt">}</span></code>
</pre>


<h2><a name="preloading-relations" href="#preloading-relations">Preloading relations</a></h2>

<p>In addition to the method to fetch the associated rows on a single model
instance, relations also provide a way to preload the rows for many instances
of the model.</p>

<p>A common pitfall when using object relational mapping systems is triggering
many queries inside of a loop when fetching a related object on each iteration.
In order to avoid the <code>n+1</code> query problem you can load all the related models
ahead of time in a single query before iterating over them.</p>

<h3><a name="preloading-relations/preload" href="#preloading-relations/preload"><code>preload(instances, relations...)</code></a></h3>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">preload</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">preload</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">preload</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span></code>
</pre>


<p>The <code>preload</code> function is a general purpose preloading for loading relations on
model instances. The first argument is an array of instances, and all other
arguments are the names of the relations to load.</p>

<p>You can also preload nested relations by using the hash table syntax:</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">preload</span><span class="p">(</span><span class="n">posts</span><span class="p">,</span> <span class="p">{</span><span class="n">user</span> <span class="o">=</span> <span class="s2">&quot;twitter_account&quot;</span><span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">preload</span> <span class="n">posts</span><span class="p">,</span> <span class="nv">user:</span> <span class="s2">&quot;</span><span class="s">twitter_account</span><span class="s2">&quot;</span></code>
</pre>


<p>The hash table syntax can be combined with regular relation names as strings,
letting you preload complex sets of data in a single line. In the examples
above, the <code>user</code> relation is loaded on the posts, then every user has the
<code>twitter_account</code> relation loaded.</p>

<h3><a name="preloading-relations/preload_relation" href="#preloading-relations/preload_relation"><code>Model:preload_relation(instances, name, ...)</code></a></h3>

<blockquote><p>This function should be avoided in favor of the <code>preload</code> function when
possible. If you need to pass parameters to a preload call then you need to
use <code>preload_relation</code></p></blockquote>

<p>The class method <code>preload_relation</code> takes an array table of instances of the
model, and the name of a relation. It fills all the instances with the
associated models with a single query.</p>

<p>Internally this method called the <code>include_in</code> method. Any additional arguments
passed to <code>preload_relation</code> are merged in the options to the call to
<code>include_in</code>.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="kd">local</span> <span class="n">Posts</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;posts&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">relations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">belongs_to</span> <span class="o">=</span> <span class="s2">&quot;Users&quot;</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">Posts</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@relations</span><span class="o">:</span> <span class="kt">{</span>
    <span class="kt">{</span><span class="s2">&quot;</span><span class="s">user</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">belongs_to:</span> <span class="s2">&quot;</span><span class="s">Users</span><span class="s2">&quot;</span><span class="kt">}</span>
  <span class="kt">}</span></code>
</pre>


<p>A <code>get_</code> method is added to the model to fetch the associated row:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">posts</span> <span class="o">=</span> <span class="n">Posts</span><span class="p">:</span><span class="nb">select</span><span class="p">()</span> <span class="c1">-- select all the posts</span>
<span class="c1">-- load the user on all the posts</span>
<span class="n">Posts</span><span class="p">:</span><span class="n">preload_relation</span><span class="p">(</span><span class="n">posts</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">posts</span> <span class="o">=</span> <span class="nc">Posts</span><span class="o">\</span><span class="nb">select</span><span class="o">!</span> <span class="c1">-- select all the posts</span>
<span class="c1">-- load the user for all the posts</span>
<span class="nc">Posts</span><span class="o">\</span><span class="n">preload_relation</span> <span class="n">posts</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">user</span><span class="s2">&quot;</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="ss">&quot;users&quot;</span> <span class="k">where</span> <span class="ss">&quot;id&quot;</span> <span class="k">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">);</span></code>
</pre>


<h3><a name="preloading-relations/preload_relations" href="#preloading-relations/preload_relations"><code>Model:preload_relations(instances, names...)</code></a></h3>

<blockquote><p>This call is deprecated, use the <code>preload</code> function to preload many relations
in a single call</p></blockquote>

<p><code>preload_relations</code> is a helper method for calling <code>preload_relation</code> many
times with different relations. This form does not support passing any options
to the preloaders. You should replace <code>Model</code> with the model that contains the
relation definition.</p>

<pre class="highlight lang_lua"><code><span></span><span class="c1">-- load three separate relations</span>
<span class="n">Posts</span><span class="p">:</span><span class="n">preload_relations</span><span class="p">(</span><span class="n">posts</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="c1">-- load three separate relations</span>
<span class="nc">Posts</span><span class="o">\</span><span class="n">preload_relations</span> <span class="n">posts</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">user</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">tags</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">category</span><span class="s2">&quot;</span></code>
</pre>


<h2><a name="enum" href="#enum">Enum</a></h2>

<p>The <code>enum</code> function lets you create a special table that lets you convert
between integer constants and names. This is useful for creating enumerations in
your database rows by using integers to represent a state.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">Model</span><span class="p">,</span> <span class="n">enum</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">enum</span>

<span class="kd">local</span> <span class="n">Posts</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;posts&quot;</span><span class="p">)</span>
<span class="n">Posts</span><span class="p">.</span><span class="n">statuses</span> <span class="o">=</span> <span class="n">enum</span> <span class="p">{</span>
  <span class="n">pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">public</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
  <span class="n">private</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
  <span class="n">deleted</span> <span class="o">=</span> <span class="mi">4</span>
<span class="p">}</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="nc">Model</span><span class="p">,</span> <span class="n">enum</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">Posts</span> <span class="k">extends</span> <span class="nc">Model</span>
  <span class="vc">@statuses</span><span class="o">:</span> <span class="n">enum</span> <span class="kt">{</span>
    <span class="nv">pending:</span> <span class="mi">1</span>
    <span class="nv">public:</span> <span class="mi">2</span>
    <span class="nv">private:</span> <span class="mi">3</span>
    <span class="nv">deleted:</span> <span class="mi">4</span>
  <span class="kt">}</span></code>
</pre>


<pre class="highlight lang_lua"><code><span></span><span class="nb">assert</span><span class="p">(</span><span class="n">Posts</span><span class="p">.</span><span class="n">statuses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pending&quot;</span><span class="p">)</span>
<span class="nb">assert</span><span class="p">(</span><span class="n">Posts</span><span class="p">.</span><span class="n">statuses</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;private&quot;</span><span class="p">)</span>

<span class="nb">assert</span><span class="p">(</span><span class="n">Posts</span><span class="p">.</span><span class="n">statuses</span><span class="p">.</span><span class="n">public</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
<span class="nb">assert</span><span class="p">(</span><span class="n">Posts</span><span class="p">.</span><span class="n">statuses</span><span class="p">.</span><span class="n">deleted</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>

<span class="nb">assert</span><span class="p">(</span><span class="n">Posts</span><span class="p">.</span><span class="n">statuses</span><span class="p">:</span><span class="n">for_db</span><span class="p">(</span><span class="s2">&quot;private&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
<span class="nb">assert</span><span class="p">(</span><span class="n">Posts</span><span class="p">.</span><span class="n">statuses</span><span class="p">:</span><span class="n">for_db</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>

<span class="nb">assert</span><span class="p">(</span><span class="n">Posts</span><span class="p">.</span><span class="n">statuses</span><span class="p">:</span><span class="n">to_name</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;pending&quot;</span><span class="p">)</span>
<span class="nb">assert</span><span class="p">(</span><span class="n">Posts</span><span class="p">.</span><span class="n">statuses</span><span class="p">:</span><span class="n">to_name</span><span class="p">(</span><span class="s2">&quot;pending&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;pending&quot;</span><span class="p">)</span>

<span class="c1">-- using to_name or for_db with undefined enum value throws error</span>

<span class="n">Posts</span><span class="p">.</span><span class="n">statuses</span><span class="p">:</span><span class="n">to_name</span><span class="p">(</span><span class="mi">232</span><span class="p">)</span> <span class="c1">-- error</span>
<span class="n">Posts</span><span class="p">.</span><span class="n">statuses</span><span class="p">:</span><span class="n">for_db</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span> <span class="c1">-- error</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="nb">assert</span> <span class="nc">Posts</span><span class="o">.</span><span class="n">statuses</span><span class="kt">[</span><span class="mi">1</span><span class="kt">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">pending</span><span class="s2">&quot;</span>
<span class="nb">assert</span> <span class="nc">Posts</span><span class="o">.</span><span class="n">statuses</span><span class="kt">[</span><span class="mi">3</span><span class="kt">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">private</span><span class="s2">&quot;</span>

<span class="nb">assert</span> <span class="nc">Posts</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">public</span> <span class="o">==</span> <span class="mi">2</span>
<span class="nb">assert</span> <span class="nc">Posts</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">deleted</span> <span class="o">==</span> <span class="mi">4</span>

<span class="nb">assert</span> <span class="nc">Posts</span><span class="o">.</span><span class="n">statuses</span><span class="o">\</span><span class="n">for_db</span><span class="kt">(</span><span class="s2">&quot;</span><span class="s">private</span><span class="s2">&quot;</span><span class="kt">)</span> <span class="o">==</span> <span class="mi">3</span>
<span class="nb">assert</span> <span class="nc">Posts</span><span class="o">.</span><span class="n">statuses</span><span class="o">\</span><span class="n">for_db</span><span class="kt">(</span><span class="mi">3</span><span class="kt">)</span> <span class="o">==</span> <span class="mi">3</span>

<span class="nb">assert</span> <span class="nc">Posts</span><span class="o">.</span><span class="n">statuses</span><span class="o">\</span><span class="n">to_name</span><span class="kt">(</span><span class="mi">1</span><span class="kt">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">pending</span><span class="s2">&quot;</span>
<span class="nb">assert</span> <span class="nc">Posts</span><span class="o">.</span><span class="n">statuses</span><span class="o">\</span><span class="n">to_name</span><span class="kt">(</span><span class="s2">&quot;</span><span class="s">pending</span><span class="s2">&quot;</span><span class="kt">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">pending</span><span class="s2">&quot;</span>

<span class="c1">-- using to_name or for_db with undefined enum value throws error</span>

<span class="nc">Posts</span><span class="o">.</span><span class="n">statuses</span><span class="o">\</span><span class="n">to_name</span> <span class="mi">232</span> <span class="c1">-- error</span>
<span class="nc">Posts</span><span class="o">.</span><span class="n">statuses</span><span class="o">\</span><span class="n">for_db</span> <span class="s2">&quot;</span><span class="s">hello</span><span class="s2">&quot;</span> <span class="c1">-- error</span></code>
</pre>


      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Tue Nov  1 01:18:49 2022"></script>
  <script type="text/javascript" src="../reference.js?Tue Nov  1 01:18:49 2022"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
