<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exception Handling - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Fri Nov  5 23:56:21 2021" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.9.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="moonscript">MoonScript</span>
          <span class="lang_toggle" data-lang="lua">Lua</span>
        </div>

        
          <div class="nav_links">
            <h2>Contents</h2>
            <ul><li><a href="#the-kinds-of-errors">The Kinds of Errors</a></li>
<li><a href="#capturing-recoverable-errors">Capturing Recoverable Errors</a></li>
<ul><li><a href="#capturing-recoverable-errors/assert-error"><code>assert_error</code></a></li></ul></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><h1>Exception Handling</h1>

<h2><a name="the-kinds-of-errors" href="#the-kinds-of-errors">The Kinds of Errors</a></h2>

<p>Lapis makes a distinction between two kinds of errors: Recoverable and
non-recoverable errors. Errors thrown by Lua&rsquo;s runtime during execution or
calls to  <code>error</code> are considered non-recoverable. (This also includes the Lua
built-in function <code>assert</code>)</p>

<p>Because non-recoverable errors aren&rsquo;t expected to be captured by the user,
Lapis catches them and prints an exception message to the browser. Any action
that may have been running is aborted and Lapis prints a special view showing
the stack trace along with setting the status to <code>500</code>.</p>

<p>These kinds of errors typically are an indicator of a bug or other serious
issue and should be fixed.</p>

<p>Recoverable errors are a user controlled way of aborting the execution of an
action to run a special error handling function. They are implemented using
coroutines instead of Lua&rsquo;s error system.</p>

<p>Examples include non-valid inputs from users, or missing records from the
database.</p>

<h2><a name="capturing-recoverable-errors" href="#capturing-recoverable-errors">Capturing Recoverable Errors</a></h2>

<p>The <code>capture_errors</code> helper is used wrap an action such that it can capture
errors and run an error handler.</p>

<p>This does not capture runtime errors. You should use <code>pcall</code> if you
want to capture runtime errors as you would normally do in Lua.</p>

<p>Lua doesn&rsquo;t have the concept of exceptions like most other languages. Instead
Lapis creates an exception handling system using coroutines. We must define the
scope in which we will capture errors. We do that using the <code>capture_errors</code>
helper. Then we can throw a raw error using <code>yield_error</code>.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">lapis</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">app_helpers</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.application&quot;</span><span class="p">)</span>

<span class="kd">local</span> <span class="n">capture_errors</span><span class="p">,</span> <span class="n">yield_error</span> <span class="o">=</span> <span class="n">app_helpers</span><span class="p">.</span><span class="n">capture_errors</span><span class="p">,</span> <span class="n">app_helpers</span><span class="p">.</span><span class="n">yield_error</span>

<span class="kd">local</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lapis</span><span class="p">.</span><span class="n">Application</span><span class="p">()</span>

<span class="n">app</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;/do_something&quot;</span><span class="p">,</span> <span class="n">capture_errors</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
  <span class="n">yield_error</span><span class="p">(</span><span class="s2">&quot;something bad happened&quot;</span><span class="p">)</span>
  <span class="kr">return</span> <span class="s2">&quot;Hello!&quot;</span>
<span class="kr">end</span><span class="p">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">capture_errors</span><span class="p">,</span> <span class="n">yield_error</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.application</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">App</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="s2">&quot;</span><span class="s">/do_something</span><span class="s2">&quot;</span><span class="o">:</span> <span class="n">capture_errors</span> <span class="nf">=&gt;</span>
    <span class="n">yield_error</span> <span class="s2">&quot;</span><span class="s">something bad happened</span><span class="s2">&quot;</span>
    <span class="s2">&quot;</span><span class="s">Hello!</span><span class="s2">&quot;</span></code>
</pre>


<p>What happens when there is an error? The action will stop executing at the
first error, and then the error handler is run. The default error handler will
set an array-like table of errors in <span
class="for_moon"><code>@errors</code></span><span class="for_lua"><code>self.errors</code></span> and
return <span class="for_moon"><code>render: true</code></span><span class="for_lua"><code>{
render = true }</code></span>. In your view you can then display the errors. This
means that if you have a named route the view of that route will render. You
should then code your view to sometimes have a <code>errors</code> table.</p>

<p>If you want to have a custom error handler you can invoke <code>capture_errors</code> with
a table: (note that <span class="for_moon"><code>@errors</code></span><span
class="for_lua"><code>self.errors</code></span> is set before the custom handler)</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">app</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;/do_something&quot;</span><span class="p">,</span> <span class="n">capture_errors</span><span class="p">({</span>
  <span class="n">on_error</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
    <span class="n">log_errors</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">errors</span><span class="p">)</span> <span class="c1">-- you would supply the log_errors function</span>
    <span class="kr">return</span> <span class="p">{</span> <span class="n">render</span> <span class="o">=</span> <span class="s2">&quot;my_error_page&quot;</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">500</span> <span class="p">}</span>
  <span class="kr">end</span><span class="p">,</span>
  <span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
    <span class="kr">if</span> <span class="n">self</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">bad_thing</span> <span class="kr">then</span>
      <span class="n">yield_error</span><span class="p">(</span><span class="s2">&quot;something bad happened&quot;</span><span class="p">)</span>
    <span class="kr">end</span>
    <span class="kr">return</span> <span class="p">{</span> <span class="n">render</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">}</span>
  <span class="kr">end</span>
<span class="p">}))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">class</span> <span class="nc">App</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="s2">&quot;</span><span class="s">/do_something</span><span class="s2">&quot;</span><span class="o">:</span> <span class="n">capture_errors</span> <span class="kt">{</span>
    <span class="nv">on_error:</span> <span class="nf">=&gt;</span>
      <span class="n">log_errors</span> <span class="vc">@errors</span> <span class="c1">-- you would supply the log_errors function</span>
      <span class="nv">render:</span> <span class="s2">&quot;</span><span class="s">my_error_page</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">status:</span> <span class="mi">500</span>

    <span class="nf">=&gt;</span>
      <span class="k">if</span> <span class="vc">@params</span><span class="o">.</span><span class="n">bad_thing</span>
        <span class="n">yield_error</span> <span class="s2">&quot;</span><span class="s">something bad happened</span><span class="s2">&quot;</span>
      <span class="nv">render:</span> <span class="kc">true</span>
  <span class="kt">}</span></code>
</pre>


<p><code>capture_errors</code> when called with a table will use the first positional value
as the action.</p>

<p>If you're building a JSON API then another method is provided,
<code>capture_errors_json</code>, which renders the errors in a JSON object like so:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">lapis</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">app_helpers</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.application&quot;</span><span class="p">)</span>

<span class="kd">local</span> <span class="n">capture_errors_json</span><span class="p">,</span> <span class="n">yield_error</span> <span class="o">=</span> <span class="n">app_helpers</span><span class="p">.</span><span class="n">capture_errors_json</span><span class="p">,</span> <span class="n">app_helpers</span><span class="p">.</span><span class="n">yield_error</span>

<span class="kd">local</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lapis</span><span class="p">.</span><span class="n">Application</span><span class="p">()</span>

<span class="n">app</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">capture_errors_json</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
  <span class="n">yield_error</span><span class="p">(</span><span class="s2">&quot;something bad happened&quot;</span><span class="p">)</span>
<span class="kr">end</span><span class="p">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">capture_errors_json</span><span class="p">,</span> <span class="n">yield_error</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.application</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">App</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="s2">&quot;</span><span class="s">/</span><span class="s2">&quot;</span><span class="o">:</span> <span class="n">capture_errors_json</span> <span class="nf">=&gt;</span>
    <span class="n">yield_error</span> <span class="s2">&quot;</span><span class="s">something bad happened</span><span class="s2">&quot;</span></code>
</pre>


<p>Would render (with the correct content type):</p>

<pre class="highlight lang_json"><code><span></span><span class="p">{</span> <span class="err">errors:</span> <span class="err">[</span><span class="nt">&quot;something bad happened&quot;</span><span class="err">]</span> <span class="p">}</span></code>
</pre>


<h3><a name="capturing-recoverable-errors/assert-error" href="#capturing-recoverable-errors/assert-error"><code>assert_error</code></a></h3>

<p>It is idiomatic in Lua to return <code>nil</code> and an error message from a function
when it fails. For this reason the helper <code>assert_error</code> exists. If the first
argument is falsey (<code>nil</code> or <code>false</code>) then the second argument is thrown as an
error, otherwise all the arguments are returned from the function unchanged.</p>

<p><code>assert_error</code> is very handy with database methods, which make use of this
idiom.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">lapis</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">app_helpers</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.application&quot;</span><span class="p">)</span>

<span class="kd">local</span> <span class="n">capture_errors</span><span class="p">,</span> <span class="n">assert_error</span> <span class="o">=</span> <span class="n">app_helpers</span><span class="p">.</span><span class="n">capture_errors</span><span class="p">,</span> <span class="n">app_helpers</span><span class="p">.</span><span class="n">assert_error</span>

<span class="kd">local</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lapis</span><span class="p">.</span><span class="n">Application</span><span class="p">()</span>

<span class="n">app</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">capture_errors</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">assert_error</span><span class="p">(</span><span class="n">Users</span><span class="p">:</span><span class="n">find</span><span class="p">({</span><span class="n">id</span> <span class="o">=</span> <span class="s2">&quot;leafo&quot;</span><span class="p">}))</span>
  <span class="kr">return</span> <span class="s2">&quot;result: &quot;</span> <span class="o">..</span> <span class="n">user</span><span class="p">.</span><span class="n">id</span>
<span class="kr">end</span><span class="p">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">capture_errors</span><span class="p">,</span> <span class="n">assert_error</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.application</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">App</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="s2">&quot;</span><span class="s">/</span><span class="s2">&quot;</span><span class="o">:</span> <span class="n">capture_errors</span> <span class="nf">=&gt;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">assert_error</span> <span class="nc">Users</span><span class="o">\</span><span class="n">find</span> <span class="nv">id:</span> <span class="s2">&quot;</span><span class="s">leafo</span><span class="s2">&quot;</span>
    <span class="s2">&quot;</span><span class="s">result: #{user.id}</span><span class="s2">&quot;</span></code>
</pre>


      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Fri Nov  5 23:56:21 2021"></script>
  <script type="text/javascript" src="../reference.js?Fri Nov  5 23:56:21 2021"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
