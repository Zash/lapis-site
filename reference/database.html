<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Database Access - Lapis Reference Manual</title>
  <link rel="stylesheet" href="../reference.css?Fri Nov  5 23:34:12 2021" />
  <script type="text/javascript">
  if (window.location.hostname != "localhost") {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-136625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
  <div class="header">
    <button class="toggle_nav_btn" id="menu_toggle">Menu</button>
    <h1>
      <a href="..">Lapis</a>
    </h1>
    <div id="search_drop" data-root=".." data-index="../reference.json"></div>
    <a href="../changelog.html" class="version_flag">
      v1.9.0
    </a>
  </div>

  <div class="columns">
    <div class="nav_column">
      <div class="scrolling_inner">
        <div class="lang_picker">
          <span class="lang_toggle active" data-lang="moonscript">MoonScript</span>
          <span class="lang_toggle" data-lang="lua">Lua</span>
        </div>

        
          <div class="nav_links">
            <h2>Contents</h2>
            <ul><li><a href="#establishing-a-connection">Establishing A Connection</a></li>
<ul><li><a href="#establishing-a-connection/postgresql">PostgreSQL</a></li>
<li><a href="#establishing-a-connection/mysql">MySQL</a></li></ul>
<li><a href="#making-a-query">Making a Query</a></li>
<li><a href="#query-interface">Query Interface</a></li>
<ul><li><a href="#query-interface/query"><code>query(query, params...)</code></a></li>
<li><a href="#query-interface/select"><code>select(query, params...)</code></a></li>
<li><a href="#query-interface/insert"><code>insert(table, values, returning...)</code></a></li>
<li><a href="#query-interface/update"><code>update(table, values, conditions, params...)</code></a></li>
<li><a href="#query-interface/delete"><code>delete(table, conditions, params...)</code></a></li>
<li><a href="#query-interface/raw"><code>raw(str)</code></a></li>
<li><a href="#query-interface/list"><code>list({values...})</code></a></li>
<li><a href="#query-interface/array"><code>array({values...})</code></a></li>
<li><a href="#query-interface/escape_literal"><code>escape_literal(value)</code></a></li>
<li><a href="#query-interface/escape_identifier"><code>escape_identifier(str)</code></a></li>
<ul><li><a href="#query-interface/escape_identifier/interpolate_query"><code>interpolate_query(query, ...)</code></a></li></ul>
<li><a href="#query-interface/constants">Constants</a></li></ul>
<li><a href="#database-schemas">Database Schemas</a></li>
<ul><li><a href="#database-schemas/creating-and-dropping-tables">Creating and Dropping Tables</a></li>
<ul><li><a href="#database-schemas/creating-and-dropping-tables/create_table"><code>create_table(table_name, { table_declarations... })</code></a></li>
<li><a href="#database-schemas/creating-and-dropping-tables/drop_table"><code>drop_table(table_name)</code></a></li></ul>
<li><a href="#database-schemas/indexes">Indexes</a></li>
<ul><li><a href="#database-schemas/indexes/create_index"><code>create_index(table_name, col1, col2..., [options])</code></a></li>
<li><a href="#database-schemas/indexes/drop_index"><code>drop_index(table_name, col1, col2...)</code></a></li></ul>
<li><a href="#database-schemas/altering-tables">Altering Tables</a></li>
<ul><li><a href="#database-schemas/altering-tables/add_column"><code>add_column(table_name, column_name, column_type)</code></a></li>
<li><a href="#database-schemas/altering-tables/drop_column"><code>drop_column(table_name, column_name)</code></a></li>
<li><a href="#database-schemas/altering-tables/rename_column"><code>rename_column(table_name, old_name, new_name)</code></a></li>
<li><a href="#database-schemas/altering-tables/rename_table"><code>rename_table(old_name, new_name)</code></a></li></ul>
<li><a href="#database-schemas/column-types">Column Types</a></li></ul>
<li><a href="#database-migrations">Database Migrations</a></li>
<ul><li><a href="#database-migrations/running-migrations">Running Migrations</a></li>
<li><a href="#database-migrations/manually-running-migrations">Manually Running Migrations</a></li></ul>
<li><a href="#database-helpers">Database Helpers</a></li>
<ul><li><a href="#database-helpers/format_date"><code>format_date(time)</code></a></li></ul></ul>
          </div>
        

        <div class="nav_links">
          <h2>All Guides</h2>

<ul>
<li><a href="../reference/getting_started.html">Getting Started</a>

<ul>
<li><a href="../reference/moon_getting_started.html">Getting Started With MoonScript</a></li>
<li><a href="../reference/lua_getting_started.html">Getting Started With Lua</a></li>
</ul>
</li>
<li><a href="../reference/actions.html">Requests and Actions</a></li>
<li><a href="../reference/configuration.html">Writing Configurations</a>

<ul>
<li><a href="../reference/lua_creating_configurations.html">Lua configuration syntax</a></li>
<li><a href="../reference/moon_creating_configurations.html">MoonScript configuration syntax</a></li>
</ul>
</li>
<li><a href="../reference/database.html">Database Access, and Queries</a>

<ul>
<li><a href="../reference/models.html">Models</a></li>
</ul>
</li>
<li><a href="../reference/exception_handling.html">Handling Exceptions</a></li>
<li><a href="../reference/input_validation.html">Input Validation</a></li>
<li><a href="../reference/html_generation.html">HTML Generation</a></li>
<li><a href="../reference/etlua_templates.html">etlua Templates</a></li>
<li><a href="../reference/testing.html">Testing</a></li>
<li><a href="../reference/utilities.html">Utility Functions</a></li>
<li><a href="../reference/command_line.html">Command Line Tool</a></li>
<li><a href="../reference/lapis_console.html">Lapis Console</a></li>
</ul>


        </div>

      </div>
    </div>

    <div class="nav_offset">
      <div class="text_column"><h1>Database Access</h1>

<p>Lapis comes with a set of classes and functions for working with either
<a href="http://www.postgresql.org/">PostgreSQL</a> or <a href="https://www.mysql.com/">MySQL</a>. In
the future other databases will be directly supported. In the meantime, you're
free to use other OpenResty database drivers, you just won&rsquo;t have access to
Lapis' query API.</p>

<p>Every query is performed asynchronously through the <a href="http://wiki.nginx.org/HttpLuaModule#ngx.socket.tcp">OpenResty cosocket
API</a>. A request will yield
and resume automatically so there&rsquo;s no need to code with callbacks, queries can
be written sequentially as if they were in a synchronous environment. Additionally
connections to the server are automatically pooled for optimal performance.</p>

<p>Depending on which database you use, a different library is used:</p>

<p><a href="https://github.com/leafo/pgmoon">pgmoon</a> is the driver used to run
PostgreSQL queries. It has the advantage of being able to be used within
OpenResty&rsquo;s cosocket API in addition to on the command line using LuaSocket&rsquo;s
synchronous API.</p>

<p>When in the context of the server,
<a href="https://github.com/openresty/lua-resty-mysql">lua-resty-mysql</a> is the driver
used to run MySQL queries. When on the command line,
<a href="http://keplerproject.github.io/luasql/doc/us/">LuaSQL</a> with MySQL is used.</p>

<h2><a name="establishing-a-connection" href="#establishing-a-connection">Establishing A Connection</a></h2>

<p>You'll need to configure Lapis so it can connect to the database.</p>

<h3><a name="establishing-a-connection/postgresql" href="#establishing-a-connection/postgresql">PostgreSQL</a></h3>

<p>If you're using PostgreSQL create a <code>postgres</code> block in our <span
class="for_moon"><code>config.moon</code></span><span class="for_lua"><code>config.lua</code></span>
file.</p>

<pre class="highlight lang_lua"><code><span></span><span class="c1">-- config.lua</span>
<span class="kd">local</span> <span class="n">config</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.config&quot;</span><span class="p">)</span>
<span class="n">config</span><span class="p">(</span><span class="s2">&quot;development&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">postgres</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
    <span class="n">user</span> <span class="o">=</span> <span class="s2">&quot;pg_user&quot;</span><span class="p">,</span>
    <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;the_password&quot;</span><span class="p">,</span>
    <span class="n">database</span> <span class="o">=</span> <span class="s2">&quot;my_database&quot;</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="c1">-- config.moon</span>
<span class="k">import</span> <span class="n">config</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.config</span><span class="s2">&quot;</span>
<span class="n">config</span> <span class="s2">&quot;</span><span class="s">development</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
  <span class="n">postgres</span> <span class="nf">-&gt;</span>
    <span class="n">host</span> <span class="s2">&quot;</span><span class="s">127.0.0.1</span><span class="s2">&quot;</span>
    <span class="n">user</span> <span class="s2">&quot;</span><span class="s">pg_user</span><span class="s2">&quot;</span>
    <span class="n">password</span> <span class="s2">&quot;</span><span class="s">the_password</span><span class="s2">&quot;</span>
    <span class="n">database</span> <span class="s2">&quot;</span><span class="s">my_database</span><span class="s2">&quot;</span></code>
</pre>


<p><code>host</code> defaults to <code>127.0.0.1</code> and <code>user</code> defaults to <code>postgres</code>, so you can
leave those fields out if they aren&rsquo;t different from the defaults. If a
non-default port is required it can be appended to the <code>host</code> with colon
syntax: <code>my_host:1234</code> (Otherwise <code>5432</code>, the PostgreSQL default, is used).</p>

<h3><a name="establishing-a-connection/mysql" href="#establishing-a-connection/mysql">MySQL</a></h3>

<p>If you're using MySQL the approach is similar, but you will define a <code>mysql</code>
block:</p>

<pre class="highlight lang_lua"><code><span></span><span class="c1">-- config.lua</span>
<span class="kd">local</span> <span class="n">config</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.config&quot;</span><span class="p">)</span>
<span class="n">config</span><span class="p">(</span><span class="s2">&quot;development&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">mysql</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
    <span class="n">user</span> <span class="o">=</span> <span class="s2">&quot;mysql_user&quot;</span><span class="p">,</span>
    <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;the_password&quot;</span><span class="p">,</span>
    <span class="n">database</span> <span class="o">=</span> <span class="s2">&quot;my_database&quot;</span>
  <span class="p">}</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="c1">-- config.moon</span>
<span class="k">import</span> <span class="n">config</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.config</span><span class="s2">&quot;</span>
<span class="n">config</span> <span class="s2">&quot;</span><span class="s">development</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
  <span class="n">mysql</span> <span class="nf">-&gt;</span>
    <span class="n">host</span> <span class="s2">&quot;</span><span class="s">127.0.0.1</span><span class="s2">&quot;</span>
    <span class="n">user</span> <span class="s2">&quot;</span><span class="s">mysql_user</span><span class="s2">&quot;</span>
    <span class="n">password</span> <span class="s2">&quot;</span><span class="s">the_password</span><span class="s2">&quot;</span>
    <span class="n">database</span> <span class="s2">&quot;</span><span class="s">my_database</span><span class="s2">&quot;</span></code>
</pre>


<p>You're now ready to start making queries.</p>

<h2><a name="making-a-query" href="#making-a-query">Making a Query</a></h2>

<p>There are two ways to make queries:</p>

<ol>
<li>The raw query interface is a collection of functions to help you write SQL.</li>
<li>The <a href="models.html"><code>Model</code> class</a> is a wrapper around a Lua table that helps you synchronize it with a row in a database table.</li>
</ol>


<p>The <code>Model</code> class is the preferred way to interact with the database. The raw
query interface is for achieving things the <code>Model</code> class is unable to do
easily.</p>

<p>Here&rsquo;s an example of the raw query interface:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">lapis</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">db</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db&quot;</span><span class="p">)</span>

<span class="kd">local</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lapis</span><span class="p">.</span><span class="n">Application</span><span class="p">()</span>

<span class="n">app</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="kr">function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;select * from my_table where id = ?&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
  <span class="kr">return</span> <span class="s2">&quot;ok!&quot;</span>
<span class="kr">end</span><span class="p">)</span>

<span class="kr">return</span> <span class="n">app</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">lapis</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis</span><span class="s2">&quot;</span>
<span class="n">db</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="s2">&quot;</span><span class="s">/</span><span class="s2">&quot;</span><span class="o">:</span> <span class="nf">=&gt;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span> <span class="s2">&quot;</span><span class="s">select * from my_table where id = ?</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">10</span>
    <span class="s2">&quot;</span><span class="s">ok!</span><span class="s2">&quot;</span></code>
</pre>


<p>And the same query represented with the <code>Model</code> class:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">lapis</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">Model</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.model&quot;</span><span class="p">).</span><span class="n">Model</span>

<span class="kd">local</span> <span class="n">app</span> <span class="o">=</span> <span class="n">lapis</span><span class="p">.</span><span class="n">Application</span><span class="p">()</span>

<span class="kd">local</span> <span class="n">MyTable</span> <span class="o">=</span> <span class="n">Model</span><span class="p">:</span><span class="n">extend</span><span class="p">(</span><span class="s2">&quot;my_table&quot;</span><span class="p">)</span>

<span class="n">app</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="kr">function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">row</span> <span class="o">=</span> <span class="n">MyTable</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
  <span class="kr">return</span> <span class="s2">&quot;ok!&quot;</span>
<span class="kr">end</span><span class="p">)</span>

<span class="kr">return</span> <span class="n">app</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">lapis</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis</span><span class="s2">&quot;</span>
<span class="k">import</span> <span class="nc">Model</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.model</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">MyTable</span> <span class="k">extends</span> <span class="nc">Model</span>

<span class="k">class</span> <span class="k">extends</span> <span class="n">lapis</span><span class="o">.</span><span class="n">Application</span>
  <span class="s2">&quot;</span><span class="s">/</span><span class="s2">&quot;</span><span class="o">:</span> <span class="nf">=&gt;</span>
    <span class="n">row</span> <span class="o">=</span> <span class="nc">MyTable</span><span class="o">\</span><span class="n">find</span> <span class="mi">10</span>
    <span class="s2">&quot;</span><span class="s">ok!</span><span class="s2">&quot;</span></code>
</pre>


<p>By default all queries will log to the Nginx notice log. You'll be able to see
each query as it happens.</p>

<h2><a name="query-interface" href="#query-interface">Query Interface</a></h2>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">db</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">db</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db</span><span class="s2">&quot;</span></code>
</pre>


<p>The <code>db</code> module provides the following functions:</p>

<h3><a name="query-interface/query" href="#query-interface/query"><code>query(query, params...)</code></a></h3>

<p>Performs a raw query. Returns the result set if successful, returns <code>nil</code> if
failed.</p>

<p>The first argument is the query to perform. If the query contains any <code>?</code>s then
they are replaced in the order they appear with the remaining arguments. The
remaining arguments are escaped with <code>escape_literal</code> before being
interpolated, making SQL injection impossible.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">res</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM hello&quot;</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;UPDATE things SET color = ?&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;INSERT INTO cats (age, name, alive) VALUES (?, ?, ?)&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;dogman&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span> <span class="s2">&quot;</span><span class="s">SELECT * FROM hello</span><span class="s2">&quot;</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span> <span class="s2">&quot;</span><span class="s">UPDATE things SET color = ?</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">blue</span><span class="s2">&quot;</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span> <span class="s2">&quot;</span><span class="s">INSERT INTO cats (age, name, alive) VALUES (?, ?, ?)</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">dogman</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">true</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">hello</span>
<span class="k">UPDATE</span> <span class="n">things</span> <span class="k">SET</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">cats</span> <span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">alive</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;dogman&#39;</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">)</span></code>
</pre>


<p>A query that fails to execute will raise a Lua error. The error will contain
the message from the database along with the query.</p>

<h3><a name="query-interface/select" href="#query-interface/select"><code>select(query, params...)</code></a></h3>

<p>The same as <code>query</code> except it appends <code>"SELECT"</code> to the front of the query.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;* from hello where active = ?&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">.</span><span class="n">FALSE</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span> <span class="s2">&quot;</span><span class="s">* from hello where active = ?</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">FALSE</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">hello</span> <span class="k">where</span> <span class="n">active</span> <span class="o">=</span> <span class="k">FALSE</span></code>
</pre>


<h3><a name="query-interface/insert" href="#query-interface/insert"><code>insert(table, values, returning...)</code></a></h3>

<p>Inserts a row into <code>table</code>. <code>values</code> is a Lua table of column names and values.</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">db</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s2">&quot;my_table&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">age</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Hello World&quot;</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">db</span><span class="o">.</span><span class="n">insert</span> <span class="s2">&quot;</span><span class="s">my_table</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">age:</span> <span class="mi">10</span>
  <span class="nv">name:</span> <span class="s2">&quot;</span><span class="s">Hello World</span><span class="s2">&quot;</span>
<span class="kt">}</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;my_table&quot;</span> <span class="p">(</span><span class="ss">&quot;age&quot;</span><span class="p">,</span> <span class="ss">&quot;name&quot;</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;Hello World&#39;</span><span class="p">)</span></code>
</pre>


<p>A list of column names to be returned can be given after the value table:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s2">&quot;some_other_table&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Hello World&quot;</span>
<span class="p">},</span> <span class="s2">&quot;id&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">insert</span> <span class="s2">&quot;</span><span class="s">some_other_table</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">name:</span> <span class="s2">&quot;</span><span class="s">Hello World</span><span class="s2">&quot;</span>
<span class="kt">}</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;some_other_table&quot;</span> <span class="p">(</span><span class="ss">&quot;name&quot;</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;Hello World&#39;</span><span class="p">)</span> <span class="n">RETURNING</span> <span class="ss">&quot;id&quot;</span></code>
</pre>


<blockquote><p><code>RETURNING</code> is a PostgreSQL feature, and is not available when using MySQL</p></blockquote>

<h3><a name="query-interface/update" href="#query-interface/update"><code>update(table, values, conditions, params...)</code></a></h3>

<p>Updates <code>table</code> with <code>values</code> on all rows that match <code>conditions</code>.</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">db</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;the_table&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Dogbert 2.0&quot;</span><span class="p">,</span>
  <span class="n">active</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="n">id</span> <span class="o">=</span> <span class="mi">100</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">db</span><span class="o">.</span><span class="n">update</span> <span class="s2">&quot;</span><span class="s">the_table</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">name:</span> <span class="s2">&quot;</span><span class="s">Dogbert 2.0</span><span class="s2">&quot;</span>
  <span class="nv">active:</span> <span class="kc">true</span>
<span class="kt">}</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">id:</span> <span class="mi">100</span>
<span class="kt">}</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">UPDATE</span> <span class="ss">&quot;the_table&quot;</span> <span class="k">SET</span> <span class="ss">&quot;name&quot;</span> <span class="o">=</span> <span class="s1">&#39;Dogbert 2.0&#39;</span><span class="p">,</span> <span class="ss">&quot;active&quot;</span> <span class="o">=</span> <span class="k">TRUE</span> <span class="k">WHERE</span> <span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="mi">100</span></code>
</pre>


<p><code>conditions</code> can also be a string, and <code>params</code> will be interpolated into it:</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">db</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;the_table&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">count</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">raw</span><span class="p">(</span><span class="s2">&quot;count + 1&quot;</span><span class="p">)</span>
<span class="p">},</span> <span class="s2">&quot;count &lt; ?&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">db</span><span class="o">.</span><span class="n">update</span> <span class="s2">&quot;</span><span class="s">the_table</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">count:</span> <span class="n">db</span><span class="o">.</span><span class="n">raw</span><span class="s2">&quot;</span><span class="s">count + 1</span><span class="s2">&quot;</span>
<span class="kt">}</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">count &lt; ?</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">10</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">UPDATE</span> <span class="ss">&quot;the_table&quot;</span> <span class="k">SET</span> <span class="ss">&quot;count&quot;</span> <span class="o">=</span> <span class="k">count</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">WHERE</span> <span class="k">count</span> <span class="o">&lt;</span> <span class="mi">10</span></code>
</pre>


<p>When using the table form for conditions, all the extra arguments are used for
the <code>RETURNING</code> clause:</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">db</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;cats&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">count</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">raw</span><span class="p">(</span><span class="s2">&quot;count + 1&quot;</span><span class="p">)</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="n">id</span> <span class="o">=</span> <span class="mi">1200</span>
<span class="p">},</span> <span class="s2">&quot;count&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">db</span><span class="o">.</span><span class="n">update</span> <span class="s2">&quot;</span><span class="s">cats</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">count:</span> <span class="n">db</span><span class="o">.</span><span class="n">raw</span> <span class="s2">&quot;</span><span class="s">count + 1</span><span class="s2">&quot;</span>
<span class="kt">}</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">id:</span> <span class="mi">1200</span>
<span class="kt">}</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">count</span><span class="s2">&quot;</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">UPDATE</span> <span class="ss">&quot;cats&quot;</span> <span class="k">SET</span> <span class="ss">&quot;count&quot;</span> <span class="o">=</span> <span class="k">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">WHERE</span> <span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="mi">1200</span> <span class="n">RETURNING</span> <span class="k">count</span></code>
</pre>


<blockquote><p><code>RETURNING</code> is a PostgreSQL feature, and is not available when using MySQL</p></blockquote>

<h3><a name="query-interface/delete" href="#query-interface/delete"><code>delete(table, conditions, params...)</code></a></h3>

<p>Deletes rows from <code>table</code> that match <code>conditions</code>.</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">db</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;cats&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Roo&quot;</span> <span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">db</span><span class="o">.</span><span class="n">delete</span> <span class="s2">&quot;</span><span class="s">cats</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">name:</span> <span class="s2">&quot;</span><span class="s">Roo</span><span class="s2">&quot;</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">DELETE</span> <span class="k">FROM</span> <span class="ss">&quot;cats&quot;</span> <span class="k">WHERE</span> <span class="ss">&quot;name&quot;</span> <span class="o">=</span> <span class="s1">&#39;Roo&#39;</span></code>
</pre>


<p><code>conditions</code> can also be a string</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">db</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;cats&quot;</span><span class="p">,</span> <span class="s2">&quot;name = ?&quot;</span><span class="p">,</span> <span class="s2">&quot;Gato&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">db</span><span class="o">.</span><span class="n">delete</span> <span class="s2">&quot;</span><span class="s">cats</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">name = ?</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">Gato</span><span class="s2">&quot;</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">DELETE</span> <span class="k">FROM</span> <span class="ss">&quot;cats&quot;</span> <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Gato&#39;</span></code>
</pre>


<h3><a name="query-interface/raw" href="#query-interface/raw"><code>raw(str)</code></a></h3>

<p>Returns a special value that will be inserted verbatim into the query without being
escaped:</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">db</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;the_table&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">count</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">raw</span><span class="p">(</span><span class="s2">&quot;count + 1&quot;</span><span class="p">)</span>
<span class="p">})</span>

<span class="n">db</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;* from another_table where x = ?&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">.</span><span class="n">raw</span><span class="p">(</span><span class="s2">&quot;now()&quot;</span><span class="p">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">db</span><span class="o">.</span><span class="n">update</span> <span class="s2">&quot;</span><span class="s">the_table</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">count:</span> <span class="n">db</span><span class="o">.</span><span class="n">raw</span><span class="s2">&quot;</span><span class="s">count + 1</span><span class="s2">&quot;</span>
<span class="kt">}</span>

<span class="n">db</span><span class="o">.</span><span class="n">select</span> <span class="s2">&quot;</span><span class="s">* from another_table where x = ?</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">raw</span><span class="s2">&quot;</span><span class="s">now()</span><span class="s2">&quot;</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">UPDATE</span> <span class="ss">&quot;the_table&quot;</span> <span class="k">SET</span> <span class="ss">&quot;count&quot;</span> <span class="o">=</span> <span class="k">count</span> <span class="o">+</span> <span class="mi">1</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">another_table</span> <span class="k">where</span> <span class="n">x</span> <span class="o">=</span> <span class="n">now</span><span class="p">()</span></code>
</pre>


<h3><a name="query-interface/list" href="#query-interface/list"><code>list({values...})</code></a></h3>

<p>Returns a special value that will be inserted into the query using SQL&rsquo;s list
syntax. It takes a single argument of an array table.</p>

<p>The return value of this function can be used in place of any regular value
passed to a SQL query function. Each item in the list will be escaped with
<code>escape_literal</code> before being inserted into the query.</p>

<p>Note we can use it both in interpolation and in the clause to a <code>db.update</code>
call:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">list</span><span class="p">({</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">})</span>
<span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;* from another table where id in ?&quot;</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>

<span class="n">db</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;the_table&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">height</span> <span class="o">=</span> <span class="mi">55</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="n">id</span> <span class="o">=</span> <span class="n">ids</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">ids</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">list</span> <span class="kt">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="kt">}</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span> <span class="s2">&quot;</span><span class="s">* from another table where id in ?</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ids</span>

<span class="n">db</span><span class="o">.</span><span class="n">update</span> <span class="s2">&quot;</span><span class="s">the_table</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">height:</span> <span class="mi">55</span>
<span class="kt">}</span><span class="p">,</span> <span class="kt">{</span> <span class="nv">:ids</span> <span class="kt">}</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">another</span> <span class="k">table</span> <span class="k">where</span> <span class="n">id</span> <span class="k">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="k">UPDATE</span> <span class="ss">&quot;the_table&quot;</span> <span class="k">SET</span> <span class="ss">&quot;height&quot;</span> <span class="o">=</span> <span class="mi">55</span> <span class="k">WHERE</span> <span class="ss">&quot;ids&quot;</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span></code>
</pre>


<h3><a name="query-interface/array" href="#query-interface/array"><code>array({values...})</code></a></h3>

<p>Converts the argument passed to an array type that will be inserted/updated
using PostgreSQL&rsquo;s array syntax. This function does not exist for MySQL.</p>

<p>The return value of this function can be used in place of any regular value
passed to a SQL query function. Each item in the list will be escaped with
<code>escape_literal</code> before being inserted into the query.</p>

<p>The argument is converted, not copied. If you need to avoid modifying the
argument then create a copy before passing it to this function.</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">db</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s2">&quot;some_table&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">tags</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">array</span><span class="p">({</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="s2">&quot;world&quot;</span><span class="p">})</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">db</span><span class="o">.</span><span class="n">insert</span> <span class="s2">&quot;</span><span class="s">some_table</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">tags:</span> <span class="n">db</span><span class="o">.</span><span class="n">array</span> <span class="kt">{</span><span class="s2">&quot;</span><span class="s">hello</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">world</span><span class="s2">&quot;</span><span class="kt">}</span>
<span class="kt">}</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;some_table&quot;</span> <span class="p">(</span><span class="ss">&quot;tags&quot;</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="nb">ARRAY</span><span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span><span class="s1">&#39;world&#39;</span><span class="p">])</span></code>
</pre>


<h3><a name="query-interface/escape_literal" href="#query-interface/escape_literal"><code>escape_literal(value)</code></a></h3>

<p>Escapes a value for use in a query. A value is any type that can be stored in a
column. Numbers, strings, and booleans will be escaped accordingly.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">escape_literal</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;select * from hello where id = &quot;</span> <span class="o">..</span> <span class="n">escaped</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">escaped</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">escape_literal</span> <span class="n">value</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span> <span class="s2">&quot;</span><span class="s">select * from hello where id = #{escaped}</span><span class="s2">&quot;</span></code>
</pre>


<p><code>escape_literal</code> is not appropriate for escaping column or table names. See
<code>escape_identifier</code>.</p>

<h3><a name="query-interface/escape_identifier" href="#query-interface/escape_identifier"><code>escape_identifier(str)</code></a></h3>

<p>Escapes a string for use in a query as an identifier. An identifier is a column
or table name.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">table_name</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">escape_identifier</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;select * from &quot;</span> <span class="o">..</span> <span class="n">table_name</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">table_name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">escape_identifier</span> <span class="s2">&quot;</span><span class="s">table</span><span class="s2">&quot;</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span> <span class="s2">&quot;</span><span class="s">select * from #{table_name}</span><span class="s2">&quot;</span></code>
</pre>


<p><code>escape_identifier</code> is not appropriate for escaping values. See
<code>escape_literal</code> for escaping values.</p>

<h4><a name="query-interface/escape_identifier/interpolate_query" href="#query-interface/escape_identifier/interpolate_query"><code>interpolate_query(query, ...)</code></a></h4>

<p>Interpolates a query containing <code>?</code> markers with the rest of the
arguments escaped via <code>escape_literal</code>.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;select * from table&quot;</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">..</span> <span class="n">db</span><span class="p">.</span><span class="n">interpolate_query</span><span class="p">(</span><span class="s2">&quot;where value = ?&quot;</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">select * from table</span><span class="s2">&quot;</span>
<span class="n">q</span> <span class="o">..=</span> <span class="n">db</span><span class="o">.</span><span class="n">interpolate_query</span> <span class="s2">&quot;</span><span class="s">where value = ?</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">42</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span> <span class="n">q</span></code>
</pre>


<h3><a name="query-interface/constants" href="#query-interface/constants">Constants</a></h3>

<p>The following constants are also available:</p>

<ul>
<li><code>NULL</code> &mdash; represents <code>NULL</code> in SQL</li>
<li><code>TRUE</code> &mdash; represents <code>TRUE</code> in SQL</li>
<li><code>FALSE</code> &mdash; represents <code>FALSE</code> in SQL</li>
</ul>


<pre class="highlight lang_lua"><code><span></span><span class="n">db</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;the_table&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">NULL</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">db</span><span class="o">.</span><span class="n">update</span> <span class="s2">&quot;</span><span class="s">the_table</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="nv">name:</span> <span class="n">db</span><span class="o">.</span><span class="n">NULL</span>
<span class="kt">}</span></code>
</pre>


<h2><a name="database-schemas" href="#database-schemas">Database Schemas</a></h2>

<p>Lapis comes with a collection of tools for creating your database schema inside
of the <code>lapis.db.schema</code> module.</p>

<h3><a name="database-schemas/creating-and-dropping-tables" href="#database-schemas/creating-and-dropping-tables">Creating and Dropping Tables</a></h3>

<h4><a name="database-schemas/creating-and-dropping-tables/create_table" href="#database-schemas/creating-and-dropping-tables/create_table"><code>create_table(table_name, { table_declarations... })</code></a></h4>

<p>The first argument to <code>create_table</code> is the name of the table and the second
argument is an array table that describes the table.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">schema</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.schema&quot;</span><span class="p">)</span>

<span class="kd">local</span> <span class="n">types</span> <span class="o">=</span> <span class="n">schema</span><span class="p">.</span><span class="n">types</span>

<span class="n">schema</span><span class="p">.</span><span class="n">create_table</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">types</span><span class="p">.</span><span class="n">serial</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="n">types</span><span class="p">.</span><span class="n">varchar</span><span class="p">},</span>

  <span class="s2">&quot;PRIMARY KEY (id)&quot;</span>
<span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">schema</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.schema</span><span class="s2">&quot;</span>

<span class="k">import</span> <span class="n">create_table</span><span class="p">,</span> <span class="n">types</span> <span class="k">from</span> <span class="n">schema</span>

<span class="n">create_table</span> <span class="s2">&quot;</span><span class="s">users</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
  <span class="kt">{</span><span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">serial</span><span class="kt">}</span>
  <span class="kt">{</span><span class="s2">&quot;</span><span class="s">username</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">varchar</span><span class="kt">}</span>

  <span class="s2">&quot;</span><span class="s">PRIMARY KEY (id)</span><span class="s2">&quot;</span>
<span class="kt">}</span></code>
</pre>


<blockquote><p>In MySQL you should use <code>types.id</code> to get an autoincrementing primary key ID.
Additionally you should not specify <code>PRIMARY KEY (id)</code> either.</p></blockquote>

<p>This will generate the following SQL:</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="ss">&quot;users&quot;</span> <span class="p">(</span>
  <span class="ss">&quot;id&quot;</span> <span class="nb">serial</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="ss">&quot;username&quot;</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span></code>
</pre>


<p>The items in the second argument to <code>create_table</code> can either be a table, or a
string. When the value is a table it is treated as a column/type tuple:</p>

<pre><code>{ column_name, column_type }
</code></pre>

<p>They are both plain strings. The column name will be escaped automatically.
The column type will be inserted verbatim after it is passed through
<code>tostring</code>. <code>schema.types</code> has a collection of common types that can be used.
For example, <code>schema.types.varchar</code> evaluates to <code>character varying(255) NOT
NULL</code>. See more about types below.</p>

<p>If the value to the second argument is a string then it is inserted directly
into the <code>CREATE TABLE</code> statement, that&rsquo;s how we create the primary key above.</p>

<h4><a name="database-schemas/creating-and-dropping-tables/drop_table" href="#database-schemas/creating-and-dropping-tables/drop_table"><code>drop_table(table_name)</code></a></h4>

<p>Drops a table.</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">schema</span><span class="p">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">drop_table</span> <span class="k">from</span> <span class="n">schema</span>

<span class="n">drop_table</span> <span class="s2">&quot;</span><span class="s">users</span><span class="s2">&quot;</span></code>
</pre>


<pre class="highlight lang_sql"><code><span></span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="ss">&quot;users&quot;</span><span class="p">;</span></code>
</pre>


<h3><a name="database-schemas/indexes" href="#database-schemas/indexes">Indexes</a></h3>

<h4><a name="database-schemas/indexes/create_index" href="#database-schemas/indexes/create_index"><code>create_index(table_name, col1, col2..., [options])</code></a></h4>

<p><code>create_index</code> is used to add new indexes to a table. The first argument is a
table, the rest of the arguments are the ordered columns that make up the
index. Optionally the last argument can be a Lua table of options.</p>

<p>There are two options <code>unique: BOOL</code>, <code>where: clause_string</code>.</p>

<p><code>create_index</code> will also check if the index exists before attempting to create
it. If the index exists then nothing will happen.</p>

<p>Here are some example indexes:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">create_index</span> <span class="o">=</span> <span class="n">schema</span><span class="p">.</span><span class="n">create_index</span>

<span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">)</span>
<span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">})</span>

<span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;posts&quot;</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">)</span>
<span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;uploads&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">where</span> <span class="o">=</span> <span class="s2">&quot;not deleted&quot;</span> <span class="p">})</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">create_index</span> <span class="k">from</span> <span class="n">schema</span>

<span class="n">create_index</span> <span class="s2">&quot;</span><span class="s">users</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">created_at</span><span class="s2">&quot;</span>
<span class="n">create_index</span> <span class="s2">&quot;</span><span class="s">users</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">username</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">unique:</span> <span class="kc">true</span>

<span class="n">create_index</span> <span class="s2">&quot;</span><span class="s">posts</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">category</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">title</span><span class="s2">&quot;</span>
<span class="n">create_index</span> <span class="s2">&quot;</span><span class="s">uploads</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">name</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">where:</span> <span class="s2">&quot;</span><span class="s">not deleted</span><span class="s2">&quot;</span></code>
</pre>


<p>This will generate the following SQL:</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="k">ON</span> <span class="ss">&quot;users&quot;</span> <span class="p">(</span><span class="n">created_at</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">UNIQUE</span> <span class="k">INDEX</span> <span class="k">ON</span> <span class="ss">&quot;users&quot;</span> <span class="p">(</span><span class="n">username</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="k">ON</span> <span class="ss">&quot;posts&quot;</span> <span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">title</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="k">ON</span> <span class="ss">&quot;uploads&quot;</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">WHERE</span> <span class="k">not</span> <span class="n">deleted</span><span class="p">;</span></code>
</pre>


<h4><a name="database-schemas/indexes/drop_index" href="#database-schemas/indexes/drop_index"><code>drop_index(table_name, col1, col2...)</code></a></h4>

<p>Drops an index from a table. It calculates the name of the index from the table
name and columns. This is the same as the default index name generated by
database on creation.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">drop_index</span> <span class="o">=</span> <span class="n">schema</span><span class="p">.</span><span class="n">drop_index</span>

<span class="n">drop_index</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">)</span>
<span class="n">drop_index</span><span class="p">(</span><span class="s2">&quot;posts&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;published&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">drop_index</span> <span class="k">from</span> <span class="n">schema</span>

<span class="n">drop_index</span> <span class="s2">&quot;</span><span class="s">users</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">created_at</span><span class="s2">&quot;</span>
<span class="n">drop_index</span> <span class="s2">&quot;</span><span class="s">posts</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">title</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">published</span><span class="s2">&quot;</span></code>
</pre>


<p>This will generate the following SQL:</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">DROP</span> <span class="k">INDEX</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="ss">&quot;users_created_at_idx&quot;</span>
<span class="k">DROP</span> <span class="k">INDEX</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="ss">&quot;posts_title_published_idx&quot;</span></code>
</pre>


<h3><a name="database-schemas/altering-tables" href="#database-schemas/altering-tables">Altering Tables</a></h3>

<h4><a name="database-schemas/altering-tables/add_column" href="#database-schemas/altering-tables/add_column"><code>add_column(table_name, column_name, column_type)</code></a></h4>

<p>Adds a column to a table.</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">schema</span><span class="p">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">types</span><span class="p">.</span><span class="n">integer</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">add_column</span><span class="p">,</span> <span class="n">types</span> <span class="k">from</span> <span class="n">schema</span>

<span class="n">add_column</span> <span class="s2">&quot;</span><span class="s">users</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">age</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">integer</span></code>
</pre>


<p>Generates the SQL:</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="ss">&quot;users&quot;</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="ss">&quot;age&quot;</span> <span class="nb">integer</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="mi">0</span></code>
</pre>


<h4><a name="database-schemas/altering-tables/drop_column" href="#database-schemas/altering-tables/drop_column"><code>drop_column(table_name, column_name)</code></a></h4>

<p>Removes a column from a table.</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">schema</span><span class="p">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">drop_column</span> <span class="k">from</span> <span class="n">schema</span>

<span class="n">drop_column</span> <span class="s2">&quot;</span><span class="s">users</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">age</span><span class="s2">&quot;</span></code>
</pre>


<p>Generates the SQL:</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="ss">&quot;users&quot;</span> <span class="k">DROP</span> <span class="k">COLUMN</span> <span class="ss">&quot;age&quot;</span></code>
</pre>


<h4><a name="database-schemas/altering-tables/rename_column" href="#database-schemas/altering-tables/rename_column"><code>rename_column(table_name, old_name, new_name)</code></a></h4>

<p>Changes the name of a column.</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">schema</span><span class="p">.</span><span class="n">rename_column</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;lifespan&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">rename_column</span> <span class="k">from</span> <span class="n">schema</span>

<span class="n">rename_column</span> <span class="s2">&quot;</span><span class="s">users</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">age</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">lifespan</span><span class="s2">&quot;</span></code>
</pre>


<p>Generates the SQL:</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="ss">&quot;users&quot;</span> <span class="k">RENAME</span> <span class="k">COLUMN</span> <span class="ss">&quot;age&quot;</span> <span class="k">TO</span> <span class="ss">&quot;lifespan&quot;</span></code>
</pre>


<h4><a name="database-schemas/altering-tables/rename_table" href="#database-schemas/altering-tables/rename_table"><code>rename_table(old_name, new_name)</code></a></h4>

<p>Changes the name of a table.</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">schema</span><span class="p">.</span><span class="n">rename_table</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="s2">&quot;members&quot;</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">rename_table</span> <span class="k">from</span> <span class="n">schema</span>

<span class="n">rename_table</span> <span class="s2">&quot;</span><span class="s">users</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">members</span><span class="s2">&quot;</span></code>
</pre>


<p>Generates the SQL:</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="ss">&quot;users&quot;</span> <span class="k">RENAME</span> <span class="k">TO</span> <span class="ss">&quot;members&quot;</span></code>
</pre>


<h3><a name="database-schemas/column-types" href="#database-schemas/column-types">Column Types</a></h3>

<p>All of the column type generators are stored in <code>schema.types</code>. All the types
are special objects that can either be turned into a type declaration string
with <code>tostring</code>, or called like a function to be customized.</p>

<p>Here are all the default values:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">types</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.schema&quot;</span><span class="p">).</span><span class="n">types</span>

<span class="nb">print</span><span class="p">(</span><span class="n">types</span><span class="p">.</span><span class="n">boolean</span><span class="p">)</span>       <span class="c1">--&gt; boolean NOT NULL DEFAULT FALSE</span>
<span class="nb">print</span><span class="p">(</span><span class="n">types</span><span class="p">.</span><span class="n">date</span><span class="p">)</span>          <span class="c1">--&gt; date NOT NULL</span>
<span class="nb">print</span><span class="p">(</span><span class="n">types</span><span class="p">.</span><span class="n">double</span><span class="p">)</span>        <span class="c1">--&gt; double precision NOT NULL DEFAULT 0</span>
<span class="nb">print</span><span class="p">(</span><span class="n">types</span><span class="p">.</span><span class="n">foreign_key</span><span class="p">)</span>   <span class="c1">--&gt; integer NOT NULL</span>
<span class="nb">print</span><span class="p">(</span><span class="n">types</span><span class="p">.</span><span class="n">integer</span><span class="p">)</span>       <span class="c1">--&gt; integer NOT NULL DEFAULT 0</span>
<span class="nb">print</span><span class="p">(</span><span class="n">types</span><span class="p">.</span><span class="n">numeric</span><span class="p">)</span>       <span class="c1">--&gt; numeric NOT NULL DEFAULT 0</span>
<span class="nb">print</span><span class="p">(</span><span class="n">types</span><span class="p">.</span><span class="n">real</span><span class="p">)</span>          <span class="c1">--&gt; real NOT NULL DEFAULT 0</span>
<span class="nb">print</span><span class="p">(</span><span class="n">types</span><span class="p">.</span><span class="n">serial</span><span class="p">)</span>        <span class="c1">--&gt; serial NOT NULL</span>
<span class="nb">print</span><span class="p">(</span><span class="n">types</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>          <span class="c1">--&gt; text NOT NULL</span>
<span class="nb">print</span><span class="p">(</span><span class="n">types</span><span class="p">.</span><span class="n">time</span><span class="p">)</span>          <span class="c1">--&gt; timestamp without time zone NOT NULL</span>
<span class="nb">print</span><span class="p">(</span><span class="n">types</span><span class="p">.</span><span class="n">varchar</span><span class="p">)</span>       <span class="c1">--&gt; character varying(255) NOT NULL</span>
<span class="nb">print</span><span class="p">(</span><span class="n">types</span><span class="p">.</span><span class="n">enum</span><span class="p">)</span>          <span class="c1">--&gt; smallint NOT NULL</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">types</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.schema</span><span class="s2">&quot;</span>

<span class="n">types</span><span class="o">.</span><span class="n">boolean</span>       <span class="c1">--&gt; boolean NOT NULL DEFAULT FALSE</span>
<span class="n">types</span><span class="o">.</span><span class="n">date</span>          <span class="c1">--&gt; date NOT NULL</span>
<span class="n">types</span><span class="o">.</span><span class="n">double</span>        <span class="c1">--&gt; double precision NOT NULL DEFAULT 0</span>
<span class="n">types</span><span class="o">.</span><span class="n">foreign_key</span>   <span class="c1">--&gt; integer NOT NULL</span>
<span class="n">types</span><span class="o">.</span><span class="n">integer</span>       <span class="c1">--&gt; integer NOT NULL DEFAULT 0</span>
<span class="n">types</span><span class="o">.</span><span class="n">numeric</span>       <span class="c1">--&gt; numeric NOT NULL DEFAULT 0</span>
<span class="n">types</span><span class="o">.</span><span class="n">real</span>          <span class="c1">--&gt; real NOT NULL DEFAULT 0</span>
<span class="n">types</span><span class="o">.</span><span class="n">serial</span>        <span class="c1">--&gt; serial NOT NULL</span>
<span class="n">types</span><span class="o">.</span><span class="n">text</span>          <span class="c1">--&gt; text NOT NULL</span>
<span class="n">types</span><span class="o">.</span><span class="n">time</span>          <span class="c1">--&gt; timestamp without time zone NOT NULL</span>
<span class="n">types</span><span class="o">.</span><span class="n">varchar</span>       <span class="c1">--&gt; character varying(255) NOT NULL</span>
<span class="n">types</span><span class="o">.</span><span class="n">enum</span>          <span class="c1">--&gt; smallint NOT NULL</span></code>
</pre>


<p>You'll notice everything is <code>NOT NULL</code> by default, and the numeric types have
defaults of 0 and boolean false.</p>

<p>When a type is called like a function it takes one argument, a table of
options. The options include:</p>

<ul>
<li><code>default: value</code> &mdash; sets default value</li>
<li><code>null: boolean</code> &mdash; determines if the column is <code>NOT NULL</code></li>
<li><code>unique: boolean</code> &mdash; determines if the column has a unique index</li>
<li><code>primary_key: boolean</code> &mdash; determines if the column is the primary key</li>
<li><code>array: bool|number</code> &mdash; makes the type an array (PostgreSQL Only), pass number to set how many dimensions the array is, <code>true</code> == <code>1</code></li>
</ul>


<p>Here are some examples:</p>

<pre class="highlight lang_lua"><code><span></span><span class="n">types</span><span class="p">.</span><span class="n">integer</span><span class="p">({</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">null</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">})</span>  <span class="c1">--&gt; integer DEFAULT 1</span>
<span class="n">types</span><span class="p">.</span><span class="n">integer</span><span class="p">({</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">})</span>        <span class="c1">--&gt; integer NOT NULL DEFAULT 0 PRIMARY KEY</span>
<span class="n">types</span><span class="p">.</span><span class="n">text</span><span class="p">({</span> <span class="n">null</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">})</span>                  <span class="c1">--&gt; text</span>
<span class="n">types</span><span class="p">.</span><span class="n">varchar</span><span class="p">({</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">})</span>        <span class="c1">--&gt; character varying(255) NOT NULL PRIMARY KEY</span>
<span class="n">types</span><span class="p">.</span><span class="n">real</span><span class="p">({</span> <span class="n">array</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">})</span>                 <span class="c1">--&gt; real[]</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">types</span><span class="o">.</span><span class="n">integer</span> <span class="nv">default:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">null:</span> <span class="kc">true</span>  <span class="c1">--&gt; integer DEFAULT 1</span>
<span class="n">types</span><span class="o">.</span><span class="n">integer</span> <span class="nv">primary_key:</span> <span class="kc">true</span>       <span class="c1">--&gt; integer NOT NULL DEFAULT 0 PRIMARY KEY</span>
<span class="n">types</span><span class="o">.</span><span class="n">text</span> <span class="nv">null:</span> <span class="kc">true</span>                 <span class="c1">--&gt; text</span>
<span class="n">types</span><span class="o">.</span><span class="n">varchar</span> <span class="nv">primary_key:</span> <span class="kc">true</span>       <span class="c1">--&gt; character varying(255) NOT NULL PRIMARY KEY</span>
<span class="n">types</span><span class="o">.</span><span class="n">real</span> <span class="nv">array:</span> <span class="kc">true</span>                <span class="c1">--&gt; real[]</span>
<span class="n">types</span><span class="o">.</span><span class="n">text</span> <span class="nv">array:</span> <span class="mi">2</span>                   <span class="c1">--&gt; text[][]</span></code>
</pre>


<blockquote><p>MySQL has a complete different type set than PostgreSQL, see <a href="https://github.com/leafo/lapis/blob/master/lapis/db/mysql/schema.moon#L162">MySQL
types</a></p></blockquote>

<h2><a name="database-migrations" href="#database-migrations">Database Migrations</a></h2>

<p>Because requirements typically change over the lifespan of a web application
it&rsquo;s useful to have a system to make incremental schema changes to the
database.</p>

<p>We define migrations in our code as a table of functions where the key of each
function in the table is the name of the migration. You are free to name the
migrations anything but it&rsquo;s suggested to give them Unix timestamps as names:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">schema</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.schema&quot;</span><span class="p">)</span>

<span class="kr">return</span> <span class="p">{</span>
  <span class="p">[</span><span class="mi">1368686109</span><span class="p">]</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
    <span class="n">schema</span><span class="p">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;my_table&quot;</span><span class="p">,</span> <span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="n">schema</span><span class="p">.</span><span class="n">types</span><span class="p">.</span><span class="n">integer</span><span class="p">)</span>
  <span class="kr">end</span><span class="p">,</span>

  <span class="p">[</span><span class="mi">1368686843</span><span class="p">]</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
    <span class="n">schema</span><span class="p">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;my_table&quot;</span><span class="p">,</span> <span class="s2">&quot;hello&quot;</span><span class="p">)</span>
  <span class="kr">end</span>
<span class="p">}</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">add_column</span><span class="p">,</span> <span class="n">create_index</span><span class="p">,</span> <span class="n">types</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.schema</span><span class="s2">&quot;</span>

<span class="kt">{</span>
  <span class="kt">[</span><span class="mi">1368686109</span><span class="kt">]</span><span class="o">:</span> <span class="nf">=&gt;</span>
    <span class="n">add_column</span> <span class="s2">&quot;</span><span class="s">my_table</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">hello</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">integer</span>

  <span class="kt">[</span><span class="mi">1368686843</span><span class="kt">]</span><span class="o">:</span> <span class="nf">=&gt;</span>
    <span class="n">create_index</span> <span class="s2">&quot;</span><span class="s">my_table</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">hello</span><span class="s2">&quot;</span>
<span class="kt">}</span></code>
</pre>


<p>A migration function is a plain function. Generally they will call the
schema functions described above, but they don&rsquo;t have to.</p>

<p>Only the functions that haven&rsquo;t already been executed will be called when we
tell our migrations to run. The migrations that have already been run are
stored in the migrations table, a database table that holds the names of the
migrations that have already been run. Migrations are run in the order of their
keys sorted ascending.</p>

<h3><a name="database-migrations/running-migrations" href="#database-migrations/running-migrations">Running Migrations</a></h3>

<p>The Lapis command line tool has a special command for running migrations. It&rsquo;s
called <code>lapis migrate</code>.</p>

<p>This command expects a module called <code>migrations</code> that returns a table of
migrations in the format described above.</p>

<p>Let&rsquo;s create this file with a single migration as an example.</p>

<pre class="highlight lang_lua"><code><span></span><span class="c1">-- migrations.lua</span>

<span class="kd">local</span> <span class="n">schema</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.schema&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">types</span> <span class="o">=</span> <span class="n">schema</span><span class="p">.</span><span class="n">types</span>

<span class="kr">return</span> <span class="p">{</span>
  <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
    <span class="n">schema</span><span class="p">.</span><span class="n">create_table</span><span class="p">(</span><span class="s2">&quot;articles&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">types</span><span class="p">.</span><span class="n">serial</span> <span class="p">},</span>
      <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">types</span><span class="p">.</span><span class="n">text</span> <span class="p">},</span>
      <span class="p">{</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">types</span><span class="p">.</span><span class="n">text</span> <span class="p">},</span>

      <span class="s2">&quot;PRIMARY KEY (id)&quot;</span>
    <span class="p">})</span>
  <span class="kr">end</span>
<span class="p">}</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="c1">-- migrations.moon</span>

<span class="k">import</span> <span class="n">create_table</span><span class="p">,</span> <span class="n">types</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.schema</span><span class="s2">&quot;</span>

<span class="kt">{</span>
  <span class="kt">[</span><span class="mi">1</span><span class="kt">]</span><span class="o">:</span> <span class="nf">=&gt;</span>
    <span class="n">create_table</span> <span class="s2">&quot;</span><span class="s">articles</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kt">{</span>
      <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">serial</span> <span class="kt">}</span>
      <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">title</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">text</span> <span class="kt">}</span>
      <span class="kt">{</span> <span class="s2">&quot;</span><span class="s">content</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">text</span> <span class="kt">}</span>

      <span class="s2">&quot;</span><span class="s">PRIMARY KEY (id)</span><span class="s2">&quot;</span>
    <span class="kt">}</span>
<span class="kt">}</span></code>
</pre>


<p>After creating the file, ensure that it is compiled to Lua and run <code>lapis
migrate</code>. The command will first create the migrations table if it doesn&rsquo;t
exist yet then it will run every migration that hasn&rsquo;t been executed yet.</p>

<p>Read more about <a href="command_line.html#command-reference/lapis-migrate">the migrate command</a>.</p>

<h3><a name="database-migrations/manually-running-migrations" href="#database-migrations/manually-running-migrations">Manually Running Migrations</a></h3>

<p>We can manually create the migrations table using the following code:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">migrations</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.migrations&quot;</span><span class="p">)</span>
<span class="n">migrations</span><span class="p">.</span><span class="n">create_migrations_table</span><span class="p">()</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">migrations</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.migrations</span><span class="s2">&quot;</span>
<span class="n">migrations</span><span class="o">.</span><span class="n">create_migrations_table</span><span class="o">!</span></code>
</pre>


<p>It will execute the following SQL:</p>

<pre class="highlight lang_sql"><code><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="ss">&quot;lapis_migrations&quot;</span> <span class="p">(</span>
  <span class="ss">&quot;name&quot;</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="p">);</span></code>
</pre>


<p>Then we can manually run migrations with the following code:</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">migrations</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;lapis.db.migrations&quot;</span><span class="p">)</span>
<span class="n">migrations</span><span class="p">.</span><span class="n">run_migrations</span><span class="p">(</span><span class="nb">require</span><span class="p">(</span><span class="s2">&quot;migrations&quot;</span><span class="p">))</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="k">import</span> <span class="n">run_migrations</span> <span class="k">from</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">lapis.db.migrations</span><span class="s2">&quot;</span>
<span class="n">run_migrations</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">migrations</span><span class="s2">&quot;</span></code>
</pre>


<h2><a name="database-helpers" href="#database-helpers">Database Helpers</a></h2>

<p>These are additional helper functions from the <code>db</code> module that
aren&rsquo;t directly related to the query interface.</p>

<h4><a name="database-helpers/format_date" href="#database-helpers/format_date"><code>format_date(time)</code></a></h4>

<p>Returns a date string formatted properly for insertion in the database.</p>

<p>The <code>time</code> argument is optional, will default to the current UTC time.</p>

<pre class="highlight lang_lua"><code><span></span><span class="kd">local</span> <span class="n">date</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">format_date</span><span class="p">()</span>
<span class="n">db</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;update things set published_at = ?&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span></code>
</pre>


<pre class="highlight lang_moon"><code><span></span><span class="n">date</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">format_date</span><span class="o">!</span>
<span class="n">db</span><span class="o">.</span><span class="n">query</span> <span class="s2">&quot;</span><span class="s">update things set published_at = ?</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">date</span></code>
</pre>


      </div>
    </div>

  </div>

  <script src="../lib/jquery.min.js"></script>
  <script src="../lib/react.production.min.js"></script>
  <script src="../lib/react-dom.production.min.js"></script>
  <script src="../lib/react-dom-factories.js"></script>
  <script src="../lib/lunr.min.js"></script>
  <script type="text/javascript" src="../search.js?Fri Nov  5 23:34:12 2021"></script>
  <script type="text/javascript" src="../reference.js?Fri Nov  5 23:34:12 2021"></script>
  <script type="text/javascript">
    new L.Reference();
  </script>
</body>
</html>
